<html>

<head>
    <title>Exploiting a Postfix ESMTP server</title>
    <link rel="stylesheet" type="text/css" href="index.css">
</head>

<body>
    <article>
        <h1>Exploiting a Postfix ESMTP server</h1>
        <p class="last-update">Last update on October 2019.</p>

        <div class="step">
            <p>
                In the context of a CTF, I found a Postfix ESMTP server running on port 25 of one of the targets.
            </p>
            <div class="code-block">
                <div class="code-line">
                    <span class="prompt">root@kali:/#</span>
                    <code>nmap -A [ip]</code>
                </div>
                <br/>
                <div class="code-line">
                    <code>PORT     STATE    SERVICE     VERSION</code>
                </div>
                <div class="code-line">
                    <code>25/tcp     open    smtp     Postfix smtpd</code>
                </div>
                <div class="code-line">
                    <code>|_smtp-commands: [domain], PIPELINING, SIZE 15728640, ETRN, STARTTLS, ENHANCEDSTATUSCODES, 8BITMIME, DSN, SMTPUTF8,</code>
                </div>
                <div class="code-line">
                    <code>...</code>
                </div>
            </div>
        </div>

        <div class="step">
            <p>Naturally, I connected to the server.</p>
            <div class="code-block">
                <div class="code-line">
                    <span class="prompt">root@kali:/#</span>
                    <code>nc [ip] 25</code>
                </div>
                <div class="code-line">
                    <code>220-[domain] ESMTP Postfix</code>
                </div>
            </div>
        </div>

        <div class="step">
            <p>Just in case I was being <a href="https://en.wikipedia.org/wiki/Banner_grabbing" target="_blank">fooled by the banner</a>, I checked if the server responded to HELO or EHLO.</p>
            <span class="step-note">
                <i>The main identification feature for ESMTP clients is to open a transmission with the command EHLO
                    (Extended HELLO), rather than HELO. An ESMTP server returns the code 250 OK in a multi-line
                    reply with its domain and a list of keywords to indicate supported extensions.</i>
                [<a href="https://en.wikipedia.org/wiki/Extended_SMTP">source</a>]
            </span>
            <div class="code-block">
                <div class="code-line">
                    <code>HELO [hostname]</code>
                </div>
                <div class="code-line">
                    <code>></code>
                </div>
                <div class="code-line">
                    <code>250-[domain]</code>
                </div>
                
                <br/>
                <div class="code-line">
                    <code>EHLO [hostname]</code>
                </div>
                <div class="code-line">
                    <code>></code>
                </div>
                <div class="code-line">
                    <code>250-[domain]</code>
                </div>
                <div class="code-line">
                    <code>250-PIPELINING [<a href="https://tools.ietf.org/html/rfc2920">RFC</a>]</code>
                </div>
                <div class="code-line">
                    <code>250-SIZE 15728640 [<a href="https://tools.ietf.org/html/rfc1870">RFC</a>] </code>
                </div>
                <div class="code-line">
                    <code>250-ETRN [<a href="https://tools.ietf.org/html/rfc1985">RFC</a>]</code>
                </div>
                <div class="code-line">
                    <code>250-STARTTLS [<a href="https://tools.ietf.org/html/rfc3207">RFC</a>]</code>
                </div>
                <div class="code-line">
                    <code>250-ENHANCEDSTATUSCODES [<a href="https://tools.ietf.org/html/rfc2034">RFC</a>]</code>
                </div>
                <div class="code-line">
                    <code>250-8BITMIME [<a href="https://tools.ietf.org/html/rfc6152">RFC</a>]</code>
                </div>
                <div class="code-line">
                    <code>250-DSN [<a hrf="https://tools.ietf.org/html/rfc3461">RFC</a>]</code>
                </div>
                <div class="code-line">
                    <code>250 SMTPUTF8 [<a href="https://tools.ietf.org/html/rfc6531#section-1">RFC</a>]</code>
                </div>
            </div>
        </div>

        <div class="step">
            <p> Since StartTTLS was supported, I established a TLS session usign OpenSSL.</p>
            <div class="code-block">
                <div class="code-line">
                    <span class="prompt">root@kali:/#</span>
                    <code>openssl s_client -connect [host]:25 -starttls smtp</code>
                </div>
            </div>
        </div>

        <div class="step">
            <p>Once I had a TLS connection, I listed the extensions again.</p>
            <span class="step-note">
                Spoiler alert: they were the same as before.
            </span>
            <div class="code-block">
                <div class="code-line">
                    <code>EHLO [hostname]</code>
                </div>
                <div class="code-line">
                    <code>></code>
                </div>
                <div class="code-line">
                    <code>250-[domain]</code>
                </div>
                <div class="code-line">
                    <code>250-PIPELINING</code>
                </div>
                <div class="code-line">
                    <code>250-SIZE 15728640</code>
                </div>
                <div class="code-line">
                    <code>250-ETRN</code>
                </div>
                <div class="code-line">
                    <code>250-ENHANCEDSTATUSCODES</code>
                </div>
                <div class="code-line">
                    <code>250-8BITMIME</code>
                </div>
                <div class="code-line">
                    <code>250-DSN</code>
                </div>
                <div class="code-line">
                    <code>250 SMTPUTF8</code>
                </div>
            </div>
        </div>

        <div class="step">
            <p>However, some of the extensions that were supposed to be supported by the server didn't seem to be recognized.</p>
            <div class="code-block">
                <div class="code-line">
                    <code>PIPELINING</code>
                </div>
                <div class="code-line">
                    <code>502 5.5.2 Error: command not recognized</code>
                </div>
                </br>
                <div class="code-line">
                    <code>ENHANCEDSTATUSCODES</code>
                </div>
                <div class="code-line">
                    <code>502 5.5.2 Error: command not recognized</code>
                </div>
                </br>
                <div class="code-line">
                    <code>DSN</code>
                </div>
                <div class="code-line">
                    <code>502 5.5.2 Error: command not recognized</code>
                </div>
            </div>
        </div>

        <div class="step">
            <p>And AUTH and VRFY seemed to be disabled.</p>
            <div class="code-block">
                <div class="code-line">
                    <code>AUTH</code>
                </div>
                <div class="code-line">
                    <code>503 5.5.1 Error: authentication not enabled</code>
                </div>
                <br />
                <div class="code-line">
                    <code>VRFY root@[domain] <span class="comment">// we know this account exists because of the openSSL response</span></code>
                </div>
                <div class="code-line">
                    <code>502 5.5.1 VRFY command is disabled</code>
                </div>
            </div>
        </div>

        <div class="step">
            <p>Additionally, the server didn't seem to support other (non-listed) ESMTP extensions.</p>    
            <div class="code-block">
                <div class="code-line">
                    <code>TURN</code>
                </div>
                <div class="code-line">
                    <code>502 5.5.2 Error: command not recognized</code>
                </div>
                <br />
                <div class="code-line">
                    <code>SAML</code>
                </div>
                <div class="code-line">
                    <code>502 5.5.2 Error: command not recognized</code>
                </div>
                <br />
                <div class="code-line">
                    <code>SOML</code>
                </div>
                <div class="code-line">
                    <code>502 5.5.2 Error: command not recognized</code>
                </div>
                <br />
                <div class="code-line">
                    <code>SEND</code>
                </div>
                <div class="code-line">
                    <code>502 5.5.2 Error: command not recognized</code>
                </div>
                <br />
                <div class="code-line">
                    <code>HELP</code>
                </div>
                <div class="code-line">
                    <code>502 5.5.2 Error: command not recognized</code>
                </div>
            </div>
        </div>


        <div class="step">
            <p>On a good note, MAIL and RCPT seemed to be working. <br> However, no matter what account I used, the server always disconnected when I tried to send an email.</p>
            <div class="code-block">
                <div class="code-line">
                    <code>MAIL FROM:root@[domain]</code>
                </div>
                <div class="code-line">
                    <code>250 2.1.0 Ok</code>
                </div>
                <br />
                <div class="code-line">
                    <code>RCPT TO:root@[domain]</code>
                </div>
                </br>
                <div class="code-line">
                    <code>RENEGOTIATING</code>
                </div>
                <div class="code-line">
                    <code>verify return:1</code>
                </div>
                <div class="code-line">
                    <code>...</code>
                </div>
            </div>
        </div>

        <div class="step">
            <p>So, I moved on to enumerating email accounts using <a
                    href="https://tools.kali.org/information-gathering/smtp-user-enum">smtp-user-enum</a>.
            </p>
            <span class="step-note">I used <a href="https://github.com/danielmiessler/SecLists" target="_blank">SecLists</a> for the wordlists.</span>
            <div class="code-block">
                <div class="code-line">
                    <span class="prompt">root@kali:/#</span>
                    <code>perl smtp-user-enum.pl -M RCPT -U top-usernames-shortlist.txt -t [ip]:25</code>
                </div>
                <div class="code-line">
                    <span class="prompt">root@kali:/#</span>
                    <code>perl smtp-user-enum.pl -M RCPT -U xato-net-10-million-usernames-dup.txt -t [ip]:25</code>
                </div>
                <div class="code-line">
                    <span class="prompt">root@kali:/#</span>
                    <code>perl smtp-user-enum.pl -M RCPT -U names.txt -t [ip]:25</code>
                </div>
            </div>
        </div>

        <div class="step">
            <p>Then, tried the same but with EXPN instead of RCPT.</p>
            <span class="step-note"><i>EXPN asks the server for the membership of a mailing list. Its parameter may be an encoded address or a list name in a server-defined format</i> [<a href="https://cr.yp.to/smtp/vrfy.html" target="_blank">source</a>].</span>
            <div class="code-block">
                <div class="code-line">
                    <span class="prompt">root@kali:/#</span>
                    <code>perl smtp-user-enum.pl -M EXPN -u root -t [ip]:25</code>
                </div>
                <div class="code-line">
                    <span class="prompt">root@kali:/#</span>
                    <code>perl smtp-user-enum.pl -M EXPN -U xato-net-10-million-usernames-dup.txt -t [ip]:25</code>
                </div>
                <div class="code-line">
                    <span class="prompt">root@kali:/#</span>
                    <code>perl smtp-user-enum.pl -M EXPN -U names.txt -t [ip]:25</code>
                </div>
            </div>
        </div>

        <div class="step">
            <p>To Be Continued</p>
        </div>
    </article>
</body>

</html>