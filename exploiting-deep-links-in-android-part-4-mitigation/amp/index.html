<!DOCTYPE html>
<html ⚡>
<head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width,minimum-scale=1,initial-scale=1">

    <title>Exploiting Deep Links in Android - Part 4 (Mitigation)</title>

    <link rel="canonical" href="../index.html" />
    <meta name="referrer" content="no-referrer-when-downgrade" />
    
    <meta property="og:type" content="article" />
    <meta property="og:title" content="Exploiting Deep Links in Android - Part 4 (Mitigation)" />
    <meta property="og:description" content="Preventing Deep Link HijackingWhen it comes to preventing Deep Link Hijacking, the message is simple: stop using Scheme URLs and start using (properly verified) App Links or Intent URLs. As of August 2021 only about 6% of Android devices were still using Android 5 (Lollipop) or earlier versions of the" />
    <meta property="og:url" content="inesmartins.github.io/exploiting-deep-links-in-android-part-4-mitigation/" />
    <meta property="og:image" content="inesmartins.github.io/content/images/2021/09/maxresdefault-1-1.jpeg" />
    <meta property="article:published_time" content="2021-09-23T20:10:50.000Z" />
    <meta property="article:modified_time" content="2021-09-23T20:28:58.000Z" />
    <meta property="article:tag" content="deep links" />
    <meta property="article:tag" content="android" />
    
    <meta name="twitter:card" content="summary_large_image" />
    <meta name="twitter:title" content="Exploiting Deep Links in Android - Part 4 (Mitigation)" />
    <meta name="twitter:description" content="Preventing Deep Link HijackingWhen it comes to preventing Deep Link Hijacking, the message is simple: stop using Scheme URLs and start using (properly verified) App Links or Intent URLs. As of August 2021 only about 6% of Android devices were still using Android 5 (Lollipop) or earlier versions of the" />
    <meta name="twitter:url" content="inesmartins.github.io/exploiting-deep-links-in-android-part-4-mitigation/" />
    <meta name="twitter:image" content="inesmartins.github.io/content/images/2021/09/maxresdefault-1-1.jpeg" />
    <meta name="twitter:label1" content="Written by" />
    <meta name="twitter:data1" content="Inês Martins" />
    <meta name="twitter:label2" content="Filed under" />
    <meta name="twitter:data2" content="deep links, android" />
    <meta property="og:image:width" content="1000" />
    <meta property="og:image:height" content="563" />
    
    <script type="application/ld+json">
{
    "@context": "https://schema.org",
    "@type": "Article",
    "publisher": {
        "@type": "Organization",
        "name": "",
        "url": "inesmartins.github.io/",
        "logo": {
            "@type": "ImageObject",
            "url": "inesmartins.github.io/favicon.ico",
            "width": 48,
            "height": 48
        }
    },
    "author": {
        "@type": "Person",
        "name": "Inês Martins",
        "image": {
            "@type": "ImageObject",
            "url": "inesmartins.github.io/content/images/2021/08/Screenshot-2021-08-22-at-21.31.59.png",
            "width": 592,
            "height": 572
        },
        "url": "inesmartins.github.io/author/ines/",
        "sameAs": [
            "https://gist.github.com/inesmartins/"
        ]
    },
    "headline": "Exploiting Deep Links in Android - Part 4 (Mitigation)",
    "url": "inesmartins.github.io/exploiting-deep-links-in-android-part-4-mitigation/",
    "datePublished": "2021-09-23T20:10:50.000Z",
    "dateModified": "2021-09-23T20:28:58.000Z",
    "image": {
        "@type": "ImageObject",
        "url": "inesmartins.github.io/content/images/2021/09/maxresdefault-1-1.jpeg",
        "width": 1000,
        "height": 563
    },
    "keywords": "deep links, android",
    "description": "Preventing Deep Link Hijacking\nWhen it comes to preventing Deep Link Hijacking, the message is simple: stop\nusing Scheme URLs and start using (properly verified) App Links or Intent URLs.\n\nAs of August 2021 only about 6% of Android devices\n[https://www.appbrain.com/stats/top-android-sdk-versions] were still using\nAndroid 5 (Lollipop) or earlier versions of the OS, which don’t support App\nLinks. So at this point, there are not a lot of excuses to still use Scheme\nURLs, which are insecure by desig",
    "mainEntityOfPage": {
        "@type": "WebPage",
        "@id": "inesmartins.github.io/"
    }
}
    </script>

    <meta name="generator" content="Ghost 4.7" />
    <link rel="alternate" type="application/rss+xml" title="" href="../../rss/index.html" />

    <style amp-custom>
    *,
    *::before,
    *::after {
        box-sizing: border-box;
    }

    html {
        overflow-x: hidden;
        overflow-y: scroll;
        font-size: 62.5%;
        -webkit-tap-highlight-color: rgba(0, 0, 0, 0);
    }

    body {
        min-height: 100vh;
        margin: 0;
        padding: 0;
        color: #3a4145;
        font-family: -apple-system,BlinkMacSystemFont,Segoe UI,Roboto,Oxygen,Ubuntu,Cantarell,Open Sans,Helvetica Neue,sans-serif;
        font-size: 1.7rem;
        line-height: 1.55em;
        font-weight: 400;
        font-style: normal;
        background: #fff;
        scroll-behavior: smooth;
        overflow-x: hidden;
        -webkit-font-smoothing: antialiased;
        -moz-osx-font-smoothing: grayscale;
    }

    p,
    ul,
    ol,
    li,
    dl,
    dd,
    hr,
    pre,
    form,
    table,
    video,
    figure,
    figcaption,
    blockquote {
        margin: 0;
        padding: 0;
    }

    ul[class],
    ol[class] {
        padding: 0;
        list-style: none;
    }

    img {
        display: block;
        max-width: 100%;
    }

    input,
    button,
    select,
    textarea {
        font: inherit;
        -webkit-appearance: none;
    }

    fieldset {
        margin: 0;
        padding: 0;
        border: 0;
    }

    label {
        display: block;
        font-size: 0.9em;
        font-weight: 700;
    }

    hr {
        position: relative;
        display: block;
        width: 100%;
        height: 1px;
        border: 0;
        border-top: 1px solid currentcolor;
        opacity: 0.1;
    }

    ::selection {
        text-shadow: none;
        background: #cbeafb;
    }

    mark {
        background-color: #fdffb6;
    }

    small {
        font-size: 80%;
    }

    sub,
    sup {
        position: relative;
        font-size: 75%;
        line-height: 0;
        vertical-align: baseline;
    }
    sup {
        top: -0.5em;
    }
    sub {
        bottom: -0.25em;
    }

    ul li + li {
        margin-top: 0.6em;
    }

    a {
        color: var(--ghost-accent-color, #1292EE);
        text-decoration-skip-ink: auto;
    }

    h1,
    h2,
    h3,
    h4,
    h5,
    h6 {
        margin: 0;
        font-weight: 700;
        color: #121212;
        line-height: 1.4em;
    }

    h1 {
        font-size: 3.4rem;
        line-height: 1.1em;
    }

    h2 {
        font-size: 2.4rem;
        line-height: 1.2em;
    }

    h3 {
        font-size: 1.8rem;
    }

    h4 {
        font-size: 1.7rem;
    }

    h5 {
        font-size: 1.6rem;
    }

    h6 {
        font-size: 1.6rem;
    }

    amp-img {
        height: 100%;
        width: 100%;
        max-width: 100%;
        max-height: 100%;
    }

    amp-img img {
        object-fit: cover;
    }

    .page-header {
        padding: 50px 5vmin 30px;
        text-align: center;
        font-size: 2rem;
        text-transform: uppercase;
        letter-spacing: 0.5px;
    }

    .page-header a {
        color: #121212;
        font-weight: 700;
        text-decoration: none;
        font-size: 1.6rem;
        letter-spacing: -0.1px;
    }

    .post {
        max-width: 680px;
        margin: 0 auto;
    }

    .post-header {
        margin: 0 5vmin 5vmin;
        text-align: center;
    }

    .post-meta {
        margin: 1rem 0 0 0;
        text-transform: uppercase;
        color: #738a94;
        font-weight: 500;
        font-size: 1.3rem;
    }

    .post-image {
        margin: 0 0 5vmin;
    }

    .post-image img {
        display: block;
        width: 100%;
        height: auto;
    }

    .post-content {
        padding: 0 5vmin;
    }

    .post-content > * + * {
        margin-top: 1.5em;
    }

    .post-content [id]:not(:first-child) {
        margin: 2em 0 0;
    }

    .post-content > [id] + * {
        margin-top: 1rem;
    }

    .post-content [id] + .kg-card,
    .post-content blockquote + .kg-card {
        margin-top: 40px;
    }

    .post-content > ul,
    .post-content > ol,
    .post-content > dl {
        padding-left: 1.9em;
    }

    .post-content hr {
        margin-top: 40px;
    }

    .post .post-content hr + * {
        margin-top: 40px;
    }

    .post-content amp-img {
        background-color: #f8f8f8;
    }

    .post-content blockquote {
        position: relative;
        font-style: italic;
    }

    .post-content blockquote::before {
        content: "";
        position: absolute;
        left: -1.5em;
        top: 0;
        bottom: 0;
        width: 0.3rem;
        background: var(--ghost-accent-color, #1292EE);
    }

    .post-content :not(.kg-card):not([id]) + .kg-card {
        margin-top: 40px;
    }

    .post-content .kg-card + :not(.kg-card) {
        margin-top: 40px;
    }

    .kg-card figcaption {
        padding: 1.5rem 1.5rem 0;
        text-align: center;
        font-weight: 500;
        font-size: 1.3rem;
        line-height: 1.4em;
        opacity: 0.6;
    }

    .kg-card figcaption strong {
        color: rgba(0,0,0,0.8);
    }

    .post-content :not(pre) code {
        vertical-align: middle;
        padding: 0.15em 0.4em 0.15em;
        border: #e1eaef 1px solid;
        font-weight: 400;
        font-size: 0.9em;
        line-height: 1em;
        color: #15171a;
        background: #f0f6f9;
        border-radius: 0.25em;
    }

    .post-content > pre {
        overflow: scroll;
        padding: 16px 20px;
        color: #fff;
        background: #1F2428;
        border-radius: 5px;
        box-shadow: 0 2px 6px -2px rgba(0,0,0,.1), 0 0 1px rgba(0,0,0,.4);
    }

    .kg-embed-card {
        display: flex;
        flex-direction: column;
        align-items: center;
        width: 100%;
    }

    .kg-image-card img {
        margin: auto;
    }

    .kg-gallery-card + .kg-gallery-card {
        margin-top: 0.75em;
    }

    .kg-gallery-container {
        position: relative;
    }

    .kg-gallery-row {
        display: flex;
        flex-direction: row;
        justify-content: center;
    }

    .kg-gallery-image {
        width: 100%;
        height: 100%;
    }

    .kg-gallery-row:not(:first-of-type) {
        margin: 0.75em 0 0 0;
    }

    .kg-gallery-image:not(:first-of-type) {
        margin: 0 0 0 0.75em;
    }

    .kg-bookmark-card,
    .kg-bookmark-publisher {
        position: relative;
    }

    .kg-bookmark-container,
    .kg-bookmark-container:hover {
        display: flex;
        flex-wrap: wrap;
        flex-direction: row-reverse;
        color: currentColor;
        background: rgba(255,255,255,0.6);
        font-family: -apple-system,BlinkMacSystemFont,Segoe UI,Roboto,Oxygen,Ubuntu,Cantarell,Open Sans,Helvetica Neue,sans-serif;
        text-decoration: none;
        border-radius: 5px;
        box-shadow: 0 2px 6px -2px rgba(0, 0, 0, 0.1), 0 0 1px rgba(0, 0, 0, 0.4);
        overflow: hidden;
    }

    .kg-bookmark-content {
        flex-basis: 0;
        flex-grow: 999;
        padding: 20px;
        order: 1;
    }

    .kg-bookmark-title {
        font-weight: 600;
        font-size: 1.5rem;
        line-height: 1.3em;
    }

    .kg-bookmark-description {
        display: -webkit-box;
        max-height: 45px;
        margin: 0.5em 0 0 0;
        font-size: 1.4rem;
        line-height: 1.55em;
        overflow: hidden;
        opacity: 0.8;
        -webkit-line-clamp: 2;
        -webkit-box-orient: vertical;
    }

    .kg-bookmark-metadata {
        margin-top: 20px;
    }

    .kg-bookmark-metadata {
        display: flex;
        align-items: center;
        font-weight: 500;
        font-size: 1.3rem;
        line-height: 1.3em;
        white-space: nowrap;
        overflow: hidden;
        text-overflow: ellipsis;
    }

    .kg-bookmark-description {
        display: -webkit-box;
        -webkit-box-orient: vertical;
        -webkit-line-clamp: 2;
        overflow: hidden;
    }

    .kg-bookmark-metadata amp-img {
        width: 18px;
        height: 18px;
        max-width: 18px;
        max-height: 18px;
        margin-right: 10px;
    }

    .kg-bookmark-thumbnail {
        display: flex;
        flex-basis: 20rem;
        flex-grow: 1;
        justify-content: flex-end;
    }

    .kg-bookmark-thumbnail amp-img {
        max-height: 200px;
    }

    .kg-bookmark-author {
        white-space: nowrap;
        text-overflow: ellipsis;
        overflow: hidden;
    }

    .kg-bookmark-publisher::before {
        content: "•";
        margin: 0 .5em;
    }

    .kg-width-full.kg-card-hascaption {
        display: grid;
        grid-template-columns: inherit;
    }

    .post-content table {
        border-collapse: collapse;
        width: 100%;
    }

    .post-content th {
        padding: 0.5em 0.8em;
        text-align: left;
        font-size: .75em;
        text-transform: uppercase;
    }

    .post-content td {
        padding: 0.4em 0.7em;
    }

    .post-content tbody tr:nth-child(2n + 1) {
        background-color: rgba(0,0,0,0.1);
        padding: 1px;
    }

    .post-content tbody tr:nth-child(2n + 2) td:last-child {
        box-shadow:
            inset 1px 0 rgba(0,0,0,0.1),
            inset -1px 0 rgba(0,0,0,0.1);
    }

    .post-content tbody tr:nth-child(2n + 2) td {
        box-shadow: inset 1px 0 rgba(0,0,0,0.1);
    }

    .post-content tbody tr:last-child {
        border-bottom: 1px solid rgba(0,0,0,.1);
    }

    .page-footer {
        padding: 60px 5vmin;
        margin: 60px auto 0;
        text-align: center;
        background-color: #f8f8f8;
    }

    .page-footer h3 {
        margin: 0.5rem 0 0 0;
    }

    .page-footer p {
        max-width: 500px;
        margin: 1rem auto 1.5rem;
        font-size: 1.7rem;
        line-height: 1.5em;
        color: rgba(0,0,0,0.6)
    }

    .powered {
        display: inline-flex;
        align-items: center;
        margin: 30px 0 0;
        padding: 6px 9px 6px 6px;
        border: rgba(0,0,0,0.1) 1px solid;
        font-size: 12px;
        line-height: 12px;
        letter-spacing: -0.2px;
        font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", "Roboto", "Oxygen", "Ubuntu", "Cantarell", "Fira Sans", "Droid Sans", "Helvetica Neue", sans-serif;
        font-weight: 500;
        color: #222;
        text-decoration: none;
        background: #fff;
        border-radius: 6px;
    }

    .powered svg {
        height: 16px;
        width: 16px;
        margin: 0 6px 0 0;
    }

    @media (max-width: 600px) {
        body {
            font-size: 1.6rem;
        }
        h1 {
            font-size: 3rem;
        }

        h2 {
            font-size: 2.2rem;
        }
    }

    @media (max-width: 400px) {
        h1 {
            font-size: 2.6rem;
            line-height: 1.15em;
        }
        h2 {
            font-size: 2rem;
            line-height: 1.2em;
        }
        h3 {
            font-size: 1.7rem;
        }
    }

    :root {--ghost-accent-color: #000000;}
    </style>

    <style amp-boilerplate>body{-webkit-animation:-amp-start 8s steps(1,end) 0s 1 normal both;-moz-animation:-amp-start 8s steps(1,end) 0s 1 normal both;-ms-animation:-amp-start 8s steps(1,end) 0s 1 normal both;animation:-amp-start 8s steps(1,end) 0s 1 normal both}@-webkit-keyframes -amp-start{from{visibility:hidden}to{visibility:visible}}@-moz-keyframes -amp-start{from{visibility:hidden}to{visibility:visible}}@-ms-keyframes -amp-start{from{visibility:hidden}to{visibility:visible}}@-o-keyframes -amp-start{from{visibility:hidden}to{visibility:visible}}@keyframes -amp-start{from{visibility:hidden}to{visibility:visible}}</style><noscript><style amp-boilerplate>body{-webkit-animation:none;-moz-animation:none;-ms-animation:none;animation:none}</style></noscript>
    <script async src="https://cdn.ampproject.org/v0.js"></script>

    

</head>

<body class="amp-template">
    <header class="page-header">
        <a href="../../index.html">
                
        </a>
    </header>

    <main class="content" role="main">
        <article class="post">

            <header class="post-header">
                <h1 class="post-title">Exploiting Deep Links in Android - Part 4 (Mitigation)</h1>
                <section class="post-meta">
                    Inês Martins -
                    <time class="post-date" datetime="2021-09-23">23 Sep 2021</time>
                </section>
            </header>
            <figure class="post-image">
                <amp-img src="inesmartins.github.io/content/images/2021/09/maxresdefault-1-1.jpeg" width="600" height="340" layout="responsive"></amp-img>
            </figure>
            <section class="post-content">

                <h2 id="preventing-deep-link-hijacking">Preventing Deep Link Hijacking</h2><p>When it comes to preventing Deep Link Hijacking, the message is simple: stop using Scheme URLs and start using (properly verified) App Links or Intent URLs.</p><p>As of August 2021 <a href="https://www.appbrain.com/stats/top-android-sdk-versions">only about 6% of Android devices</a> were still using Android 5 (Lollipop) or earlier versions of the OS, which don’t support App Links. So at this point, there are not a lot of excuses to still use Scheme URLs, which are insecure by design.</p><p>However, as discussed on <a href="https://inesmartins.github.io/exploiting-deep-links-in-android-part1/index.html">Part 1</a>, App Links can be tricky to verify correctly. Luckily, there are some tools that can help with this task.</p><p>Google provides a <a href="https://support.google.com/google-ads/answer/10710301?hl=en">Deep Link Validator</a> in their Ads platform as well as a <a href="https://developers.google.com/digital-asset-links/tools/generator">Statement List Generator and Tester</a>. This tools enables you to test if a given site domain grants app deep linking to the app with the specified name and <code>SHA256</code> fingerprint:</p><figure class="kg-card kg-image-card kg-width-wide"></figure><p>But I found this tool to be insufficient, and couldn't find any other tool that gave me all of the information I needed about an application's App Links.</p><p>As such, I ended up developing <a href="https://github.com/inesmartins/Android-App-Link-Verification-Tester">a tool</a> that, among other things, can help you check if the App Links registered on the application are correctly verified:</p><pre><code>~ python3 Android-Deep-Link-Analyser/deeplink_analyser.py \
-apk com.twitter.android.apk \
-p com.twitter.android \
-op verify-applinks</code></pre><p>The output looks something like:</p><figure class="kg-card kg-image-card kg-width-wide"></figure><p>This tool has a lot of other features that might interested you. <br />Also, if you have any ideas, corrections or suggestions I would love to receive them on Github!</p><hr></hr><h2 id="validating-untrusted-data">Validating Untrusted Data</h2><p>As a general rule, you should treat all data received via deep link as being potentially malicious. As such, this data should be properly <strong>validated</strong>, <strong>sanitized </strong>and <strong>encoded</strong>.</p><p>If you remember, a lot of the vulnerabilities we explored on the previous posts could have been prevented if the developers checked a given URL against an allowlist.</p><p>However, when parsing and checking URLs we should keep in mind that a lot of <a href="https://hackerone.com/reports/431002">popular URL parsers have known vulnerabilities</a>:</p><figure class="kg-card kg-image-card kg-width-wide"><amp-img src="https://lh5.googleusercontent.com/KTZM2xQgLFfena7OJJakPkLnvyX3lcAdQVdinLeaIxuCVskdMO3g2es-7UT8u6kzU2532AjrJiCFFZtu2aEFl8y7ph7TyprwHTsDgYJJrcO6KN_CborYhhSlOZLTWfVTlwVc5wK7Qyw=s0" class="kg-image" alt width="848" height="345" layout="responsive"></amp-img></figure><p>Note that this issue is now fixed for API level 28 - triggering a deep links with a malformed URL loads the attacker's scripts in Chrome rather than the app’s <code>WebView</code> - but this is still valid for older APIs.</p><hr></hr><h2 id="webview-hardening">WebView Hardening</h2><p>As we saw on the previous posts, <code>WebViews</code> can potentially lead to <strong>local file exfiltration,</strong> they can allow a malicious user to <strong>access data</strong> created by other applications, and they're vulnerable to common web vulnerabilities.</p><p>So, when it comes to <code>WebViews</code> we should first ask ourselves: "could we replace it with a native Android UI component?" </p><p>If the answer is "Yes" we should go with the native approach.</p><p>If the answer is "No" we should enforce the following settings:</p><ul><li><code>setJavaScriptEnabled(false);</code> -&gt; disables JavaScript;</li><li><code>setAllowFileAccess(false);</code> -&gt; disables file system access;</li><li><code>setAllowContentAccess(false);</code> -&gt; blocks WebViews from loading content from a content provider installed in the system;</li><li><code>setAllowFileAccessFromFileURLs(false);</code> -&gt; deprecated in API 30, this setting prevents malicious scripts loaded in a <code>file://</code> context to access arbitrary local files including WebView cookies and app private data.</li><li><code>setAllowUniversalAccessFromFileURLs(false);</code> -&gt; deprecated in API 30, this setting prevents malicious scripts loaded in a <code>file://</code> context to launch cross-site scripting attacks, either accessing arbitrary local files including <code>WebView</code> cookies, app private data or even credentials used on arbitrary web sites.</li></ul><p>Note that these settings are correctly configured by default on all modern Android APIs, but you should verify if the app developer has not explicitly set them as <code>true</code>.</p><p>Finally, if your app directs users to URLs outside your domain, consider using <a href="https://developer.chrome.com/docs/android/custom-tabs/overview/">Chrome Custom Tabs</a> instead of a <code>WebView</code>:</p><blockquote>CCT opens faster than a browser and, if preloaded via its warm-up call, is potentially even faster than a WebView. While it still runs Javascript, it is in its own process, which prevents apps from running malicious code. Furthermore, the CCT UI provides an action bar which shows the URL of the page being loaded, along with an SSL verification lock icon for secure pages.</blockquote><hr></hr><p>Hopefully, you're now better equipped to protect your application.<br />On the next post we'll explore Testing methodologies.</p>

            </section>

        </article>
    </main>
    <footer class="page-footer">
        <h3></h3>
        <p><a href="../../index.html">Read more posts →</a></p>
        <a class="powered" href="https://ghost.org" target="_blank" rel="noopener"><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 156 156"><g fill="none" fill-rule="evenodd"><rect fill="#15212B" width="156" height="156" rx="27"/><g transform="translate(36 36)" fill="#F6F8FA"><path d="M0 71.007A4.004 4.004 0 014 67h26a4 4 0 014 4.007v8.986A4.004 4.004 0 0130 84H4a4 4 0 01-4-4.007v-8.986zM50 71.007A4.004 4.004 0 0154 67h26a4 4 0 014 4.007v8.986A4.004 4.004 0 0180 84H54a4 4 0 01-4-4.007v-8.986z"/><rect y="34" width="84" height="17" rx="4"/><path d="M0 4.007A4.007 4.007 0 014.007 0h41.986A4.003 4.003 0 0150 4.007v8.986A4.007 4.007 0 0145.993 17H4.007A4.003 4.003 0 010 12.993V4.007z"/><rect x="67" width="17" height="17" rx="4"/></g></g></svg> Published with Ghost</a>
    </footer>
    
</body>
</html>
